
<!doctype html>
<html lang="en">
<head>
<link href="https://cdn.realpython.com" rel="preconnect">
<link href="https://files.realpython.com" rel="preconnect">
<title>Your Guide to the CPython Source Code – Real Python</title>
<meta name="author" content="Real Python">
<meta name="description" content="In this detailed Python tutorial, you&#x27;ll explore the CPython source code. By following this step-by-step walkthrough, you&#x27;ll take a deep dive into how the CPython compiler works and how your Python code gets executed.">
<meta name="keywords" content="">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover">
<link rel="stylesheet" href="https://cdn.realpython.com/static/realpython.min.db7d8f8961ed.css">
<link rel="stylesheet" href="https://cdn.realpython.com/static/gfonts/font.5ac42994de49.css">
<link rel="preload" href="https://cdn.realpython.com/static/glightbox.min.f69035b3cab2.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://cdn.realpython.com/static/glightbox.min.f69035b3cab2.css"></noscript>
<link rel="canonical" href="https://realpython.com/cpython-source-code-guide/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg">
<meta property="og:image" content="https://files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg">
<meta name="twitter:creator" content="@realpython">
<meta name="twitter:site" content="@realpython">
<meta property="og:title" content="Your Guide to the CPython Source Code – Real Python">
<meta property="og:type" content="article">
<meta property="og:url" content="https://realpython.com/cpython-source-code-guide/">
<meta property="og:description" content="In this detailed Python tutorial, you&#x27;ll explore the CPython source code. By following this step-by-step walkthrough, you&#x27;ll take a deep dive into how the CPython compiler works and how your Python code gets executed.">
<link href="https://cdn.realpython.com/static/favicon.68cbf4197b0c.png" rel="icon">
<link href="https://realpython.com/atom.xml" rel="alternate" title="Real Python" type="application/atom+xml">
<link rel="manifest" href="/manifest.json">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35184939-1', 'auto', {'allowLinker': true});

  

  

  
  
  ga('set', {
    dimension1: false,
    dimension2: false
  });
  

  ga('send', 'pageview');
  
</script>
<script async src='/cdn-cgi/challenge-platform/h/b/scripts/invisible.js?ts=1653534000'></script></head>
<body>
<nav class="navbar fixed-top navbar-expand-lg navbar-dark flex-column ">
<div class="container flex-row">
<a class="navbar-brand" href="/">
<img src="https://cdn.realpython.com/static/real-python-logo.893c30edea53.svg" width="165" height="40" class="d-inline-block align-top" alt="Real Python">
</a>
<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse navbar-nav-scroll" id="navbarSupportedContent" role="navigation" aria-label="Main Navigation">
<ul class="navbar-nav mr-2">
<li class="nav-item">
<a class="nav-link" href="/start-here/">Start&nbsp;Here</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownLibrary" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
<span class="fa fa-graduation-cap" aria-hidden="true"></span> Learn Python
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownLibrary">
<a class="dropdown-item" href="/search?kind=article&kind=course&order=newest" style="color: #ff7e73; line-height: 110%;"><i class="fa fa-fw mr-1 fa-graduation-cap" aria-hidden="true"></i> Python Tutorials →<br><small class="text-secondary">In-depth articles and video courses</small></a>
<a class="dropdown-item" href="/learning-paths/" style="color: #ffc873; line-height: 110%;"><i class="fa fa-fw mr-1 fa-map-o" aria-hidden="true"></i> Learning Paths →<br><small class="text-secondary">Guided study plans for accelerated learning</small></a>
<a class="dropdown-item" href="/quizzes/" style="color: #abe0e5; line-height: 110%;"><i class="fa fa-fw mr-1 fa-trophy" aria-hidden="true"></i> Quizzes →<br><small class="text-secondary">Check your learning progress</small></a>
<a class="dropdown-item" href="/tutorials/all/" style="color: #ccc; line-height: 110%;"><i class="fa fa-fw mr-1 fa-tags" aria-hidden="true"></i> Browse Topics →<br><small class="text-secondary">Focus on a specific area or skill level</small></a>
<a class="dropdown-item" href="/community/" style="color: #e5c6ab; line-height: 110%;"><i class="fa fa-fw mr-1 fa-slack" aria-hidden="true"></i> Community Chat →<br><small class="text-secondary">Learn with other Pythonistas</small></a>
<a class="dropdown-item" href="/office-hours/" style="color: #e5c6ab; line-height: 110%;"><i class="fa fa-fw mr-1 fa-users" aria-hidden="true"></i> Office Hours →<br><small class="text-secondary">Live Q&A calls with Python experts</small></a>
<a class="dropdown-item" href="/podcasts/rpp/" style="color: #b8abe5; line-height: 110%;"><i class="fa fa-fw mr-1 fa-podcast" aria-hidden="true"></i> Podcast →<br><small class="text-secondary">Hear what’s new in the world of Python</small></a>
<a class="dropdown-item pb-3" href="/products/books/" style="color: #abe5b1; line-height: 110%;"><i class="fa fa-fw mr-1 fa-book" aria-hidden="true"></i> Books →<br><small class="text-secondary">Round out your knowledge and learn offline</small></a>
<a class="dropdown-item border-top text-warning" href="/account/join/"><i class="fa fa-fw fa-star text-warning" aria-hidden="true"></i> Unlock All Content →</a>
</div>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMore" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
More
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMore">
<a class="dropdown-item" href="/products/">Python Learning Resources</a>
<a class="dropdown-item" href="/newsletter/">Python Newsletter</a>
<a class="dropdown-item" href="https://www.pythonjobshq.com" target="_blank">Python Job Board</a>
<a class="dropdown-item" href="/team/">Meet the Team</a>
<a class="dropdown-item" href="/write-for-us/">Become a Tutorial Author</a>
<a class="dropdown-item" href="/become-an-instructor/">Become a Video Instructor</a>
</div>
</li>
</ul>
<div class="d-block d-lg-none">
<ul class="navbar-nav">
<li class="nav-item">
<a class="nav-link" href="/search" title="Search"><span class="d-block d-lg-none"><i class="fa fa-search" aria-hidden="true"></i> Search</span><span class="d-none d-lg-block"><i class="fa fa-search" aria-hidden="true"></i></span></a>
</li>
</ul>
</div>
<div class="d-none d-lg-flex align-items-center mr-2 flex-fill">
<form class="form-inline w-100" action="/search" method="GET">
<a class="js-search-form-submit position-absolute" href="/search" title="Search"><i class="fa fa-search fa-fw text-muted pl-2" aria-hidden="true"></i></a>
<input class="search-field form-control form-control-md mr-sm-1 mr-lg-2 w-100" style="padding-left: 2rem;" maxlength=50 type="search" placeholder="Search" aria-label="Search" name="q">
<input type="hidden" name="_from" value="nav">
</form>
</div>
<ul class="navbar-nav ml-auto">
<li class="nav-item form-inline">
<a class="ml-2 ml-lg-0 btn btn-sm btn-primary px-3" href="/account/join/">Join</a>
</li>
<li class="nav-item">
<a class="btn text-light" href="/account/login/?next=%2Fcpython-source-code-guide%2F">Sign&#8209;In</a>
</li>
</ul>
</div>
</div>
</nav>
<div class="container main-content">
<div class="row justify-content-center">
<div class="col-md-11 col-lg-8 article with-headerlinks">
<figure class="embed-responsive embed-responsive-16by9">
<img class="card-img-top m-0 p-0 embed-responsive-item rounded" style="object-fit: contain;" alt="Your Guide to the CPython Source Code" src="https://files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg" width="1920" height="1080" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg&amp;w=480&amp;sig=96b8dae849a0d709af66b6b3a62c6851559ffe58 480w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg&amp;w=960&amp;sig=245b94a3e730127741da1c7716a22f3da28bb915 960w, https://files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg 1920w" sizes="75vw">
</figure>
<h1>Your Guide to the CPython Source Code</h1>
<div class="mb-0">
<span class="text-muted">by <a class="text-muted" href="#author">Anthony Shaw</a>
<span class="ml-2 mr-1 fa fa-comments"></span><a class="text-muted" href="#reader-comments"><span class="disqus-comment-count" data-disqus-identifier="https://realpython.com/cpython-source-code-guide/"></span></a>
<span class="ml-2 fa fa-tags" aria-hidden="true"></span>
<a href="/tutorials/advanced/" class="badge badge-light text-muted">advanced</a>
<a href="/tutorials/python/" class="badge badge-light text-muted">python</a>
<div class="d-sm-flex flex-row justify-content-between my-3 text-center">
<div class="jsCompletionStatusWidget btn-group mb-0">
<button title="Click to mark as completed" class="jsBtnCompletion btn btn-secondary border-right " style="border-top-right-radius: 0; border-bottom-right-radius: 0;" disabled>Mark as Completed</button>
<button title="Add bookmark" class="jsBtnBookmark btn btn-secondary border-left" disabled><i class="fa fa-fw fa-bookmark-o"></i></button>
</div>
<div class="align-self-center my-2">
<span>
<a target="_blank" rel="nofollow" href="https://twitter.com/intent/tweet/?text=Check out this %23Python tutorial: Your%20Guide%20to%20the%20CPython%20Source%20Code by @realpython&url=https%3A//realpython.com/cpython-source-code-guide/" class="mr-1 badge badge-twitter text-light mb-1"><i class="mr-1 fa fa-twitter text-light"></i>Tweet</a>
<a target="_blank" rel="nofollow" href="https://facebook.com/sharer/sharer.php?u=https%3A//realpython.com/cpython-source-code-guide/" class="mr-1 badge badge-facebook text-light mb-1"><i class="mr-1 fa fa-facebook text-light"></i>Share</a>
<a target="_blank" rel="nofollow" href="mailto:?subject=Python article for you&body=Check out this Python tutorial:%0A%0AYour%20Guide%20to%20the%20CPython%20Source%20Code%0A%0Ahttps%3A//realpython.com/cpython-source-code-guide/" class="badge badge-red text-light mb-1"><i class="mr-1 fa fa-envelope text-light"></i>Email</a>
</span>
</div>
</div>
</div>
<div class="article-body">
<div class="bg-light sidebar-module sidebar-module-inset" id="toc">
<p class="h3 mb-2 text-muted">Table of Contents</p>
<div class="toc">
<ul>
<li><a href="#part-1-introduction-to-cpython">Part 1: Introduction to CPython</a><ul>
<li><a href="#whats-in-the-source-code">What&rsquo;s in the Source Code?</a></li>
<li><a href="#compiling-cpython-macos">Compiling CPython (macOS)</a></li>
<li><a href="#compiling-cpython-linux">Compiling CPython (Linux)</a></li>
<li><a href="#compiling-cpython-windows">Compiling CPython (Windows)</a></li>
<li><a href="#what-does-a-compiler-do">What Does a Compiler Do?</a></li>
<li><a href="#why-is-cpython-written-in-c-and-not-python">Why Is CPython Written in C and Not Python?</a></li>
<li><a href="#the-python-language-specification">The Python Language Specification</a></li>
<li><a href="#memory-management-in-cpython">Memory Management in CPython</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-2-the-python-interpreter-process">Part 2: The Python Interpreter Process</a><ul>
<li><a href="#establishing-runtime-configuration">Establishing Runtime Configuration</a></li>
<li><a href="#reading-filesinput">Reading Files/Input</a></li>
<li><a href="#lexing-and-parsing">Lexing and Parsing</a></li>
<li><a href="#abstract-syntax-trees">Abstract Syntax Trees</a></li>
<li><a href="#conclusion_1">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-3-the-cpython-compiler-and-execution-loop">Part 3: The CPython Compiler and Execution Loop</a><ul>
<li><a href="#compiling">Compiling</a></li>
<li><a href="#execution">Execution</a></li>
<li><a href="#conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-4-objects-in-cpython">Part 4: Objects in CPython</a><ul>
<li><a href="#base-object-type">Base Object Type</a></li>
<li><a href="#the-bool-and-long-integer-type">The Bool and Long Integer Type</a></li>
<li><a href="#a-review-of-the-generator-type">A Review of the Generator Type</a></li>
<li><a href="#conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-5-the-cpython-standard-library">Part 5: The CPython Standard Library</a><ul>
<li><a href="#python-modules">Python Modules</a></li>
<li><a href="#python-and-c-modules">Python and C Modules</a></li>
<li><a href="#the-cpython-regression-test-suite">The CPython Regression Test Suite</a></li>
<li><a href="#installing-a-custom-version">Installing a Custom Version</a></li>
</ul>
</li>
<li><a href="#the-cpython-source-code-conclusion">The CPython Source Code: Conclusion</a></li>
</ul>
</div>
</div>
<div class="sidebar-module sidebar-module-inset p-0" style="overflow:hidden;">
<div style="display:block;position:relative;">
<div style="display:block;width:100%;padding-top:12.5%;"></div>
<div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
</div>
<a class="small text-muted" href="/account/join/" rel="nofollow"> <i class="fa fa-info-circle" aria-hidden="true"> </i> Remove ads</a>
</div>
<p>Are there certain parts of Python that just seem magic? Like how are <a href="https://realpython.com/python-dicts/">dictionaries</a> so much faster than looping over a list to find an item. How does a generator remember the state of the variables each time it yields a value and why do you never have to allocate memory like other languages? It turns out, CPython, the most popular Python runtime is written in human-readable <a href="https://realpython.com/c-for-python-programmers/">C</a> and Python code. This tutorial will walk you through the CPython source code. </p>
<p>You&rsquo;ll cover all the concepts behind the internals of CPython, how they work and visual explanations as you go.</p>
<p><strong>You&rsquo;ll learn how to:</strong></p>
<ul>
<li>Read and navigate the source code</li>
<li>Compile CPython from source code</li>
<li>Navigate and comprehend the inner workings of concepts like lists, dictionaries, and generators</li>
<li>Run the test suite</li>
<li>Modify or upgrade components of the CPython library to contribute them to future versions</li>
</ul>
<p>Yes, this is a very long article. If you just made yourself a fresh cup of tea, coffee or your favorite beverage, it&rsquo;s going to be cold by the end of Part 1. </p>
<p>This tutorial is split into five parts. Take your time for each part and make sure you try out the demos and the interactive components. You can feel a sense of achievement that you grasp the core concepts of Python that can make you a better Python programmer.</p>
<div class="alert alert-warning" role="alert">
<p><strong markdown="1">Free Download:</strong> <a href="https://realpython.com/bonus/cpython-internals-sample/" class="alert-link" data-toggle="modal" data-target="#modal-cpython-internals-sample" data-focus="false" markdown="1">Get a sample chapter from CPython Internals: Your Guide to the Python 3 Interpreter</a> showing you how to unlock the inner workings of the Python language, compile the Python interpreter from source code, and participate in the development of CPython.</p>
</div>
<section class="section2" h1="h1" id="part-1-introduction-to-cpython"><h2>Part 1: Introduction to CPython<a class="headerlink" href="#part-1-introduction-to-cpython" title="Permanent link"></a></h2>
<p>When you type <code>python</code> at the console or install a Python distribution from <a href="https://www.python.org">python.org</a>, you are running <strong>CPython</strong>. CPython is one of the many Python runtimes, maintained and written by different teams of developers. Some other runtimes you may have heard are <a href="https://pypy.org/">PyPy</a>, <a href="https://cython.org/">Cython</a>, and <a href="https://www.jython.org/">Jython</a>.</p>
<p>The unique thing about CPython is that it contains both a runtime and the shared language specification that all Python runtimes use. CPython is the &ldquo;official,&rdquo; or reference implementation of Python.</p>
<p>The Python language specification is the document that the description of the Python language. For example, it says that <code>assert</code> is a <a href="https://realpython.com/python-keywords/">reserved keyword</a>, and that <code>[]</code> is used for indexing, slicing, and creating empty lists.</p>
<p>Think about what you expect to be inside the Python distribution on your computer:</p>
<ul>
<li>When you type <code>python</code> without a file or module, it gives an interactive prompt.</li>
<li>You can import built-in modules from the standard library like <code>json</code>.</li>
<li>You can install packages from the internet using <code>pip</code>.</li>
<li>You can test your applications using the built-in <code>unittest</code> library.</li>
</ul>
<p>These are all part of the CPython distribution. There&rsquo;s a lot more than just a compiler.</p>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> This article is written against version <a href="https://github.com/python/cpython/tree/v3.8.0b4">3.8.0b4</a> of the CPython source code.</p>
</div>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div><section class="section3" id="whats-in-the-source-code"><h3>What&rsquo;s in the Source Code?<a class="headerlink" href="#whats-in-the-source-code" title="Permanent link"></a></h3>
<p>The CPython source distribution comes with a whole range of tools, libraries, and components. We&rsquo;ll explore those in this article. First we are going to focus on the compiler.</p>
<p>To download a copy of the CPython source code, you can use <a href="https://realpython.com/python-git-github-intro/"><code>git</code></a> to pull the latest version to a working copy locally:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>git clone https://github.com/python/cpython
<span class="gp">$ </span><span class="nb">cd</span> cpython
<span class="gp">$ </span>git checkout v3.8.0b4
</code></pre></div>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> If you don&rsquo;t have Git available, you can download the source in a <a href="https://github.com/python/cpython/archive/v3.8.0b4.zip">ZIP</a> file directly from the GitHub website.</p>
</div>
<p>Inside of the newly downloaded <code>cpython</code> directory, you will find the following subdirectories:</p>
<div class="highlight"><pre><span></span><code>cpython/
│
├── Doc      ← Source for the documentation
├── Grammar  ← The computer-readable language definition
├── Include  ← The C header files
├── Lib      ← Standard library modules written in Python
├── Mac      ← macOS support files
├── Misc     ← Miscellaneous files
├── Modules  ← Standard Library Modules written in C
├── Objects  ← Core types and the object model
├── Parser   ← The Python parser source code
├── PC       ← Windows build support files
├── PCbuild  ← Windows build support files for older Windows versions
├── Programs ← Source code for the python executable and other binaries
├── Python   ← The CPython interpreter source code
└── Tools    ← Standalone tools useful for building or extending Python
</code></pre></div>
<p>Next, we&rsquo;ll compile CPython from the source code. This step requires a C compiler, and some build tools, which depend on the operating system you&rsquo;re using.</p>
</section><section class="section3" id="compiling-cpython-macos"><h3>Compiling CPython (macOS)<a class="headerlink" href="#compiling-cpython-macos" title="Permanent link"></a></h3>
<p>Compiling CPython on macOS is straightforward. You will first need the essential C compiler toolkit. The Command Line Development Tools is an app that you can update in macOS through the App Store. You need to perform the initial installation on the terminal.</p>
<p>To open up a terminal in macOS, go to the Launchpad, then <em>Other</em> then choose the <em>Terminal</em> app. You will want to save this app to your Dock, so right-click the Icon and select <em>Keep in Dock</em>.</p>
<p>Now, within the terminal, install the C compiler and toolkit by running the following:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>xcode-select --install
</code></pre></div>
<p>This command will pop up with a prompt to download and install a set of tools, including Git, Make, and the GNU C compiler.</p>
<p>You will also need a working copy of <a href="https://www.openssl.org/">OpenSSL</a> to use for fetching packages from the PyPi.org website. If you later plan on using this build to install additional packages, SSL validation is required.</p>
<p>The simplest way to install OpenSSL on macOS is by using <a href="https://brew.sh">HomeBrew</a>. If you already have HomeBrew installed, you can install the dependencies for CPython with the <code>brew install</code> command:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>brew install openssl xz zlib
</code></pre></div>
<p>Now that you have the dependencies, you can run the <code>configure</code> script, enabling SSL support by discovering the location that HomeBrew installed to and enabling the debug hooks <code>--with-pydebug</code>:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span><span class="nv">CPPFLAGS</span><span class="o">=</span><span class="s2">&quot;-I</span><span class="k">$(</span>brew --prefix zlib<span class="k">)</span><span class="s2">/include&quot;</span> <span class="se">\</span>
 <span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-L</span><span class="k">$(</span>brew --prefix zlib<span class="k">)</span><span class="s2">/lib&quot;</span> <span class="se">\</span>
 ./configure --with-openssl<span class="o">=</span><span class="k">$(</span>brew --prefix openssl<span class="k">)</span> --with-pydebug
</code></pre></div>
<p>This will generate a <code>Makefile</code> in the root of the repository that you can use to automate the build process. The <code>./configure</code> step only needs to be run once. You can build the CPython binary by running:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>make -j2 -s
</code></pre></div>
<p>The <code>-j2</code> flag allows <code>make</code> to run 2 jobs simultaneously. If you have 4 cores, you can change this to 4. The <code>-s</code> flag stops the <code>Makefile</code> from printing every command it runs to the console. You can remove this, but the output is very verbose.</p>
<p>During the build, you may receive some errors, and in the summary, it will notify you that not all packages could be built. For example, <code>_dbm</code>, <code>_sqlite3</code>, <code>_uuid</code>, <code>nis</code>, <code>ossaudiodev</code>, <code>spwd</code>, and <code>_tkinter</code> would fail to build with this set of instructions. That&rsquo;s okay if you aren&rsquo;t planning on developing against those packages. If you are, then check out the <a href="https://devguide.python.org/">dev guide</a> website for more information.</p>
<p>The build will take a few minutes and generate a binary called <code>python.exe</code>. Every time you make changes to the source code, you will need to re-run <code>make</code> with the same flags.
The <code>python.exe</code> binary is the debug binary of CPython. Execute <code>python.exe</code> to see a working REPL:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe
<span class="go">Python 3.8.0b4 (tags/v3.8.0b4:d93605de72, Aug 30 2019, 10:00:03) </span>
<span class="go">[Clang 10.0.1 (clang-1001.0.46.4)] on darwin</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="gp">&gt;</span>&gt;&gt; 
</code></pre></div>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong>
Yes, that&rsquo;s right, the macOS build has a file extension for <code>.exe</code>. This is <em>not</em> because it&rsquo;s a Windows binary. Because macOS has a case-insensitive filesystem and when working with the binary, the developers didn&rsquo;t want people to accidentally refer to the directory <code>Python/</code> so <code>.exe</code> was appended to avoid ambiguity.
If you later run <code>make install</code> or <code>make altinstall</code>, it will rename the file back to <code>python</code>.</p>
</div>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section><section class="section3" id="compiling-cpython-linux"><h3>Compiling CPython (Linux)<a class="headerlink" href="#compiling-cpython-linux" title="Permanent link"></a></h3>
<p>For Linux, the first step is to download and install <code>make</code>, <code>gcc</code>, <code>configure</code>, and <code>pkgconfig</code>. </p>
<p>For Fedora Core, RHEL, CentOS, or other yum-based systems: </p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>sudo yum install yum-utils
</code></pre></div>
<p>For Debian, Ubuntu, or other <code>apt</code>-based systems:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>sudo apt install build-essential
</code></pre></div>
<p>Then install the required packages, for Fedora Core, RHEL, CentOS or other yum-based systems: </p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>sudo yum-builddep python3
</code></pre></div>
<p>For Debian, Ubuntu, or other <code>apt</code>-based systems:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>sudo apt install libssl-dev zlib1g-dev libncurses5-dev <span class="se">\</span>
  libncursesw5-dev libreadline-dev libsqlite3-dev libgdbm-dev <span class="se">\</span>
  libdb5.3-dev libbz2-dev libexpat1-dev liblzma-dev libffi-dev
</code></pre></div>
<p>Now that you have the dependencies, you can run the <code>configure</code> script, enabling the debug hooks <code>--with-pydebug</code>:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./configure --with-pydebug
</code></pre></div>
<p>Review the output to ensure that OpenSSL support was marked as <code>YES</code>. Otherwise, check with your distribution for instructions on installing the headers for OpenSSL.</p>
<p>Next, you can build the CPython binary by running the generated <code>Makefile</code>:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>make -j2 -s
</code></pre></div>
<p>During the build, you may receive some errors, and in the summary, it will notify you that not all packages could be built. That&rsquo;s okay if you aren&rsquo;t planning on developing against those packages. If you are, then check out the <a href="https://devguide.python.org/">dev guide</a> website for more information.</p>
<p>The build will take a few minutes and generate a binary called <code>python</code>. This is the debug binary of CPython. Execute <code>./python</code> to see a working REPL:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python
<span class="go">Python 3.8.0b4 (tags/v3.8.0b4:d93605de72, Aug 30 2019, 10:00:03) </span>
<span class="go">[Clang 10.0.1 (clang-1001.0.46.4)] on darwin</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="gp">&gt;</span>&gt;&gt; 
</code></pre></div>
</section><section class="section3" id="compiling-cpython-windows"><h3>Compiling CPython (Windows)<a class="headerlink" href="#compiling-cpython-windows" title="Permanent link"></a></h3>
<p>Inside the PC folder is a Visual Studio project file for building and exploring CPython. To use this, you need to have Visual Studio installed on your PC.</p>
<p>The newest version of Visual Studio, Visual Studio 2019, makes it easier to work with Python and the CPython source code, so it is recommended for use in this tutorial. If you already have Visual Studio 2017 installed, that would also work fine.</p>
<p>None of the paid features are required for compiling CPython or this tutorial. You can use the Community edition of Visual Studio, which is available for free from <a href="https://visualstudio.microsoft.com/vs/">Microsoft&rsquo;s Visual Studio website</a>.</p>
<p>Once you&rsquo;ve downloaded the installer, you&rsquo;ll be asked to select which components you want to install. The bare minimum for this tutorial is:</p>
<ul>
<li>The <strong>Python Development</strong> workload</li>
<li>The optional <strong>Python native development tools</strong></li>
<li>Python 3 64-bit (3.7.2) (can be deselected if you already have Python 3.7 installed)</li>
</ul>
<p>Any other optional features can be deselected if you want to be more conscientious with disk space:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-08-22_at_2.47.23_pm.5e8682a89503.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-08-22_at_2.47.23_pm.5e8682a89503.png" width="2504" height="1260" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-08-22_at_2.47.23_pm.5e8682a89503.png&amp;w=626&amp;sig=86eb9f82580a69f533983087ba0fa4faf0d5bf96 626w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-08-22_at_2.47.23_pm.5e8682a89503.png&amp;w=1252&amp;sig=fe2157486f81073eabe043b3c441af23dd67b78a 1252w, https://files.realpython.com/media/Screen_Shot_2019-08-22_at_2.47.23_pm.5e8682a89503.png 2504w" sizes="75vw" alt="Visual Studio Options Window" data-asset="1318" /></a></figure>
<p>The installer will then download and install all of the required components. The installation could take an hour, so you may want to read on and come back to this section.</p>
<p>Once the installer has completed, click the <em>Launch</em> button to start Visual Studio. You will be prompted to sign in. If you have a Microsoft account you can log in, or skip that step.</p>
<p>Once Visual Studio starts, you will be prompted to Open a Project. A shortcut to getting started with the Git configuration and cloning CPython is to choose the <em>Clone or check out code</em> option:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Capture3.e19765d74ec4.PNG" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block w-50" src="https://files.realpython.com/media/Capture3.e19765d74ec4.PNG" width="2048" height="1420" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture3.e19765d74ec4.PNG&amp;w=512&amp;sig=e475e2a09cd780894f108850f91736c53ac95f27 512w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture3.e19765d74ec4.PNG&amp;w=1024&amp;sig=47d66a316c2546c9787e5af4cb4a9a006dca936d 1024w, https://files.realpython.com/media/Capture3.e19765d74ec4.PNG 2048w" sizes="75vw" alt="Choosing a Project Type in Visual Studio" data-asset="1320" /></a></figure>
<p>For the project URL, type <code>https://github.com/python/cpython</code> to clone:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Capture4.ea01418a971c.PNG" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block w-50" src="https://files.realpython.com/media/Capture4.ea01418a971c.PNG" width="2048" height="1420" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture4.ea01418a971c.PNG&amp;w=512&amp;sig=47ed81b234652446a4f0e77e2a3f70e0074ac222 512w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture4.ea01418a971c.PNG&amp;w=1024&amp;sig=de393823fe557847f295d040573bd061b2ccd557 1024w, https://files.realpython.com/media/Capture4.ea01418a971c.PNG 2048w" sizes="75vw" alt="Cloning projects in Visual Studio" data-asset="1319" /></a></figure>
<p>Visual Studio will then download a copy of CPython from GitHub using the version of Git bundled with Visual Studio. This step also saves you the hassle of having to install Git on Windows. The download may take 10 minutes.</p>
<p>Once the project has downloaded, you need to point it to the <strong><code>pcbuild</code></strong> Solution file, by clicking on <em>Solutions and Projects</em> and selecting <code>pcbuild.sln</code>:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Capture6.3d06a62b8e87.PNG" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border w-50" src="https://files.realpython.com/media/Capture6.3d06a62b8e87.PNG" width="863" height="565" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture6.3d06a62b8e87.PNG&amp;w=215&amp;sig=0d4c23758a58848ea65b74514aca9e15a72748fa 215w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture6.3d06a62b8e87.PNG&amp;w=431&amp;sig=05f0ebe121ef54abf51bcdb55fba695d28656868 431w, https://files.realpython.com/media/Capture6.3d06a62b8e87.PNG 863w" sizes="75vw" alt="Selecting a solution" data-asset="1321" /></a></figure>
<p>When the solution is loaded, it will prompt you to retarget the project&rsquo;s inside the solution to the version of the C/C++ compiler you have installed. Visual Studio will also target the version of the Windows SDK you have installed.</p>
<p>Ensure that you change the Windows SDK version to the newest installed version and the platform toolset to the latest version. If you missed this window, you can right-click on the Solution in the <em>Solutions and Projects</em> window and click <em>Retarget Solution</em>.</p>
<p>Once this is complete, you need to download some source files to be able to build the whole CPython package. Inside the <code>PCBuild</code> folder there is a <code>.bat</code> file that automates this for you. <a href="https://www.youtube.com/watch?v=bgSSJQolR0E">Open up a command-line prompt inside</a> the downloaded <code>PCBuild</code> and run <code>get_externals.bat</code>:</p>
<div class="highlight sh"><pre><span></span><code><span class="go"> &gt; get_externals.bat</span>
<span class="go">Using py -3.7 (found 3.7 with py.exe)</span>
<span class="go">Fetching external libraries...</span>
<span class="go">Fetching bzip2-1.0.6...</span>
<span class="go">Fetching sqlite-3.21.0.0...</span>
<span class="go">Fetching xz-5.2.2...</span>
<span class="go">Fetching zlib-1.2.11...</span>
<span class="go">Fetching external binaries...</span>
<span class="go">Fetching openssl-bin-1.1.0j...</span>
<span class="go">Fetching tcltk-8.6.9.0...</span>
<span class="go">Finished.</span>
</code></pre></div>
<p>Next, back within Visual Studio, build CPython by pressing <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-shift">Shift</kbd><span>+</span><kbd class="key-b">B</kbd></span>, or choosing <em>Build Solution</em> from the top menu. If you receive any errors about the Windows SDK being missing, make sure you set the right targeting settings in the <em>Retarget Solution</em> window. You should also see <em>Windows Kits</em> inside your Start Menu, and <em>Windows Software Development Kit</em> inside of that menu.</p>
<p>The build stage could take 10 minutes or more for the first time. Once the build is completed, you may see a few warnings that you can ignore and eventual completion.</p>
<p>To start the debug version of CPython, press <span class="keys"><kbd class="key-f5">F5</kbd></span> and CPython will start in Debug mode straight into the REPL:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Capture8.967a3606daf0.PNG" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border " src="https://files.realpython.com/media/Capture8.967a3606daf0.PNG" width="3360" height="2100" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture8.967a3606daf0.PNG&amp;w=840&amp;sig=1822fde8ffe6946fc91e47dd8975aa23add8b23a 840w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Capture8.967a3606daf0.PNG&amp;w=1680&amp;sig=a093e68320ad548384c585840002e4294ab4bf94 1680w, https://files.realpython.com/media/Capture8.967a3606daf0.PNG 3360w" sizes="75vw" alt="CPython debugging Windows" data-asset="1322" /></a></figure>
<p>Once this is completed, you can run the Release build by changing the build configuration from <em>Debug</em> to <em>Release</em> on the top menu bar and rerunning Build Solution again.
You now have both Debug and Release versions of the CPython binary within <code>PCBuild\win32\</code>.</p>
<p>You can set up Visual Studio to be able to open a REPL with either the Release or Debug build by choosing <em><code>Tools</code>-&gt;<code>Python</code>-&gt;<code>Python Environments</code></em> from the top menu:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Environments.96a819ecf0b3.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border " src="https://files.realpython.com/media/Environments.96a819ecf0b3.png" width="3360" height="2033" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Environments.96a819ecf0b3.png&amp;w=840&amp;sig=f8dd9b3b31d44c25cbe06d56078b0462cb0fa753 840w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Environments.96a819ecf0b3.png&amp;w=1680&amp;sig=e8ca69be87363b62ccda44bcf53bedd4e4e320c2 1680w, https://files.realpython.com/media/Environments.96a819ecf0b3.png 3360w" sizes="75vw" alt="Choosing Python environments" data-asset="1334" /></a></figure>
<p>Then click <em>Add Environment</em> and then target the Debug or Release binary. The Debug binary will end in <code>_d.exe</code>, for example, <code>python_d.exe</code> and <code>pythonw_d.exe</code>. You will most likely want to use the debug binary as it comes with Debugging support in Visual Studio and will be useful for this tutorial.</p>
<p>In the Add Environment window, target the <code>python_d.exe</code> file as the interpreter inside the <code>PCBuild/win32</code> and the <code>pythonw_d.exe</code> as the windowed interpreter:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/environment3.d33858c1f6aa.PNG" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/environment3.d33858c1f6aa.PNG" width="2048" height="1352" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/environment3.d33858c1f6aa.PNG&amp;w=512&amp;sig=ffc6b359ac60d689f40f98233466cef35354d239 512w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/environment3.d33858c1f6aa.PNG&amp;w=1024&amp;sig=d881ce7ecabc62624fb2a5154102a5be2ff6a4db 1024w, https://files.realpython.com/media/environment3.d33858c1f6aa.PNG 2048w" sizes="75vw" alt="Adding an environment in VS2019" data-asset="1335" /></a></figure>
<p>Now, you can start a REPL session by clicking <em>Open Interactive Window</em> in the Python Environments window and you will see the REPL for the compiled version of Python:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/environment4.7c9eade3b74e.PNG" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border " src="https://files.realpython.com/media/environment4.7c9eade3b74e.PNG" width="3360" height="2033" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/environment4.7c9eade3b74e.PNG&amp;w=840&amp;sig=9e384e72bcfdebb39fe6dc23f21c239a0895ad51 840w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/environment4.7c9eade3b74e.PNG&amp;w=1680&amp;sig=be56aac5b9baffc9b8b0de4701527954ed32ef53 1680w, https://files.realpython.com/media/environment4.7c9eade3b74e.PNG 3360w" sizes="75vw" alt="Python Environment REPL" data-asset="1336" /></a></figure>
<p>During this tutorial there will be REPL sessions with example commands. I encourage you to use the Debug binary to run these REPL sessions in case you want to put in any breakpoints within the code.</p>
<p>Lastly, to make it easier to navigate the code, in the Solution View, click on the toggle button next to the Home icon to switch to Folder view:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/environments5.6462694398e3.6fb872a5f57d.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border " src="https://files.realpython.com/media/environments5.6462694398e3.6fb872a5f57d.png" width="1231" height="692" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/environments5.6462694398e3.6fb872a5f57d.png&amp;w=307&amp;sig=14bf2b50bd86dfabedc3ee1ec75a60ebccd574c4 307w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/environments5.6462694398e3.6fb872a5f57d.png&amp;w=615&amp;sig=0d5644853d8c429ccc78fc1bced16d8f571f555d 615w, https://files.realpython.com/media/environments5.6462694398e3.6fb872a5f57d.png 1231w" sizes="75vw" alt="Switching Environment Mode" data-asset="1337" /></a></figure>
<p>Now you have a version of CPython compiled and ready to go, let&rsquo;s find out how the CPython compiler works.</p>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section><section class="section3" id="what-does-a-compiler-do"><h3>What Does a Compiler Do?<a class="headerlink" href="#what-does-a-compiler-do" title="Permanent link"></a></h3>
<p>The purpose of a compiler is to convert one language into another. Think of a compiler like a translator. You would hire a translator to listen to you speaking in English and then speak in Japanese:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/t.38be306a7e83.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block w-75" src="https://files.realpython.com/media/t.38be306a7e83.png" width="960" height="540" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/t.38be306a7e83.png&amp;w=240&amp;sig=2ad6eec49af1eaba79b83c099925e01a970d5efd 240w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/t.38be306a7e83.png&amp;w=480&amp;sig=033587107c8dceca7bcc292527a4c815fffb0b8d 480w, https://files.realpython.com/media/t.38be306a7e83.png 960w" sizes="75vw" alt="Translating from English to Japanese" data-asset="1702" /></a></figure>
<p>Some compilers will compile into a low-level machine code which can be executed directly on a system. Other compilers will compile into an intermediary language, to be executed by a virtual machine.</p>
<p>One important decision to make when choosing a compiler is the system portability requirements. <a href="https://en.wikipedia.org/wiki/Java_bytecode">Java</a> and <a href="https://en.wikipedia.org/wiki/Common_Language_Runtime">.NET CLR</a> will compile into an Intermediary Language so that the compiled code is portable across multiple systems architectures. C, Go, C++, and Pascal will compile into a low-level executable that will only work on systems similar to the one it was compiled. </p>
<p>Because Python applications are typically distributed as source code, the role of the Python runtime is to convert the Python source code and execute it in one step. Internally, the CPython runtime does compile your code. A popular misconception is that Python is an interpreted language. It is actually compiled.</p>
<p>Python code is not compiled into machine-code. It is compiled into a special low-level intermediary language called <strong>bytecode</strong> that only CPython understands. This code is stored in <code>.pyc</code> files in a hidden directory and cached for execution. If you run the same Python application twice without changing the source code, it&rsquo;ll always be much faster the second time. This is because it loads the compiled bytecode and executes it directly.</p>
</section><section class="section3" id="why-is-cpython-written-in-c-and-not-python"><h3>Why Is CPython Written in C and Not Python?<a class="headerlink" href="#why-is-cpython-written-in-c-and-not-python" title="Permanent link"></a></h3>
<p>The <strong>C</strong> in CPython is a reference to the C programming language, implying that this Python distribution is written in the C language.</p>
<p>This statement is largely true: the compiler in CPython is written in pure C. However, many of the standard library modules are written in pure Python or a combination of C and Python.</p>
<p><strong>So why is CPython written in C and not Python?</strong></p>
<p>The answer is located in how compilers work. There are two types of compiler:</p>
<ol>
<li><strong><a href="https://en.wikipedia.org/wiki/Self-hosting">Self-hosted compilers</a></strong> are compilers written in the language they compile, such as the Go compiler.</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Source-to-source_compiler">Source-to-source compilers</a></strong> are compilers written in another language that already have a compiler.</li>
</ol>
<p>If you&rsquo;re writing a new programming language from scratch, you need an executable application to compile your compiler! You need a compiler to execute anything, so when new languages are developed, they&rsquo;re often written first in an older, more established language.</p>
<p>A good example would be the Go programming language. The first Go compiler was written in C, then once Go could be compiled, the compiler was rewritten in Go. </p>
<p>CPython kept its C heritage: many of the standard library modules, like the <code>ssl</code> module or the <code>sockets</code> module, are written in C to access low-level operating system APIs.
The APIs in the Windows and Linux kernels for <a href="https://realpython.com/python-sockets/">creating network sockets</a>, <a href="https://realpython.com/working-with-files-in-python/">working with the filesystem</a> or <a href="https://realpython.com/python-gui-with-wxpython/">interacting with the display</a> are all written in C. It made sense for Python&rsquo;s extensibility layer to be focused on the C language. Later in this article, we will cover the Python Standard Library and the C modules.</p>
<p>There is a Python compiler written in Python called <a href="https://realpython.com/pypy-faster-python/">PyPy</a>. PyPy&rsquo;s logo is an <a href="https://en.wikipedia.org/wiki/Ouroboros">Ouroboros</a> to represent the self-hosting nature of the compiler.</p>
<p>Another example of a cross-compiler for Python is <a href="https://www.jython.org/">Jython</a>. Jython is written in Java and compiles from Python source code into Java bytecode. In the same way that CPython makes it easy to import C libraries and use them from Python, Jython makes it easy to import and reference Java modules and classes.</p>
</section><section class="section3" id="the-python-language-specification"><h3>The Python Language Specification<a class="headerlink" href="#the-python-language-specification" title="Permanent link"></a></h3>
<p>Contained within the CPython source code is the definition of the Python language. This is the reference specification used by all the Python interpreters.</p>
<p>The specification is in both human-readable and machine-readable format. Inside the documentation is a detailed explanation of the Python language, what is allowed, and how each statement should behave.</p>
<section class="section4" id="documentation"><h4>Documentation<a class="headerlink" href="#documentation" title="Permanent link"></a></h4>
<p>Located inside the <code>Doc/reference</code> directory are <a href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> explanations of each of the features in the Python language. This forms the official Python reference guide on <a href="https://docs.python.org/3/reference/">docs.python.org</a>.</p>
<p>Inside the directory are the files you need to understand the whole language, structure, and keywords:</p>
<div class="highlight"><pre><span></span><code>cpython/Doc/reference
|
├── compound_stmts.rst
├── datamodel.rst
├── executionmodel.rst
├── expressions.rst
├── grammar.rst
├── import.rst
├── index.rst
├── introduction.rst
├── lexical_analysis.rst
├── simple_stmts.rst
└── toplevel_components.rst
</code></pre></div>
<p>Inside <code>compound_stmts.rst</code>, the documentation for compound statements, you can see a simple example defining the <a href="https://realpython.com/python-with-statement/"><code>with</code> statement</a>.</p>
<p>The <code>with</code> statement can be used in multiple ways in Python, the simplest being the <a href="https://dbader.org/blog/python-context-managers-and-with-statement">instantiation of a context-manager</a> and a nested block of code:</p>
<div class="highlight python"><pre><span></span><code><span class="k">with</span> <span class="n">x</span><span class="p">():</span>
   <span class="o">...</span>
</code></pre></div>
<p>You can assign the result to a variable using the <code>as</code> keyword:</p>
<div class="highlight python"><pre><span></span><code><span class="k">with</span> <span class="n">x</span><span class="p">()</span> <span class="k">as</span> <span class="n">y</span><span class="p">:</span>
   <span class="o">...</span>
</code></pre></div>
<p>You can also chain context managers together with a comma:</p>
<div class="highlight python"><pre><span></span><code><span class="k">with</span> <span class="n">x</span><span class="p">()</span> <span class="k">as</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">()</span> <span class="k">as</span> <span class="n">jk</span><span class="p">:</span>
   <span class="o">...</span>
</code></pre></div>
<p>Next, we&rsquo;ll explore the computer-readable documentation of the Python language.</p>
</section><section class="section4" id="grammar"><h4>Grammar<a class="headerlink" href="#grammar" title="Permanent link"></a></h4>
<p>The documentation contains the human-readable specification of the language, and the machine-readable specification is housed in a single file, <a href="https://github.com/python/cpython/blob/master/Grammar/Grammar"><code>Grammar/Grammar</code></a>. </p>
<p>The Grammar file is written in a context-notation called <a href="https://en.m.wikipedia.org/wiki/Backus%E2%80%93Naur_form">Backus-Naur Form (BNF)</a>. BNF is not specific to Python and is often used as the notation for grammars in many other languages.</p>
<p>The concept of grammatical structure in a programming language is inspired by <a href="https://en.wikipedia.org/wiki/Syntactic_Structures">Noam Chomsky&rsquo;s work on Syntactic Structures</a> in the 1950s!</p>
<p>Python&rsquo;s grammar file uses the Extended-BNF (EBNF) specification with regular-expression syntax. So, in the grammar file you can use:</p>
<ul>
<li><strong><code>*</code></strong> for repetition</li>
<li><strong><code>+</code></strong> for at-least-once repetition</li>
<li><strong><code>[]</code></strong> for optional parts</li>
<li><strong><code>|</code></strong> for alternatives</li>
<li><strong><code>()</code></strong> for grouping</li>
</ul>
<p>If you search for the <code>with</code> statement in the grammar file, at around line 80 you&rsquo;ll see the definitions for the <code>with</code> statement:</p>
<div class="highlight text"><pre><span></span><code>with_stmt: &#39;with&#39; with_item (&#39;,&#39; with_item)*  &#39;:&#39; suite
with_item: test [&#39;as&#39; expr]
</code></pre></div>
<p>Anything in quotes is a string literal, which is how keywords are defined. So the <code>with_stmt</code> is specified as:</p>
<ol>
<li>Starting with the word <code>with</code></li>
<li>Followed by a <code>with_item</code>, which is a <code>test</code> and (optionally), the word <code>as</code>, and an expression</li>
<li>Following one or many items, each separated by a comma</li>
<li>Ending with a <code>:</code></li>
<li>Followed by a <code>suite</code></li>
</ol>
<p>There are references to some other definitions in these two lines:</p>
<ul>
<li><strong><code>suite</code></strong> refers to a block of code with one or multiple statements</li>
<li><strong><code>test</code></strong> refers to a simple statement that is evaluated</li>
<li><strong><code>expr</code></strong> refers to a simple expression</li>
</ul>
<p>If you want to explore those in detail, the whole of the Python grammar is defined in this single file.</p>
<p>If you want to see a recent example of how grammar is used, in PEP 572 the <strong>colon equals</strong> operator was added to the grammar file in <a href="https://github.com/python/cpython/commit/8f59ee01be3d83d5513a9a3f654a237d77d80d9a#diff-cb0b9d6312c0d67f6d4aa1966766cedd">this Git commit</a>.</p>
</section><section class="section4" id="using-pgen"><h4>Using <code>pgen</code><a class="headerlink" href="#using-pgen" title="Permanent link"></a></h4>
<p>The grammar file itself is never used by the Python compiler. Instead, a parser table created by a tool called <code>pgen</code> is used. <code>pgen</code> reads the grammar file and converts it into a parser table. If you make changes to the grammar file, you must regenerate the parser table and recompile Python.</p>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> The <code>pgen</code> application was rewritten in Python 3.8 from C to <a href="https://github.com/python/cpython/blob/master/Parser/pgen/pgen.py">pure Python</a>.</p>
</div>
<p>To see <code>pgen</code> in action, let&rsquo;s change part of the Python grammar. Around line 51 you will see the definition of a <a href="https://realpython.com/python-pass/"><code>pass</code> statement</a>:</p>
<div class="highlight text"><pre><span></span><code>pass_stmt: &#39;pass&#39;
</code></pre></div>
<p>Change that line to accept the keyword <code>'pass'</code> or <code>'proceed'</code> as keywords:</p>
<div class="highlight text"><pre><span></span><code>pass_stmt: &#39;pass&#39; | &#39;proceed&#39;
</code></pre></div>
<p>Now you need to rebuild the grammar files.
On macOS and Linux, run <code>make regen-grammar</code> to run <code>pgen</code> over the altered grammar file. For Windows, there is no officially supported way of running <code>pgen</code>. However, you can clone <a href="https://github.com/tonybaloney/cpython/tree/pcbuildregen">my fork</a> and run <code>build.bat --regen</code> from within the <code>PCBuild</code> directory.</p>
<p>You should see an output similar to this, showing that the new <code>Include/graminit.h</code> and <code>Python/graminit.c</code> files have been generated:</p>
<div class="highlight text"><pre><span></span><code># Regenerate Doc/library/token-list.inc from Grammar/Tokens
# using Tools/scripts/generate_token.py
...
python3 ./Tools/scripts/update_file.py ./Include/graminit.h ./Include/graminit.h.new
python3 ./Tools/scripts/update_file.py ./Python/graminit.c ./Python/graminit.c.new
</code></pre></div>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> <code>pgen</code> works by converting the EBNF statements into a <a href="https://en.wikipedia.org/wiki/Nondeterministic_finite_automaton">Non-deterministic Finite Automaton (NFA)</a>, which is then turned into a <a href="https://en.wikipedia.org/wiki/Deterministic_finite_automaton">Deterministic Finite Automaton (DFA)</a>.
The DFAs are used by the parser as parsing tables in a special way that&rsquo;s unique to CPython. This technique was <a href="http://infolab.stanford.edu/~ullman/dragon/slides1.pdf">formed at Stanford University</a> and developed in the 1980s, just before the advent of Python.</p>
</div>
<p>With the regenerated parser tables, you need to recompile CPython to see the new syntax. Use the same compilation steps you used earlier for your operating system.</p>
<p>If the code compiled successfully, you can execute your new CPython binary and start a REPL.</p>
<p>In the REPL, you can now try defining a function and instead of using the <code>pass</code> statement, use the <code>proceed</code> keyword alternative that you compiled into the Python grammar:</p>
<div class="highlight text"><pre><span></span><code>Python 3.8.0b4 (tags/v3.8.0b4:d93605de72, Aug 30 2019, 10:00:03) 
[Clang 10.0.1 (clang-1001.0.46.4)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; def example():
...    proceed
... 
&gt;&gt;&gt; example()
</code></pre></div>
<p>Well done! You&rsquo;ve changed the CPython syntax and compiled your own version of CPython. Ship it!</p>
<p>Next, we&rsquo;ll explore tokens and their relationship to grammar.</p>
</section><section class="section4" id="tokens"><h4>Tokens<a class="headerlink" href="#tokens" title="Permanent link"></a></h4>
<p>Alongside the grammar file in the <code>Grammar</code> folder is a <a href="https://github.com/python/cpython/blob/master/Grammar/Tokens"><code>Tokens</code></a> file, which contains each of the unique types found as a leaf node in a parse tree. We will cover parser trees in depth later.
Each token also has a name and a generated unique ID. The names are used to make it simpler to refer to in the tokenizer.</p>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> The <code>Tokens</code> file is a new feature in Python 3.8.</p>
</div>
<p>For example, the left parenthesis is called <code>LPAR</code>, and semicolons are called <code>SEMI</code>. You&rsquo;ll see these tokens later in the article:</p>
<div class="highlight text"><pre><span></span><code>LPAR                    &#39;(&#39;
RPAR                    &#39;)&#39;
LSQB                    &#39;[&#39;
RSQB                    &#39;]&#39;
COLON                   &#39;:&#39;
COMMA                   &#39;,&#39;
SEMI                    &#39;;&#39;
</code></pre></div>
<p>As with the <code>Grammar</code> file, if you change the <code>Tokens</code> file, you need to run <code>pgen</code> again. </p>
<p>To see tokens in action, you can use the <code>tokenize</code> module in CPython. Create a simple Python script called <code>test_tokens.py</code>:</p>
<div class="highlight python"><pre><span></span><code><span class="c1"># Hello world!</span>
<span class="k">def</span> <span class="nf">my_function</span><span class="p">():</span>
   <span class="n">proceed</span>
</code></pre></div>
<div class="alert alert-primary" role="alert">
<p>For the rest of this tutorial, <code>./python.exe</code> will refer to the compiled version of CPython. However, the actual command will depend on your system.</p>
<p>For Windows:</p>
<div class="highlight sh"><pre><span></span><code><span class="go"> &gt; python.exe</span>
</code></pre></div>
<p>For Linux:</p>
<div class="highlight sh"><pre><span></span><code><span class="go"> &gt; ./python</span>
</code></pre></div>
<p>For macOS:</p>
<div class="highlight sh"><pre><span></span><code><span class="go"> &gt; ./python.exe</span>
</code></pre></div>
</div>
<p>Then pass this file through a module built into the standard library called <code>tokenize</code>. You will see the list of tokens, by line and character. Use the <code>-e</code> flag to output the exact token name:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe -m tokenize -e test_tokens.py

<span class="go">0,0-0,0:            ENCODING       &#39;utf-8&#39;        </span>
<span class="go">1,0-1,14:           COMMENT        &#39;# Hello world!&#39;</span>
<span class="go">1,14-1,15:          NL             &#39;\n&#39;           </span>
<span class="go">2,0-2,3:            NAME           &#39;def&#39;          </span>
<span class="go">2,4-2,15:           NAME           &#39;my_function&#39;  </span>
<span class="go">2,15-2,16:          LPAR           &#39;(&#39;            </span>
<span class="go">2,16-2,17:          RPAR           &#39;)&#39;            </span>
<span class="go">2,17-2,18:          COLON          &#39;:&#39;            </span>
<span class="go">2,18-2,19:          NEWLINE        &#39;\n&#39;           </span>
<span class="go">3,0-3,3:            INDENT         &#39;   &#39;          </span>
<span class="go">3,3-3,7:            NAME           &#39;proceed&#39;         </span>
<span class="go">3,7-3,8:            NEWLINE        &#39;\n&#39;           </span>
<span class="go">4,0-4,0:            DEDENT         &#39;&#39;             </span>
<span class="go">4,0-4,0:            ENDMARKER      &#39;&#39;              </span>
</code></pre></div>
<p>In the output, the first column is the range of the line/column coordinates, the second column is the name of the token, and the final column is the value of the token.</p>
<p>In the output, the <code>tokenize</code> module has implied some tokens that were not in the file. The <code>ENCODING</code> token for <code>utf-8</code>, and a blank line at the end, giving <code>DEDENT</code> to close the function declaration and an <code>ENDMARKER</code> to end the file.</p>
<p>It is best practice to have a blank line at the end of your Python source files. If you omit it, CPython adds it for you, with a tiny performance penalty.</p>
<p>The <code>tokenize</code> module is written in pure Python and is located in <a href="https://github.com/python/cpython/blob/master/Lib/tokenize.py"><code>Lib/tokenize.py</code></a> within the CPython source code.</p>
<div class="alert alert-primary" role="alert">
<p><strong>Important:</strong> There are two tokenizers in the CPython source code: one written in Python, demonstrated here, and another written in C.
The tokenizer written in Python is meant as a utility, and the one written in C is used by the Python compiler. They have identical output and behavior. The version written in C is designed for performance and the module in Python is designed for debugging.</p>
</div>
<p>To see a verbose readout of the C tokenizer, you can run Python with the <code>-d</code> flag. Using the <code>test_tokens.py</code> script you created earlier, run it with the following:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe -d test_tokens.py

<span class="go">Token NAME/&#39;def&#39; ... It&#39;s a keyword</span>
<span class="go"> DFA &#39;file_input&#39;, state 0: Push &#39;stmt&#39;</span>
<span class="go"> DFA &#39;stmt&#39;, state 0: Push &#39;compound_stmt&#39;</span>
<span class="go"> DFA &#39;compound_stmt&#39;, state 0: Push &#39;funcdef&#39;</span>
<span class="go"> DFA &#39;funcdef&#39;, state 0: Shift.</span>
<span class="go">Token NAME/&#39;my_function&#39; ... It&#39;s a token we know</span>
<span class="go"> DFA &#39;funcdef&#39;, state 1: Shift.</span>
<span class="go">Token LPAR/&#39;(&#39; ... It&#39;s a token we know</span>
<span class="go"> DFA &#39;funcdef&#39;, state 2: Push &#39;parameters&#39;</span>
<span class="go"> DFA &#39;parameters&#39;, state 0: Shift.</span>
<span class="go">Token RPAR/&#39;)&#39; ... It&#39;s a token we know</span>
<span class="go"> DFA &#39;parameters&#39;, state 1: Shift.</span>
<span class="go">  DFA &#39;parameters&#39;, state 2: Direct pop.</span>
<span class="go">Token COLON/&#39;:&#39; ... It&#39;s a token we know</span>
<span class="go"> DFA &#39;funcdef&#39;, state 3: Shift.</span>
<span class="go">Token NEWLINE/&#39;&#39; ... It&#39;s a token we know</span>
<span class="go"> DFA &#39;funcdef&#39;, state 5: [switch func_body_suite to suite] Push &#39;suite&#39;</span>
<span class="go"> DFA &#39;suite&#39;, state 0: Shift.</span>
<span class="go">Token INDENT/&#39;&#39; ... It&#39;s a token we know</span>
<span class="go"> DFA &#39;suite&#39;, state 1: Shift.</span>
<span class="hll"><span class="go">Token NAME/&#39;proceed&#39; ... It&#39;s a keyword</span>
</span><span class="go"> DFA &#39;suite&#39;, state 3: Push &#39;stmt&#39;</span>
<span class="go">...</span>
<span class="go">  ACCEPT.</span>
</code></pre></div>
<p>In the output, you can see that it highlighted <code>proceed</code> as a keyword. In the next chapter, we&rsquo;ll see how executing the Python binary gets to the tokenizer and what happens from there to execute your code.</p>
<p>Now that you have an overview of the Python grammar and the relationship between tokens and statements, there is a way to convert the <code>pgen</code> output into an interactive graph.</p>
<p>Here is a screenshot of the Python 3.8a2 grammar:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-12_at_2.31.16_pm.f36c3e99b8b4.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-03-12_at_2.31.16_pm.f36c3e99b8b4.png" width="3258" height="2248" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-12_at_2.31.16_pm.f36c3e99b8b4.png&amp;w=814&amp;sig=21666b4228a46a6bcc7aeca6d5263e62a3aeb6d5 814w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-12_at_2.31.16_pm.f36c3e99b8b4.png&amp;w=1629&amp;sig=01404157eddc09548f8cf7d4e995da9806c36fac 1629w, https://files.realpython.com/media/Screen_Shot_2019-03-12_at_2.31.16_pm.f36c3e99b8b4.png 3258w" sizes="75vw" alt="Python 3.8 DFA node graph" data-asset="1221" /></a></figure>
<p>The Python package used to generate this graph, <code>instaviz</code>, will be covered in a later chapter.</p>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section></section><section class="section3" id="memory-management-in-cpython"><h3>Memory Management in CPython<a class="headerlink" href="#memory-management-in-cpython" title="Permanent link"></a></h3>
<p>Throughout this article, you will see references to a <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pyarena.c#L128"><code>PyArena</code></a> object. The arena is one of CPython&rsquo;s memory management structures. The code is within <code>Python/pyarena.c</code> and contains a wrapper around C&rsquo;s memory allocation and deallocation functions.</p>
<p>In a traditionally written C program, the developer <em>should</em> allocate memory for data structures before writing into that data. This allocation marks the memory as belonging to the process with the operating system.</p>
<p>It is also up to the developer to deallocate, or &ldquo;free,&rdquo; the allocated memory when its no longer being used and return it to the operating system&rsquo;s block table of free memory.
If a process allocates memory for a variable, say within a function or loop, when that function has completed, the memory is not automatically given back to the operating system in C. So if it hasn&rsquo;t been explicitly deallocated in the C code, it causes a memory leak. The process will continue to take more memory each time that function runs until eventually, the system runs out of memory, and crashes!</p>
<p>Python takes that responsibility away from the programmer and uses two algorithms: <a href="https://realpython.com/python-memory-management/">a reference counter and a garbage collector</a>.</p>
<p>Whenever an interpreter is instantiated, a <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pyarena.c#L128"><code>PyArena</code></a> is created and attached one of the fields in the interpreter. During the lifecycle of a CPython interpreter, many arenas could be allocated. They are connected with a <a href="https://realpython.com/linked-lists-python/">linked list</a>. The arena stores a list of pointers to Python Objects as a <code>PyListObject</code>. Whenever a new Python object is created, a pointer to it is added using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pyarena.c#L203"><code>PyArena_AddPyObject()</code></a>. This function call stores a pointer in the arena&rsquo;s list, <code>a_objects</code>.</p>
<div class="alert alert-primary" role="alert">
<p>Even though Python doesn&rsquo;t have pointers, there are some <a href="https://realpython.com/pointers-in-python/">interesting techniques</a> to simulate the behavior of pointers.</p>
</div>
<p>The <code>PyArena</code> serves a second function, which is to allocate and reference a list of raw memory blocks. For example, a <code>PyList</code> would need extra memory if you added thousands of additional values. The <code>PyList</code> object&rsquo;s C code does not allocate memory directly. The object gets raw blocks of memory from the <code>PyArena</code> by calling <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pyarena.c#L180"><code>PyArena_Malloc()</code></a> from the <code>PyObject</code> with the required memory size. This task is completed by another abstraction in <code>Objects/obmalloc.c</code>. In the object allocation module, memory can be allocated, freed, and reallocated for a Python Object.</p>
<p>A linked list of allocated blocks is stored inside the arena, so that when an interpreter is stopped, all managed memory blocks can be deallocated in one go using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pyarena.c#L157"><code>PyArena_Free()</code></a>.</p>
<p>Take the <code>PyListObject</code> example. If you were to <a href="https://realpython.com/python-append/"><code>.append()</code></a> an object to the end of a Python list, you don&rsquo;t need to reallocate the memory used in the existing list beforehand. The <code>.append()</code> method calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/listobject.c#L36"><code>list_resize()</code></a> which handles memory allocation for lists. Each list object keeps a list of the amount of memory allocated. If the item you&rsquo;re appending will fit inside the existing free memory, it is simply added. If the list needs more memory space, it is expanded. Lists are expanded in length as 0, 4, 8, 16, 25, 35, 46, 58, 72, 88.</p>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/obmalloc.c#L618"><code>PyMem_Realloc()</code></a> is called to expand the memory allocated in a list. <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/obmalloc.c#L618"><code>PyMem_Realloc()</code></a> is an API wrapper for <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/obmalloc.c#L1913"><code>pymalloc_realloc()</code></a>.</p>
<p>Python also has a special wrapper for the C call <code>malloc()</code>, which sets the max size of the memory allocation to help prevent buffer overflow errors (See <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Modules/overlapped.c#L28"><code>PyMem_RawMalloc()</code></a>).</p>
<p>In summary: </p>
<ul>
<li>Allocation of raw memory blocks is done via <code>PyMem_RawAlloc()</code>.</li>
<li>The pointers to Python objects are stored within the <code>PyArena</code>.</li>
<li><code>PyArena</code> also stores a linked-list of allocated memory blocks.</li>
</ul>
<p>More information on the API is detailed on the <a href="https://docs.python.org/3/c-api/memory.html">CPython documentation</a>.</p>
<section class="section4" id="reference-counting"><h4>Reference Counting<a class="headerlink" href="#reference-counting" title="Permanent link"></a></h4>
<p>To create a variable in Python, you have to assign a value to a <em>uniquely</em> named variable:</p>
<div class="highlight python"><pre><span></span><code><span class="n">my_variable</span> <span class="o">=</span> <span class="mi">180392</span>
</code></pre></div>
<p>Whenever a value is assigned to a variable in Python, the name of the variable is checked within the locals and globals scope to see if it already exists.</p>
<p>Because <code>my_variable</code> is not already within the <code>locals()</code> or <code>globals()</code> dictionary, this new object is created, and the value is assigned as being the numeric constant <code>180392</code>.</p>
<p>There is now one reference to <code>my_variable</code>, so the reference counter for <code>my_variable</code> is incremented by 1. </p>
<p>You will see function calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L239"><code>Py_INCREF()</code></a> and <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L245"><code>Py_DECREF()</code></a> throughout the C source code for CPython. These functions increment and decrement the count of references to that object.</p>
<p>References to an object are decremented when a variable falls outside of the scope in which it was declared. Scope in Python can refer to a function or method, a comprehension, or a <a href="https://realpython.com/python-lambda/">lambda function</a>. These are some of the more literal scopes, but there are many other implicit scopes, like passing variables to a function call.</p>
<p>The handling of incrementing and decrementing references based on the language is built into the CPython compiler and the core execution loop, <code>ceval.c</code>, which we will cover in detail later in this article.</p>
<p>Whenever <code>Py_DECREF()</code> is called, and the counter becomes 0, the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/obmalloc.c#L707"><code>PyObject_Free()</code></a> function is called. For that object <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pyarena.c#L157"><code>PyArena_Free()</code></a> is called for all of the memory that was allocated. </p>
</section><section class="section4" id="garbage-collection"><h4>Garbage Collection<a class="headerlink" href="#garbage-collection" title="Permanent link"></a></h4>
<p>How often does your garbage get collected? Weekly, or fortnightly? </p>
<p>When you&rsquo;re finished with something, you discard it and throw it in the trash. But that trash won&rsquo;t get collected straight away. You need to wait for the garbage trucks to come and pick it up.</p>
<p>CPython has the same principle, using a garbage collection algorithm. CPython&rsquo;s garbage collector is enabled by default, happens in the background and works to deallocate memory that&rsquo;s been used for objects which are no longer in use.</p>
<p>Because the garbage collection algorithm is a lot more complex than the reference counter, it doesn&rsquo;t happen all the time, otherwise, it would consume a huge amount of CPU resources. It happens periodically, after a set number of operations.</p>
<p>CPython&rsquo;s standard library comes with a Python module to interface with the arena and the garbage collector, the <code>gc</code> module. Here&rsquo;s how to use the <code>gc</code> module in debug mode:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">gc</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gc</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_STATS</span><span class="p">)</span>
</code></pre></div>
<p>This will print the statistics whenever the garbage collector is run.</p>
<p>You can get the threshold after which the garbage collector is run by calling <code>get_threshold()</code>:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gc</span><span class="o">.</span><span class="n">get_threshold</span><span class="p">()</span>
<span class="go">(700, 10, 10)</span>
</code></pre></div>
<p>You can also get the current threshold counts:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gc</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span>
<span class="go">(688, 1, 1)</span>
</code></pre></div>
<p>Lastly, you can run the collection algorithm manually:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="go">24</span>
</code></pre></div>
<p>This will call <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Modules/gcmodule.c#L987"><code>collect()</code></a> inside the <code>Modules/gcmodule.c</code> file which contains the implementation of the garbage collector algorithm.</p>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section></section><section class="section3" id="conclusion"><h3>Conclusion<a class="headerlink" href="#conclusion" title="Permanent link"></a></h3>
<p>In Part 1, you covered the structure of the source code repository, how to compile from source, and the Python language specification. These core concepts will be critical in Part 2 as you dive deeper into the Python interpreter process.</p>
</section></section><section class="section2" h1="h1" id="part-2-the-python-interpreter-process"><h2>Part 2: The Python Interpreter Process<a class="headerlink" href="#part-2-the-python-interpreter-process" title="Permanent link"></a></h2>
<p>Now that you&rsquo;ve seen the Python grammar and memory management, you can follow the process from typing <code>python</code> to the part where your code is executed.</p>
<p>There are five ways the <code>python</code> binary can be called:</p>
<ol>
<li>To run a single command with <code>-c</code> and a Python command</li>
<li>To start a module with <code>-m</code> and the name of a module</li>
<li>To run a file with the filename</li>
<li>To run the <code>stdin</code> input using a shell pipe</li>
<li>To start the REPL and execute commands one at a time</li>
</ol>
<div class="alert alert-primary" role="alert">
<p>Python has so many ways to execute scripts, it can be a little overwhelming. Darren Jones has put together a <a href="https://realpython.com/courses/running-python-scripts/">great course on running Python scripts</a> if you want to learn more.</p>
</div>
<p>The three source files you need to inspect to see this process are:</p>
<ol>
<li><strong><code>Programs/python.c</code></strong> is a simple entry point.</li>
<li><strong><code>Modules/main.c</code></strong> contains the code to bring together the whole process, loading configuration, executing code and clearing up memory.</li>
<li><strong><code>Python/initconfig.c</code></strong> loads the configuration from the system environment and merges it with any command-line flags.</li>
</ol>
<p>This diagram shows how each of those functions is called:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png" width="1046" height="851" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png&amp;w=261&amp;sig=8aa36cedaf32be0236896cce2c32b6c4c4ec7e05 261w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png&amp;w=523&amp;sig=a447b53d2afa96dfd204b9265c8b439bd71272d7 523w, https://files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png 1046w" sizes="75vw" alt="Python run swim lane diagram" data-asset="1222" /></a></figure>
<p>The execution mode is determined from the configuration.</p>
<div class="alert alert-primary" role="alert">
<p><strong>The CPython source code style:</strong></p>
<p>Similar to the <a href="https://realpython.com/courses/writing-beautiful-python-code-pep-8/">PEP8 style guide for Python code</a>, there is an <a href="https://www.python.org/dev/peps/pep-0007/">official style guide</a> for the CPython C code, designed originally in 2001 and updated for modern versions. </p>
<p>There are some naming standards which help when navigating the source code:</p>
<ul>
<li>
<p>Use a <code>Py</code> prefix for public functions, never for static functions. The <code>Py_</code> prefix is reserved for global service routines like <code>Py_FatalError</code>. Specific groups of routines (like specific object type APIs) use a longer prefix, such as <code>PyString_</code> for string functions.</p>
</li>
<li>
<p>Public functions and variables use MixedCase with underscores, like this: <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L924"><code>PyObject_GetAttr</code></a>, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/modsupport.h#L20"><code>Py_BuildValue</code></a>, <code>PyExc_TypeError</code>.</p>
</li>
<li>
<p>Occasionally an &ldquo;internal&rdquo; function has to be visible to the loader. We use the <code>_Py</code> prefix for this, for example, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L464"><code>_PyObject_Dump</code></a>.</p>
</li>
<li>
<p>Macros should have a MixedCase prefix and then use upper case, for example <code>PyString_AS_STRING</code>, <code>Py_PRINT_RAW</code>.</p>
</li>
</ul>
</div>
<section class="section3" id="establishing-runtime-configuration"><h3>Establishing Runtime Configuration<a class="headerlink" href="#establishing-runtime-configuration" title="Permanent link"></a></h3>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png" width="1046" height="851" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png&amp;w=261&amp;sig=8aa36cedaf32be0236896cce2c32b6c4c4ec7e05 261w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png&amp;w=523&amp;sig=a447b53d2afa96dfd204b9265c8b439bd71272d7 523w, https://files.realpython.com/media/swim-lanes-chart-1.9fb3000aad85.png 1046w" sizes="75vw" alt="Python run swim lane diagram" data-asset="1222" /></a></figure>
<p>In the swimlanes, you can see that before any Python code is executed, the runtime first establishes the configuration.
The configuration of the runtime is a data structure defined in <code>Include/cpython/initconfig.h</code> named <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/cpython/initconfig.h#L407"><code>PyConfig</code></a>.</p>
<p>The configuration data structure includes things like:</p>
<ul>
<li>Runtime flags for various modes like debug and optimized mode</li>
<li>The execution mode, such as whether a filename was passed, <code>stdin</code> was provided or a module name</li>
<li>Extended option, specified by <code>-X &lt;option&gt;</code></li>
<li>Environment variables for runtime settings</li>
</ul>
<p>The configuration data is primarily used by the CPython runtime to enable and disable various features.</p>
<p>Python also comes with several <a href="https://docs.python.org/3/using/cmdline.html">Command Line Interface Options</a>. In Python you can enable verbose mode with the <code>-v</code> flag. In verbose mode, Python will print messages to the screen when modules are loaded:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe -v -c <span class="s2">&quot;print(&#39;hello world&#39;)&quot;</span>


<span class="gp"># </span>installing zipimport hook
<span class="go">import zipimport # builtin</span>
<span class="gp"># </span>installed zipimport hook
<span class="go">...</span>
</code></pre></div>
<p>You will see a hundred lines or more with all the imports of your user site-packages and anything else in the system environment.</p>
<p>You can see the definition of this flag within <code>Include/cpython/initconfig.h</code> inside the <code>struct</code> for <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/cpython/initconfig.h#L407"><code>PyConfig</code></a>:</p>
<div class="highlight c"><pre><span></span><code><span class="cm">/* --- PyConfig ---------------------------------------------- */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">_config_version</span><span class="p">;</span>  <span class="cm">/* Internal configuration version,</span>
<span class="cm">                             used for ABI compatibility */</span>
    <span class="kt">int</span> <span class="n">_config_init</span><span class="p">;</span>     <span class="cm">/* _PyConfigInitEnum value */</span>

    <span class="p">...</span>

    <span class="cm">/* If greater than 0, enable the verbose mode: print a message each time a</span>
<span class="cm">       module is initialized, showing the place (filename or built-in module)</span>
<span class="cm">       from which it is loaded.</span>

<span class="cm">       If greater or equal to 2, print a message for each file that is checked</span>
<span class="cm">       for when searching for a module. Also provides information on module</span>
<span class="cm">       cleanup at exit.</span>

<span class="cm">       Incremented by the -v option. Set by the PYTHONVERBOSE environment</span>
<span class="cm">       variable. If set to -1 (default), inherit Py_VerboseFlag value. */</span>
    <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
</code></pre></div>
<p>In <code>Python/initconfig.c</code>, the logic for reading settings from environment variables and runtime command-line flags is established.</p>
<p>In the <code>config_read_env_vars</code> function, the environment variables are read and used to assign the values for the configuration settings:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyStatus</span>
<span class="n">config_read_env_vars</span><span class="p">(</span><span class="n">PyConfig</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyStatus</span> <span class="n">status</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">use_env</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">use_environment</span><span class="p">;</span>

    <span class="cm">/* Get environment variables */</span>
<span class="hll">    <span class="n">_Py_get_env_flag</span><span class="p">(</span><span class="n">use_env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">parser_debug</span><span class="p">,</span> <span class="s">&quot;PYTHONDEBUG&quot;</span><span class="p">);</span>
</span>    <span class="n">_Py_get_env_flag</span><span class="p">(</span><span class="n">use_env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="s">&quot;PYTHONVERBOSE&quot;</span><span class="p">);</span>
    <span class="n">_Py_get_env_flag</span><span class="p">(</span><span class="n">use_env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">optimization_level</span><span class="p">,</span> <span class="s">&quot;PYTHONOPTIMIZE&quot;</span><span class="p">);</span>
    <span class="n">_Py_get_env_flag</span><span class="p">(</span><span class="n">use_env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inspect</span><span class="p">,</span> <span class="s">&quot;PYTHONINSPECT&quot;</span><span class="p">);</span>
</code></pre></div>
<p>For the verbose setting, you can see that the value of <code>PYTHONVERBOSE</code> is used to set the value of <code>&amp;config-&gt;verbose</code>, if <code>PYTHONVERBOSE</code> is found. If the environment variable does not exist, then the default value of <code>-1</code> will remain.</p>
<p>Then in <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/initconfig.c#L1828"><code>config_parse_cmdline</code></a> within <code>initconfig.c</code> again, the command-line flag is used to set the value, if provided:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyStatus</span>
<span class="n">config_parse_cmdline</span><span class="p">(</span><span class="n">PyConfig</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="n">PyWideStringList</span> <span class="o">*</span><span class="n">warnoptions</span><span class="p">,</span>
                     <span class="n">Py_ssize_t</span> <span class="o">*</span><span class="n">opt_index</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>

        <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
<span class="hll">            <span class="n">config</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="o">++</span><span class="p">;</span>
</span>            <span class="k">break</span><span class="p">;</span>
<span class="p">...</span>
        <span class="cm">/* This space reserved for other options */</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="cm">/* unknown argument: parsing failed */</span>
            <span class="n">config_usage</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">program</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">_PyStatus_EXIT</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<p>This value is later copied to a global variable <code>Py_VerboseFlag</code> by the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/initconfig.c#L134"><code>_Py_GetGlobalVariablesAsDict</code></a> function.</p>
<p>Within a Python session, you can access the runtime flags, like verbose mode, quiet mode, using the <code>sys.flags</code> named tuple.
The <code>-X</code> flags are all available inside the <code>sys._xoptions</code> dictionary:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="go">$ ./python.exe -X dev -q       </span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">flags</span>
<span class="go">sys.flags(debug=0, inspect=0, interactive=0, optimize=0, dont_write_bytecode=0, </span>
<span class="go"> no_user_site=0, no_site=0, ignore_environment=0, verbose=0, bytes_warning=0, </span>
<span class="go"> quiet=1, hash_randomization=1, isolated=0, dev_mode=True, utf8_mode=0)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">_xoptions</span>
<span class="go">{&#39;dev&#39;: True}</span>
</code></pre></div>
<p>As well as the runtime configuration in <code>initconfig.h</code>, there is also the build configuration, which is located inside <code>pyconfig.h</code> in the root folder. This file is created dynamically in the <code>configure</code> step in the build process, or by Visual Studio for Windows systems.</p>
<p>You can see the build configuration by running:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe -m sysconfig
</code></pre></div>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section><section class="section3" id="reading-filesinput"><h3>Reading Files/Input<a class="headerlink" href="#reading-filesinput" title="Permanent link"></a></h3>
<p>Once CPython has the runtime configuration and the command-line arguments, it can establish what it needs to execute.</p>
<p>This task is handled by the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Modules/main.c#L665"><code>pymain_main</code></a> function inside <code>Modules/main.c</code>. Depending on the newly created <code>config</code> instance, CPython will now execute code provided via several options.</p>
<section class="section4" id="input-via-c"><h4>Input via <code>-c</code><a class="headerlink" href="#input-via-c" title="Permanent link"></a></h4>
<p>The simplest is providing CPython a command with the <code>-c</code> option and a Python program inside quotes.</p>
<p>For example:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe -c <span class="s2">&quot;print(&#39;hi&#39;)&quot;</span>
<span class="go">hi</span>
</code></pre></div>
<p>Here is the full flowchart of how this happens:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/pymain_run_command.f5da561ba7d5.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/pymain_run_command.f5da561ba7d5.png" width="1041" height="751" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/pymain_run_command.f5da561ba7d5.png&amp;w=260&amp;sig=f7f802b23e900bf42b29804ee80ed0dd0eaec6a4 260w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/pymain_run_command.f5da561ba7d5.png&amp;w=520&amp;sig=3079060f305945fd3556ce7cd453fac965a6ec27 520w, https://files.realpython.com/media/pymain_run_command.f5da561ba7d5.png 1041w" sizes="75vw" alt="Flow chart of pymain_run_command" data-asset="1235" /></a></figure>
<p>First, the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Modules/main.c#L240"><code>pymain_run_command()</code></a> function is executed inside <code>Modules/main.c</code> taking the command passed in <code>-c</code> as an argument in the C type <code>wchar_t*</code>. The <code>wchar_t*</code> type is often used as a low-level storage type for <a href="https://realpython.com/python-encodings-guide/">Unicode</a> data across CPython as the size of the type can store UTF8 characters.</p>
<p>When converting the <code>wchar_t*</code> to a Python string, the <code>Objects/unicodeobject.c</code> file has a helper function <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/unicodeobject.c#L2088"><code>PyUnicode_FromWideChar()</code></a> that returns a <code>PyObject</code>, of type <code>str</code>. The encoding to UTF8 is then done by <code>PyUnicode_AsUTF8String()</code> on the Python <code>str</code> object to convert it to a Python <code>bytes</code> object. </p>
<p>Once this is complete, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Modules/main.c#L240"><code>pymain_run_command()</code></a> will then pass the Python bytes object to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L453"><code>PyRun_SimpleStringFlags()</code></a> for execution, but first converting the <code>bytes</code> to a <code>str</code> type again:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">pymain_run_command</span><span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">cf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">unicode</span><span class="p">,</span> <span class="o">*</span><span class="n">bytes</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">unicode</span> <span class="o">=</span> <span class="n">PyUnicode_FromWideChar</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unicode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PySys_Audit</span><span class="p">(</span><span class="s">&quot;cpython.run_command&quot;</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">pymain_exit_err_print</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">bytes</span> <span class="o">=</span> <span class="n">PyUnicode_AsUTF8String</span><span class="p">(</span><span class="n">unicode</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">unicode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">PyRun_SimpleStringFlags</span><span class="p">(</span><span class="n">PyBytes_AsString</span><span class="p">(</span><span class="n">bytes</span><span class="p">),</span> <span class="n">cf</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error</span><span class="p">:</span>
    <span class="n">PySys_WriteStderr</span><span class="p">(</span><span class="s">&quot;Unable to decode the command from the command line:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">pymain_exit_err_print</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>The conversion of <code>wchar_t*</code> to Unicode, bytes, and then a string is roughly equivalent to the following:</p>
<div class="highlight python"><pre><span></span><code><span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="n">bytes_</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">unicode</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
<span class="c1"># call PyRun_SimpleStringFlags with bytes_</span>
</code></pre></div>
<p>The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L453"><code>PyRun_SimpleStringFlags()</code></a> function is part of <code>Python/pythonrun.c</code>. It&rsquo;s purpose is to turn this simple command into a Python module and then send it on to be executed.
Since a Python module needs to have <code>__main__</code> to be executed as a standalone module, it creates that automatically:</p>
<div class="highlight c"><pre><span></span><code><span class="kt">int</span>
<span class="nf">PyRun_SimpleStringFlags</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
<span class="hll">    <span class="n">m</span> <span class="o">=</span> <span class="n">PyImport_AddModule</span><span class="p">(</span><span class="s">&quot;__main__&quot;</span><span class="p">);</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
<span class="hll">    <span class="n">d</span> <span class="o">=</span> <span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span><span class="hll">    <span class="n">v</span> <span class="o">=</span> <span class="n">PyRun_StringFlags</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">Py_file_input</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_Print</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Once <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L453"><code>PyRun_SimpleStringFlags()</code></a> has created a module and a dictionary, it calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1008"><code>PyRun_StringFlags()</code></a>, which creates a fake filename and then calls the Python parser to create an AST from the string and return a module, <code>mod</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyRun_StringFlags</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span>
                  <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">PyParser_ASTFromStringObject</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mod</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">run_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
    <span class="n">PyArena_Free</span><span class="p">(</span><span class="n">arena</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</code></pre></div>
<p>You&rsquo;ll dive into the AST and Parser code in the next section.</p>
</section><section class="section4" id="input-via-m"><h4>Input via <code>-m</code><a class="headerlink" href="#input-via-m" title="Permanent link"></a></h4>
<p>Another way to execute Python commands is by using the <code>-m</code> option with the name of a module.
A typical example is <code>python -m unittest</code> to run the unittest module in the standard library.</p>
<p>Being able to execute modules as scripts were initially proposed in <a href="https://www.python.org/dev/peps/pep-0338">PEP 338</a> and then the standard for explicit relative imports defined in <a href="https://www.python.org/dev/peps/pep-0366">PEP366</a>. </p>
<p>The use of the <code>-m</code> flag implies that within the module package, you want to execute whatever is inside <a href="https://realpython.com/python-main-function/"><code>__main__</code></a>. It also implies that you want to search <code>sys.path</code> for the named module.</p>
<p>This search mechanism is why you don&rsquo;t need to remember where the <code>unittest</code> module is stored on your filesystem.</p>
<p>Inside <code>Modules/main.c</code> there is a function called when the command-line is run with the <code>-m</code> flag. The name of the module is passed as the <code>modname</code> argument.</p>
<p>CPython will then import a standard library module, <code>runpy</code> and execute it using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/call.c#L214"><code>PyObject_Call()</code></a>. The import is done using the C API function <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/import.c#L1409"><code>PyImport_ImportModule()</code></a>, found within the <code>Python/import.c</code> file:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">pymain_run_module</span><span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">modname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set_argv0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="o">*</span><span class="n">runpy</span><span class="p">,</span> <span class="o">*</span><span class="n">runmodule</span><span class="p">,</span> <span class="o">*</span><span class="n">runargs</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
    <span class="n">runpy</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&quot;runpy&quot;</span><span class="p">);</span>
 <span class="p">...</span>
    <span class="n">runmodule</span> <span class="o">=</span> <span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">runpy</span><span class="p">,</span> <span class="s">&quot;_run_module_as_main&quot;</span><span class="p">);</span>
 <span class="p">...</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">PyUnicode_FromWideChar</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">modname</span><span class="p">));</span>
 <span class="p">...</span>
    <span class="n">runargs</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;(Oi)&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">set_argv0</span><span class="p">);</span>
 <span class="p">...</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">PyObject_Call</span><span class="p">(</span><span class="n">runmodule</span><span class="p">,</span> <span class="n">runargs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">pymain_exit_err_print</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>In this function you&rsquo;ll also see 2 other C API functions: <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/call.c#L214"><code>PyObject_Call()</code></a> and <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L831"><code>PyObject_GetAttrString()</code></a>. Because <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/import.c#L1409"><code>PyImport_ImportModule()</code></a> returns a <code>PyObject*</code>, the core object type, you need to call special functions to get attributes and to call it.</p>
<p>In Python, if you had an object and wanted to get an attribute, then you could call <code>getattr()</code>. In the C API, this call is <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L831"><code>PyObject_GetAttrString()</code></a>, which is found in <code>Objects/object.c</code>. If you wanted to run a callable, you would give it parentheses, or you can run the <code>__call__()</code> property on any Python object. The <code>__call__()</code> method is implemented inside <code>Objects/object.c</code>:</p>
<div class="highlight python"><pre><span></span><code><span class="n">hi</span> <span class="o">=</span> <span class="s2">&quot;hi!&quot;</span>
<span class="n">hi</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">hi</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="fm">__call__</span><span class="p">()</span>  <span class="c1"># this is the same</span>
</code></pre></div>
<p>The <code>runpy</code> module is written in pure Python and located in <code>Lib/runpy.py</code>.</p>
<p>Executing <code>python -m &lt;module&gt;</code> is equivalent to running <code>python -m runpy &lt;module&gt;</code>. The <code>runpy</code> module was created to abstract the process of locating and executing modules on an operating system.</p>
<p><code>runpy</code> does a few things to run the target module:</p>
<ul>
<li>Calls <code>__import__()</code> for the module name you provided</li>
<li>Sets <code>__name__</code> (the module name) to a namespace called <code>__main__</code></li>
<li>Executes the module within the <code>__main__</code> namespace</li>
</ul>
<p>The <code>runpy</code> module also supports executing directories and zip files.</p>
</section><section class="section4" id="input-via-filename"><h4>Input via Filename<a class="headerlink" href="#input-via-filename" title="Permanent link"></a></h4>
<p>If the first argument to <code>python</code> was a filename, such as <code>python test.py</code>, then CPython will open a file handle, similar to using <code>open()</code> in Python and pass the handle to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L372"><code>PyRun_SimpleFileExFlags()</code></a> inside <code>Python/pythonrun.c</code>.</p>
<p>There are 3 paths this function can take:</p>
<ol>
<li>If the file path is a <code>.pyc</code> file, it will call <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1145"><code>run_pyc_file()</code></a>.</li>
<li>If the file path is a script file (<code>.py</code>) it will run <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1032"><code>PyRun_FileExFlags()</code></a>.</li>
<li>If the filepath is <code>stdin</code> because the user ran <code>command | python</code> then treat <code>stdin</code> as a file handle and run <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1032"><code>PyRun_FileExFlags()</code></a>.</li>
</ol>
<div class="highlight c"><pre><span></span><code><span class="kt">int</span>
<span class="nf">PyRun_SimpleFileExFlags</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">closeit</span><span class="p">,</span>
                        <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">PyImport_AddModule</span><span class="p">(</span><span class="s">&quot;__main__&quot;</span><span class="p">);</span>
 <span class="p">...</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">maybe_pyc_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">closeit</span><span class="p">))</span> <span class="p">{</span>
</span> <span class="p">...</span>
<span class="hll">        <span class="n">v</span> <span class="o">=</span> <span class="n">run_pyc_file</span><span class="p">(</span><span class="n">pyc_fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* When running from stdin, leave __main__.__loader__ alone */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="n">set_main_loader</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;SourceFileLoader&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;python: failed to set __main__.__loader__</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
        <span class="p">}</span>
<span class="hll">        <span class="n">v</span> <span class="o">=</span> <span class="n">PyRun_FileExFlags</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">Py_file_input</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
</span><span class="hll">                              <span class="n">closeit</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span>    <span class="p">}</span>
 <span class="p">...</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="input-via-file-with-pyrun_fileexflags"><h4>Input via File With <code>PyRun_FileExFlags()</code><a class="headerlink" href="#input-via-file-with-pyrun_fileexflags" title="Permanent link"></a></h4>
<p>For <code>stdin</code> and basic script files, CPython will pass the file handle to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1032"><code>PyRun_FileExFlags()</code></a> located in the <code>pythonrun.c</code> file.</p>
<p>The purpose of <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1032"><code>PyRun_FileExFlags()</code></a> is similar to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L453"><code>PyRun_SimpleStringFlags()</code></a> used for the <code>-c</code> input. CPython will load the file handle into <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1369"><code>PyParser_ASTFromFileObject()</code></a>. We&rsquo;ll cover the Parser and AST modules in the next section.
Because this is a full script, it doesn&rsquo;t need the <code>PyImport_AddModule("__main__");</code> step used by <code>-c</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyRun_FileExFlags</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename_str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span>
                  <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span> <span class="kt">int</span> <span class="n">closeit</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">PyParser_ASTFromFileObject</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                     <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
 <span class="p">...</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">run_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Identical to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L453"><code>PyRun_SimpleStringFlags()</code></a>, once <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1032"><code>PyRun_FileExFlags()</code></a> has created a Python module from the file, it sent it to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1125"><code>run_mod()</code></a> to be executed.</p>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1125"><code>run_mod()</code></a> is found within <code>Python/pythonrun.c</code>, and sends the module to the AST to be compiled into a code object. Code objects are a format used to store the bytecode operations and the format kept in <code>.pyc</code> files:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">run_mod</span><span class="p">(</span><span class="n">mod_ty</span> <span class="n">mod</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span>
            <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="n">PyArena</span> <span class="o">*</span><span class="n">arena</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">PyAST_CompileObject</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">co</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PySys_Audit</span><span class="p">(</span><span class="s">&quot;exec&quot;</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">co</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">run_eval_code_obj</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">co</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>We will cover the CPython compiler and bytecodes in the next section. The call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1094"><code>run_eval_code_obj()</code></a> is a simple wrapper function that calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L716"><code>PyEval_EvalCode()</code></a> in the <code>Python/eval.c</code> file. The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L716"><code>PyEval_EvalCode()</code></a> function is the main evaluation loop for CPython, it iterates over each bytecode statement and executes it on your local machine.</p>
</section><section class="section4" id="input-via-compiled-bytecode-with-run_pyc_file"><h4>Input via Compiled Bytecode With <code>run_pyc_file()</code><a class="headerlink" href="#input-via-compiled-bytecode-with-run_pyc_file" title="Permanent link"></a></h4>
<p>In the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L372"><code>PyRun_SimpleFileExFlags()</code></a> there was a clause for the user providing a file path to a <code>.pyc</code> file. If the file path ended in <code>.pyc</code> then instead of loading the file as a plain text file and parsing it, it will assume that the <code>.pyc</code> file contains a code object written to disk. </p>
<p>The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1145"><code>run_pyc_file()</code></a> function inside <code>Python/pythonrun.c</code> then marshals the code object from the <code>.pyc</code> file by using the file handle. <strong>Marshaling</strong> is a technical term for copying the contents of a file into memory and converting them to a specific data structure. The code object data structure on the disk is the CPython compiler&rsquo;s way to caching compiled code so that it doesn&rsquo;t need to parse it every time the script is called:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">run_pyc_file</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span>
             <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
  <span class="p">...</span>
<span class="hll">    <span class="n">v</span> <span class="o">=</span> <span class="n">PyMarshal_ReadLastObjectFromFile</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span>  <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">PyCode_Check</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_RuntimeError</span><span class="p">,</span>
                   <span class="s">&quot;Bad code object in .pyc file&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="hll">    <span class="n">co</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyCodeObject</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
</span><span class="hll">    <span class="n">v</span> <span class="o">=</span> <span class="n">run_eval_code_obj</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">);</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">flags</span><span class="o">-&gt;</span><span class="n">cf_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">PyCF_MASK</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">co</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Once the code object has been marshaled to memory, it is sent to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1094"><code>run_eval_code_obj()</code></a>, which calls <code>Python/ceval.c</code> to execute the code.</p>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section></section><section class="section3" id="lexing-and-parsing"><h3>Lexing and Parsing<a class="headerlink" href="#lexing-and-parsing" title="Permanent link"></a></h3>
<p>In the exploration of reading and executing Python files, we dived as deep as the parser and AST modules, with function calls to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1369"><code>PyParser_ASTFromFileObject()</code></a>.</p>
<p>Sticking within <code>Python/pythonrun.c</code>, the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1369"><code>PyParser_ASTFromFileObject()</code></a> function will take a file handle, compiler flags and a <code>PyArena</code> instance and convert the file object into a node object using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/parsetok.c#L163"><code>PyParser_ParseFileObject()</code></a>.</p>
<p>With the node object, it will then convert that into a module using the AST function <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L772"><code>PyAST_FromNodeObject()</code></a>:</p>
<div class="highlight c"><pre><span></span><code><span class="n">mod_ty</span>
<span class="nf">PyParser_ASTFromFileObject</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">enc</span><span class="p">,</span>
                           <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ps1</span><span class="p">,</span>
                           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ps2</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">errcode</span><span class="p">,</span>
                           <span class="n">PyArena</span> <span class="o">*</span><span class="n">arena</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="hll">    <span class="n">node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">PyParser_ParseFileObject</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span>
</span><span class="hll">                                       <span class="o">&amp;</span><span class="n">_PyParser_Grammar</span><span class="p">,</span>
</span><span class="hll">                                       <span class="n">start</span><span class="p">,</span> <span class="n">ps1</span><span class="p">,</span> <span class="n">ps2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iflags</span><span class="p">);</span>
</span>    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="n">flags</span><span class="o">-&gt;</span><span class="n">cf_flags</span> <span class="o">|=</span> <span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">PyCF_MASK</span><span class="p">;</span>
</span>        <span class="n">mod</span> <span class="o">=</span> <span class="n">PyAST_FromNodeObject</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
        <span class="n">PyNode_Free</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">mod</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>For <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/parsetok.c#L163"><code>PyParser_ParseFileObject()</code></a> we switch to <code>Parser/parsetok.c</code> and the parser-tokenizer stage of the CPython interpreter. This function has two important tasks:</p>
<ol>
<li>Instantiate a tokenizer state <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/tokenizer.h#L23"><code>tok_state</code></a> using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/tokenizer.h#L78"><code>PyTokenizer_FromFile()</code></a> in <code>Parser/tokenizer.c</code></li>
<li>Convert the tokens into a concrete parse tree (a list of <code>node</code>) using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/parsetok.c#L232"><code>parsetok()</code></a> in <code>Parser/parsetok.c</code> </li>
</ol>
<div class="highlight c"><pre><span></span><code><span class="n">node</span> <span class="o">*</span>
<span class="nf">PyParser_ParseFileObject</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
                         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">enc</span><span class="p">,</span> <span class="n">grammar</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
                         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ps1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ps2</span><span class="p">,</span>
                         <span class="n">perrdetail</span> <span class="o">*</span><span class="n">err_ret</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="k">struct</span> <span class="nc">tok_state</span> <span class="o">*</span><span class="n">tok</span><span class="p">;</span>
</span><span class="p">...</span>
<span class="hll">    <span class="k">if</span> <span class="p">((</span><span class="n">tok</span> <span class="o">=</span> <span class="n">PyTokenizer_FromFile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">ps1</span><span class="p">,</span> <span class="n">ps2</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span>        <span class="n">err_ret</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">E_NOMEM</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="hll">    <span class="k">return</span> <span class="n">parsetok</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">err_ret</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span><span class="p">}</span>
</code></pre></div>
<p><code>tok_state</code> (defined in <code>Parser/tokenizer.h</code>) is the data structure to store all temporary data generated by the tokenizer. It is returned to the parser-tokenizer as the data structure is required by <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/parsetok.c#L232"><code>parsetok()</code></a> to develop the concrete syntax tree.</p>
<p>Inside <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/parsetok.c#L232"><code>parsetok()</code></a>, it will use the <code>tok_state</code> structure and make calls to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/tokenizer.c#L1110"><code>tok_get()</code></a> in a loop until the file is exhausted and no more tokens can be found.</p>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/tokenizer.c#L1110"><code>tok_get()</code></a>, defined in <code>Parser/tokenizer.c</code> behaves like an iterator. It will keep returning the next token in the parse tree.</p>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/tokenizer.c#L1110"><code>tok_get()</code></a> is one of the most complex functions in the whole CPython codebase. It has over 640 lines and includes decades of heritage with edge cases, new language features, and syntax.</p>
<p>One of the simpler examples would be the part that converts a newline break into a NEWLINE token:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">tok_get</span><span class="p">(</span><span class="k">struct</span> <span class="nc">tok_state</span> <span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">p_start</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">p_end</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="cm">/* Newline */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tok</span><span class="o">-&gt;</span><span class="n">atbol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blankline</span> <span class="o">||</span> <span class="n">tok</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">nextline</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">*</span><span class="n">p_start</span> <span class="o">=</span> <span class="n">tok</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
        <span class="o">*</span><span class="n">p_end</span> <span class="o">=</span> <span class="n">tok</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Leave &#39;\n&#39; out of the string */</span>
        <span class="n">tok</span><span class="o">-&gt;</span><span class="n">cont_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tok</span><span class="o">-&gt;</span><span class="n">async_def</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* We&#39;re somewhere inside an &#39;async def&#39; function, and</span>
<span class="cm">               we&#39;ve encountered a NEWLINE after its signature. */</span>
            <span class="n">tok</span><span class="o">-&gt;</span><span class="n">async_def_nl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">NEWLINE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>In this case, <code>NEWLINE</code> is a token, with a value defined in <code>Include/token.h</code>. All tokens are constant <code>int</code> values, and the <code>Include/token.h</code> file was generated earlier when we ran <code>make regen-grammar</code>.</p>
<p>The <code>node</code> type returned by <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Parser/parsetok.c#L163"><code>PyParser_ParseFileObject()</code></a> is going to be essential for the next stage, converting a parse tree into an Abstract-Syntax-Tree (AST):</p>
<div class="highlight c"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_node</span> <span class="p">{</span>
    <span class="kt">short</span>               <span class="n">n_type</span><span class="p">;</span>
    <span class="kt">char</span>                <span class="o">*</span><span class="n">n_str</span><span class="p">;</span>
    <span class="kt">int</span>                 <span class="n">n_lineno</span><span class="p">;</span>
    <span class="kt">int</span>                 <span class="n">n_col_offset</span><span class="p">;</span>
    <span class="kt">int</span>                 <span class="n">n_nchildren</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">_node</span>        <span class="o">*</span><span class="n">n_child</span><span class="p">;</span>
    <span class="kt">int</span>                 <span class="n">n_end_lineno</span><span class="p">;</span>
    <span class="kt">int</span>                 <span class="n">n_end_col_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">node</span><span class="p">;</span>
</code></pre></div>
<p>Since the CST is a tree of syntax, token IDs, and symbols, it would be difficult for the compiler to make quick decisions based on the Python language.</p>
<p>That is why the next stage is to convert the CST into an AST, a much higher-level structure. This task is performed by the <code>Python/ast.c</code> module, which has both a C and Python API.</p>
<p>Before you jump into the AST, there is a way to access the output from the parser stage. CPython has a standard library module <code>parser</code>, which exposes the C functions with a Python API.</p>
<p>The module is documented as an implementation detail of CPython so that you won&rsquo;t see it in other Python interpreters. Also the output from the functions is not that easy to read.</p>
<p>The output will be in the numeric form, using the token and symbol numbers generated by the <code>make regen-grammar</code> stage, stored in <code>Include/token.h</code>: </p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">parser</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">st</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s1">&#39;a + 1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">st2list</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
<span class="go">[258,</span>
<span class="go"> [332,</span>
<span class="go">  [306,</span>
<span class="go">   [310,</span>
<span class="go">    [311,</span>
<span class="go">     [312,</span>
<span class="go">      [313,</span>
<span class="go">       [316,</span>
<span class="go">        [317,</span>
<span class="go">         [318,</span>
<span class="go">          [319,</span>
<span class="go">           [320,</span>
<span class="go">            [321, [322, [323, [324, [325, [1, &#39;a&#39;]]]]]],</span>
<span class="go">            [14, &#39;+&#39;],</span>
<span class="go">            [321, [322, [323, [324, [325, [2, &#39;1&#39;]]]]]]]]]]]]]]]]],</span>
<span class="go"> [4, &#39;&#39;],</span>
<span class="go"> [0, &#39;&#39;]]</span>
</code></pre></div>
<p>To make it easier to understand, you can take all the numbers in the <code>symbol</code> and <code>token</code> modules, put them into a dictionary and <a href="https://realpython.com/python-thinking-recursively/">recursively</a> replace the values in the output of <code>parser.st2list()</code> with the names:</p>
<div class="highlight python"><pre><span></span><code><span class="kn">import</span> <span class="nn">symbol</span>
<span class="kn">import</span> <span class="nn">token</span>
<span class="kn">import</span> <span class="nn">parser</span>

<span class="k">def</span> <span class="nf">lex</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">symbol</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)}</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)}</span>
    <span class="n">lexicon</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">symbols</span><span class="p">,</span> <span class="o">**</span><span class="n">tokens</span><span class="p">}</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
    <span class="n">st_list</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">st2list</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lexicon</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lexicon</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">st_list</span><span class="p">)</span>
</code></pre></div>
<p>You can run <code>lex()</code> with a simple expression, like <code>a + 1</code> to see how this is represented as a parser-tree:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">lex</span><span class="p">(</span><span class="s1">&#39;a + 1&#39;</span><span class="p">))</span>

<span class="go">[&#39;eval_input&#39;,</span>
<span class="go"> [&#39;testlist&#39;,</span>
<span class="go">  [&#39;test&#39;,</span>
<span class="go">   [&#39;or_test&#39;,</span>
<span class="go">    [&#39;and_test&#39;,</span>
<span class="go">     [&#39;not_test&#39;,</span>
<span class="go">      [&#39;comparison&#39;,</span>
<span class="go">       [&#39;expr&#39;,</span>
<span class="go">        [&#39;xor_expr&#39;,</span>
<span class="go">         [&#39;and_expr&#39;,</span>
<span class="go">          [&#39;shift_expr&#39;,</span>
<span class="go">           [&#39;arith_expr&#39;,</span>
<span class="go">            [&#39;term&#39;,</span>
<span class="go">             [&#39;factor&#39;, [&#39;power&#39;, [&#39;atom_expr&#39;, [&#39;atom&#39;, [&#39;NAME&#39;, &#39;a&#39;]]]]]],</span>
<span class="go">            [&#39;PLUS&#39;, &#39;+&#39;],</span>
<span class="go">            [&#39;term&#39;,</span>
<span class="go">             [&#39;factor&#39;,</span>
<span class="go">              [&#39;power&#39;, [&#39;atom_expr&#39;, [&#39;atom&#39;, [&#39;NUMBER&#39;, &#39;1&#39;]]]]]]]]]]]]]]]]],</span>
<span class="go"> [&#39;NEWLINE&#39;, &#39;&#39;],</span>
<span class="go"> [&#39;ENDMARKER&#39;, &#39;&#39;]]</span>
</code></pre></div>
<p>In the output, you can see the symbols in lowercase, such as <code>'test'</code> and the tokens in uppercase, such as <code>'NUMBER'</code>.</p>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section><section class="section3" id="abstract-syntax-trees"><h3>Abstract Syntax Trees<a class="headerlink" href="#abstract-syntax-trees" title="Permanent link"></a></h3>
<p>The next stage in the CPython interpreter is to convert the CST generated by the parser into something more logical that can be executed. The structure is a higher-level representation of the code, called an Abstract Syntax Tree (AST).</p>
<p>ASTs are produced inline with the CPython interpreter process, but you can also generate them in both Python using the <code>ast</code> module in the Standard Library as well as through the C API.</p>
<p>Before diving into the C implementation of the AST, it would be useful to understand what an AST looks like for a simple piece of Python code.</p>
<p>To do this, here&rsquo;s a simple app called <code>instaviz</code> for this tutorial. It displays the AST and bytecode instructions (which we&rsquo;ll cover later) in a Web UI.</p>
<p>To install <code>instaviz</code>:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>pip install instaviz
</code></pre></div>
<p>Then, open up a REPL by running <code>python</code> at the command line with no arguments:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">instaviz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
<span class="go">       a = 1</span>
<span class="go">       b = a + 1</span>
<span class="go">       return b</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">instaviz</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</code></pre></div>
<p>You&rsquo;ll see a notification on the command-line that a web server has started on port <code>8080</code>. If you were using that port for something else, you can change it by calling <code>instaviz.show(example, port=9090)</code> or another port number.</p>
<p>In the web browser, you can see the detailed breakdown of your function:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/screenshot.e148c89e3a9a.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border " src="https://files.realpython.com/media/screenshot.e148c89e3a9a.png" width="4802" height="2566" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/screenshot.e148c89e3a9a.png&amp;w=1200&amp;sig=eeb7b21839b90e3726ea5db7bfa0aac05730b1fe 1200w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/screenshot.e148c89e3a9a.png&amp;w=2401&amp;sig=aed4aed922bbe4ef9c665a90c9244ebaa950e032 2401w, https://files.realpython.com/media/screenshot.e148c89e3a9a.png 4802w" sizes="75vw" alt="Instaviz screenshot" data-asset="1238" /></a></figure>
<p>The bottom left graph is the function you declared in REPL, represented as an Abstract Syntax Tree. Each node in the tree is an AST type. They are found in the <code>ast</code> module, and all inherit from <code>_ast.AST</code>. </p>
<p>Some of the nodes have properties which link them to child nodes, unlike the CST, which has a generic child node property. </p>
<p>For example, if you click on the Assign node in the center, this links to the line <code>b = a + 1</code>:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.17_pm.a5df8d873988.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border w-75" src="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.17_pm.a5df8d873988.png" width="2226" height="1596" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.17_pm.a5df8d873988.png&amp;w=556&amp;sig=6a6f30034c85f411bd6c159df8aef50e899dda9c 556w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.17_pm.a5df8d873988.png&amp;w=1113&amp;sig=1b85cbf0bec4b114ef52d8a7bcdbfa08a1519237 1113w, https://files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.17_pm.a5df8d873988.png 2226w" sizes="75vw" alt="Instaviz screenshot 2" data-asset="1239" /></a></figure>
<p>It has two properties:</p>
<ol>
<li><strong><code>targets</code></strong> is a list of names to assign. It is a list because you can assign to multiple variables with a single expression using unpacking</li>
<li><strong><code>value</code></strong> is the value to assign, which in this case is a <code>BinOp</code> statement, <code>a + 1</code>.</li>
</ol>
<p>If you click on the <code>BinOp</code> statement, it shows the properties of relevance:</p>
<ul>
<li><strong><code>left</code>:</strong> the node to the left of the operator</li>
<li><strong><code>op</code>:</strong> the operator, in this case, an <code>Add</code> node (<code>+</code>) for addition</li>
<li><strong><code>right</code>:</strong> the node to the right of the operator</li>
</ul>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.37_pm.21a11b49a820.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border w-75" src="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.37_pm.21a11b49a820.png" width="1708" height="932" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.37_pm.21a11b49a820.png&amp;w=427&amp;sig=381d8bee4cc98dc98031abc6bc34ec376fd452b7 427w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.37_pm.21a11b49a820.png&amp;w=854&amp;sig=ccc0b88e9d762b2298a33ca2a03e826ee13f4193 854w, https://files.realpython.com/media/Screen_Shot_2019-03-19_at_1.24.37_pm.21a11b49a820.png 1708w" sizes="75vw" alt="Instaviz screenshot 3" data-asset="1240" /></a></figure>
<p>Compiling an AST in C is not a straightforward task, so the <code>Python/ast.c</code> module is over 5000 lines of code.</p>
<p>There are a few entry points, forming part of the AST&rsquo;s public API. In the last section on the lexer and parser, you stopped when you&rsquo;d reached the call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L772"><code>PyAST_FromNodeObject()</code></a>. By this stage, the Python interpreter process had created a CST in the format of <code>node *</code> tree.</p>
<p>Jumping then into <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L772"><code>PyAST_FromNodeObject()</code></a> inside <code>Python/ast.c</code>, you can see it receives the <code>node *</code> tree, the filename, compiler flags, and the <code>PyArena</code>.</p>
<p>The return type from this function is <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/ast.h#L10"><code>mod_ty</code></a>, defined in <code>Include/Python-ast.h</code>. <code>mod_ty</code> is a container structure for one of the 5 module types in Python:</p>
<ol>
<li><code>Module</code> </li>
<li><code>Interactive</code></li>
<li><code>Expression</code></li>
<li><code>FunctionType</code></li>
<li><code>Suite</code></li>
</ol>
<p>In <code>Include/Python-ast.h</code> you can see that an <code>Expression</code> type requires a field <code>body</code>, which is an <code>expr_ty</code> type. The <code>expr_ty</code> type is also defined in <code>Include/Python-ast.h</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="k">enum</span> <span class="n">_mod_kind</span> <span class="p">{</span><span class="n">Module_kind</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Interactive_kind</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">Expression_kind</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">FunctionType_kind</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">Suite_kind</span><span class="o">=</span><span class="mi">5</span><span class="p">};</span>
<span class="k">struct</span> <span class="nc">_mod</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="n">_mod_kind</span> <span class="n">kind</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="p">{</span>
            <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">body</span><span class="p">;</span>
            <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">type_ignores</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">Module</span><span class="p">;</span>

        <span class="k">struct</span> <span class="p">{</span>
            <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">body</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">Interactive</span><span class="p">;</span>

        <span class="k">struct</span> <span class="p">{</span>
            <span class="n">expr_ty</span> <span class="n">body</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">Expression</span><span class="p">;</span>

        <span class="k">struct</span> <span class="p">{</span>
            <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">argtypes</span><span class="p">;</span>
            <span class="n">expr_ty</span> <span class="n">returns</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">FunctionType</span><span class="p">;</span>

        <span class="k">struct</span> <span class="p">{</span>
            <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">body</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">Suite</span><span class="p">;</span>

    <span class="p">}</span> <span class="n">v</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>The AST types are all listed in <code>Parser/Python.asdl</code>. You will see the module types, statement types, expression types, operators, and comprehensions all listed. The names of the types in this document relate to the classes generated by the AST and the same classes named in the <code>ast</code> standard module library.</p>
<p>The parameters and names in <code>Include/Python-ast.h</code> correlate directly to those specified in <code>Parser/Python.asdl</code>:</p>
<div class="highlight text"><pre><span></span><code>-- ASDL&#39;s 5 builtin types are:
-- identifier, int, string, object, constant

module Python
{
    mod = Module(stmt* body, type_ignore *type_ignores)
        | Interactive(stmt* body)
<span class="hll">        | Expression(expr body)
</span>        | FunctionType(expr* argtypes, expr returns)
</code></pre></div>
<p>The C header file and structures are there so that the <code>Python/ast.c</code> program can quickly generate the structures with pointers to the relevant data.</p>
<p>Looking at <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L772"><code>PyAST_FromNodeObject()</code></a> you can see that it is essentially a <code>switch</code> statement around the result from <code>TYPE(n)</code>. <code>TYPE()</code> is one of the core functions used by the AST to determine what type a node in the concrete syntax tree is. In the case of <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L772"><code>PyAST_FromNodeObject()</code></a> it&rsquo;s just looking at the first node, so it can only be one of the module types defined as <code>Module</code>, <code>Interactive</code>, <code>Expression</code>, <code>FunctionType</code>.</p>
<p>The result of <code>TYPE()</code> will be either a symbol or token type, which we&rsquo;re very familiar with by this stage.</p>
<p>For <code>file_input</code>, the results should be a <code>Module</code>. Modules are a series of statements, of which there are a few types. The logic to traverse the children of <code>n</code> and create statement nodes is within <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L4512"><code>ast_for_stmt()</code></a>. This function is called either once, if there is only 1 statement in the module, or in a loop if there are many. The resulting <code>Module</code> is then returned with the <code>PyArena</code>.</p>
<p>For <code>eval_input</code>, the result should be an <code>Expression</code>. The result from <code>CHILD(n ,0)</code>, which is the first child of <code>n</code> is passed to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L3246"><code>ast_for_testlist()</code></a> which returns an <code>expr_ty</code> type. This <code>expr_ty</code> is sent to <code>Expression()</code> with the PyArena to create an expression node, and then passed back as a result:</p>
<div class="highlight c"><pre><span></span><code><span class="n">mod_ty</span>
<span class="nf">PyAST_FromNodeObject</span><span class="p">(</span><span class="k">const</span> <span class="n">node</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
                     <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyArena</span> <span class="o">*</span><span class="n">arena</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">TYPE</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">file_input</span><span class="p">:</span>
            <span class="n">stmts</span> <span class="o">=</span> <span class="n">_Py_asdl_seq_new</span><span class="p">(</span><span class="n">num_stmts</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">arena</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stmts</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCH</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">TYPE</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="n">NEWLINE</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="n">REQ</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">stmt</span><span class="p">);</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">num_stmts</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">                    <span class="n">s</span> <span class="o">=</span> <span class="n">ast_for_stmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
</span>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                    <span class="n">asdl_seq_SET</span><span class="p">(</span><span class="n">stmts</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">ch</span> <span class="o">=</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                    <span class="n">REQ</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">simple_stmt</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">                        <span class="n">s</span> <span class="o">=</span> <span class="n">ast_for_stmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
</span>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
                            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                        <span class="n">asdl_seq_SET</span><span class="p">(</span><span class="n">stmts</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="cm">/* Type ignores are stored under the ENDMARKER in file_input. */</span>
            <span class="p">...</span>

<span class="hll">            <span class="n">res</span> <span class="o">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">stmts</span><span class="p">,</span> <span class="n">type_ignores</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
</span>            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">eval_input</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">expr_ty</span> <span class="n">testlist_ast</span><span class="p">;</span>

            <span class="cm">/* XXX Why not comp_for here? */</span>
<span class="hll">            <span class="n">testlist_ast</span> <span class="o">=</span> <span class="n">ast_for_testlist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">testlist_ast</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="hll">            <span class="n">res</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="n">testlist_ast</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
</span>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">single_input</span><span class="p">:</span>
            <span class="p">...</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">func_type_input</span><span class="p">:</span>
            <span class="p">...</span>
        <span class="p">...</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Inside the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L4512"><code>ast_for_stmt()</code></a> function, there is another <code>switch</code> statement for each possible statement type (<code>simple_stmt</code>, <code>compound_stmt</code>, and so on) and the code to determine the arguments to the node class.</p>
<p>One of the simpler functions is for the power expression, i.e., <code>2**4</code> is 2 to the power of 4. This function starts by getting the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ast.c#L2770"><code>ast_for_atom_expr()</code></a>, which is the number <code>2</code> in our example, then if that has one child, it returns the atomic expression. If it has more than one child, it will get the right-hand (the number <code>4</code>) and return a <code>BinOp</code> (binary operation) with the operator as <code>Pow</code> (power), the left hand of <code>e</code> (2), and the right hand of <code>f</code> (4):</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">expr_ty</span>
<span class="n">ast_for_power</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiling</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="n">node</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* power: atom trailer* (&#39;**&#39; factor)*</span>
<span class="cm">     */</span>
    <span class="n">expr_ty</span> <span class="n">e</span><span class="p">;</span>
    <span class="n">REQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">ast_for_atom_expr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NCH</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">TYPE</span><span class="p">(</span><span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">NCH</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">factor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">expr_ty</span> <span class="n">f</span> <span class="o">=</span> <span class="n">ast_for_expr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">NCH</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">BinOp</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Pow</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">LINENO</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">n_col_offset</span><span class="p">,</span>
                  <span class="n">n</span><span class="o">-&gt;</span><span class="n">n_end_lineno</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">n_end_col_offset</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">c_arena</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>You can see the result of this if you send a short function to the <code>instaviz</code> module:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
<span class="go">       2**4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">instaviz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">instaviz</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</code></pre></div>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_5.34.51_pm.c3a1e8d717f5.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border w-75" src="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_5.34.51_pm.c3a1e8d717f5.png" width="1708" height="1094" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_5.34.51_pm.c3a1e8d717f5.png&amp;w=427&amp;sig=68167794b71cec6447aa8fcb4d22ca738a2e2ce4 427w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_5.34.51_pm.c3a1e8d717f5.png&amp;w=854&amp;sig=feeef6a7ce0b14d39c57956f77320125bcce43bf 854w, https://files.realpython.com/media/Screen_Shot_2019-03-19_at_5.34.51_pm.c3a1e8d717f5.png 1708w" sizes="75vw" alt="Instaviz screenshot 4" data-asset="1241" /></a></figure>
<p>In the UI you can also see the corresponding properties:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_5.36.34_pm.0067235460de.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block border w-75" src="https://files.realpython.com/media/Screen_Shot_2019-03-19_at_5.36.34_pm.0067235460de.png" width="1708" height="630" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_5.36.34_pm.0067235460de.png&amp;w=427&amp;sig=91663308ef854874e262756b2a28e598d263fff5 427w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-19_at_5.36.34_pm.0067235460de.png&amp;w=854&amp;sig=fbfcdd33bcf685f91ebe0559b4135ead2b296d7e 854w, https://files.realpython.com/media/Screen_Shot_2019-03-19_at_5.36.34_pm.0067235460de.png 1708w" sizes="75vw" alt="Instaviz screenshot 5" data-asset="1242" /></a></figure>
<p>In summary, each statement type and expression has a corresponding <code>ast_for_*()</code> function to create it. The arguments are defined in <code>Parser/Python.asdl</code> and exposed via the <code>ast</code> module in the standard library. If an expression or statement has children, then it will call the corresponding <code>ast_for_*</code> child function in a depth-first traversal.</p>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section><section class="section3" id="conclusion_1"><h3>Conclusion<a class="headerlink" href="#conclusion_1" title="Permanent link"></a></h3>
<p>CPython&rsquo;s versatility and low-level execution API make it the ideal candidate for an embedded scripting engine. You will see CPython used in many UI applications, such as Game Design, 3D graphics and system automation. </p>
<p>The interpreter process is flexible and efficient, and now you have an understanding of how it works you&rsquo;re ready to understand the compiler.</p>
</section></section><section class="section2" h1="h1" id="part-3-the-cpython-compiler-and-execution-loop"><h2>Part 3: The CPython Compiler and Execution Loop<a class="headerlink" href="#part-3-the-cpython-compiler-and-execution-loop" title="Permanent link"></a></h2>
<p>In Part 2, you saw how the CPython interpreter takes an input, such as a file or string, and converts it into a logical Abstract Syntax Tree. We&rsquo;re still not at the stage where this code can be executed. Next, we have to go deeper to convert the Abstract Syntax Tree into a set of sequential commands that the CPU can understand. </p>
<section class="section3" id="compiling"><h3>Compiling<a class="headerlink" href="#compiling" title="Permanent link"></a></h3>
<p>Now the interpreter has an AST with the properties required for each of the operations, functions, classes, and namespaces. It is the job of the compiler to turn the AST into something the CPU can understand.</p>
<p>This compilation task is split into 2 parts:</p>
<ol>
<li>Traverse the tree and create a control-flow-graph, which represents the logical sequence for execution</li>
<li>Convert the nodes in the CFG to smaller, executable statements, known as byte-code</li>
</ol>
<p>Earlier, we were looking at how files are executed, and the <code>PyRun_FileExFlags()</code> function in <code>Python/pythonrun.c</code>. Inside this function, we converted the <code>FILE</code> handle into a <code>mod</code>, of type <code>mod_ty</code>. This task was completed by <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1369"><code>PyParser_ASTFromFileObject()</code></a>, which in turns calls the <code>tokenizer</code>, <code>parser-tokenizer</code> and then the AST:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyRun_FileExFlags</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename_str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span>
                  <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span> <span class="kt">int</span> <span class="n">closeit</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
<span class="hll">    <span class="n">mod</span> <span class="o">=</span> <span class="n">PyParser_ASTFromFileObject</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span> <span class="p">...</span>
<span class="hll">    <span class="n">ret</span> <span class="o">=</span> <span class="n">run_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
</span><span class="p">}</span>
</code></pre></div>
<p>The resulting module from the call to is sent to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1125"><code>run_mod()</code></a> still in <code>Python/pythonrun.c</code>. This is a small function that gets a <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/code.h#L69"><code>PyCodeObject</code></a> from <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> and sends it on to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1094"><code>run_eval_code_obj()</code></a>. You will tackle <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1094"><code>run_eval_code_obj()</code></a> in the next section:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">run_mod</span><span class="p">(</span><span class="n">mod_ty</span> <span class="n">mod</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span>
            <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="n">PyArena</span> <span class="o">*</span><span class="n">arena</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
<span class="hll">    <span class="n">co</span> <span class="o">=</span> <span class="n">PyAST_CompileObject</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="n">arena</span><span class="p">);</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">co</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PySys_Audit</span><span class="p">(</span><span class="s">&quot;exec&quot;</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">co</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="n">v</span> <span class="o">=</span> <span class="n">run_eval_code_obj</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">);</span>
</span>    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">co</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> function is the main entry point to the CPython compiler. It takes a Python module as its primary argument, along with the name of the file, the globals, locals, and the <code>PyArena</code> all created earlier in the interpreter process.</p>
<p>We&rsquo;re starting to get into the guts of the CPython compiler now, with decades of development and Computer Science theory behind it. Don&rsquo;t be put off by the language. Once we break down the compiler into logical steps, it&rsquo;ll make sense.</p>
<p>Before the compiler starts, a global compiler state is created. This type, <code>compiler</code> is defined in <code>Python/compile.c</code> and contains properties used by the compiler to remember the compiler flags, the stack, and the <code>PyArena</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="k">struct</span> <span class="nc">compiler</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">c_filename</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">symtable</span> <span class="o">*</span><span class="n">c_st</span><span class="p">;</span>
    <span class="n">PyFutureFeatures</span> <span class="o">*</span><span class="n">c_future</span><span class="p">;</span> <span class="cm">/* pointer to module&#39;s __future__ */</span>
    <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">c_flags</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">c_optimize</span><span class="p">;</span>              <span class="cm">/* optimization level */</span>
    <span class="kt">int</span> <span class="n">c_interactive</span><span class="p">;</span>           <span class="cm">/* true if in interactive mode */</span>
    <span class="kt">int</span> <span class="n">c_nestlevel</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c_do_not_emit_bytecode</span><span class="p">;</span>  <span class="cm">/* The compiler won&#39;t emit any bytecode</span>
<span class="cm">                                    if this value is different from zero.</span>
<span class="cm">                                    This can be used to temporarily visit</span>
<span class="cm">                                    nodes without emitting bytecode to</span>
<span class="cm">                                    check only errors. */</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">c_const_cache</span><span class="p">;</span>     <span class="cm">/* Python dict holding all constants,</span>
<span class="cm">                                    including names tuple */</span>
    <span class="k">struct</span> <span class="nc">compiler_unit</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span> <span class="cm">/* compiler state for current block */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">c_stack</span><span class="p">;</span>           <span class="cm">/* Python list holding compiler_unit ptrs */</span>
    <span class="n">PyArena</span> <span class="o">*</span><span class="n">c_arena</span><span class="p">;</span>            <span class="cm">/* pointer to memory allocation arena */</span>
<span class="p">};</span>
</code></pre></div>
<p>Inside <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a>, there are 11 main steps happening:</p>
<ol>
<li>Create an empty <code>__doc__</code> property to the module if it doesn&rsquo;t exist.</li>
<li>Create an empty <code>__annotations__</code> property to the module if it doesn&rsquo;t exist.</li>
<li>Set the filename of the global compiler state to the filename argument.</li>
<li>Set the memory allocation arena for the compiler to the one used by the interpreter.</li>
<li>Copy any <code>__future__</code> flags in the module to the future flags in the compiler.</li>
<li>Merge runtime flags provided by the command-line or environment variables.</li>
<li>Enable any <code>__future__</code> features in the compiler.</li>
<li>Set the optimization level to the provided argument, or default.</li>
<li>Build a symbol table from the module object.</li>
<li>Run the compiler with the compiler state and return the code object.</li>
<li>Free any allocated memory by the compiler.</li>
</ol>
<div class="highlight c"><pre><span></span><code><span class="n">PyCodeObject</span> <span class="o">*</span>
<span class="nf">PyAST_CompileObject</span><span class="p">(</span><span class="n">mod_ty</span> <span class="n">mod</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyCompilerFlags</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
                   <span class="kt">int</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">PyArena</span> <span class="o">*</span><span class="n">arena</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">compiler</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyCompilerFlags</span> <span class="n">local_flags</span> <span class="o">=</span> <span class="n">_PyCompilerFlags_INIT</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">merged</span><span class="p">;</span>
    <span class="n">PyConfig</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_PyInterpreterState_GET_UNSAFE</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
<span class="hll">
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__doc__</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__doc__</span> <span class="o">=</span> <span class="n">PyUnicode_InternFromString</span><span class="p">(</span><span class="s">&quot;__doc__&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__doc__</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__annotations__</span><span class="p">)</span> <span class="p">{</span>
</span>        <span class="n">__annotations__</span> <span class="o">=</span> <span class="n">PyUnicode_InternFromString</span><span class="p">(</span><span class="s">&quot;__annotations__&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__annotations__</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compiler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="hll">    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
</span><span class="hll">    <span class="n">c</span><span class="p">.</span><span class="n">c_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
</span><span class="hll">    <span class="n">c</span><span class="p">.</span><span class="n">c_arena</span> <span class="o">=</span> <span class="n">arena</span><span class="p">;</span>
</span>    <span class="n">c</span><span class="p">.</span><span class="n">c_future</span> <span class="o">=</span> <span class="n">PyFuture_FromASTObject</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">c_future</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">finally</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_flags</span><span class="p">;</span>
<span class="hll">    <span class="p">}</span>
</span><span class="hll">    <span class="n">merged</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">c_future</span><span class="o">-&gt;</span><span class="n">ff_features</span> <span class="o">|</span> <span class="n">flags</span><span class="o">-&gt;</span><span class="n">cf_flags</span><span class="p">;</span>
</span>    <span class="n">c</span><span class="p">.</span><span class="n">c_future</span><span class="o">-&gt;</span><span class="n">ff_features</span> <span class="o">=</span> <span class="n">merged</span><span class="p">;</span>
    <span class="n">flags</span><span class="o">-&gt;</span><span class="n">cf_flags</span> <span class="o">=</span> <span class="n">merged</span><span class="p">;</span>
<span class="hll">    <span class="n">c</span><span class="p">.</span><span class="n">c_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
</span>    <span class="n">c</span><span class="p">.</span><span class="n">c_optimize</span> <span class="o">=</span> <span class="p">(</span><span class="n">optimize</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span> <span class="o">?</span> <span class="n">config</span><span class="o">-&gt;</span><span class="nl">optimization_level</span> <span class="p">:</span> <span class="n">optimize</span><span class="p">;</span>
    <span class="n">c</span><span class="p">.</span><span class="n">c_nestlevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">c</span><span class="p">.</span><span class="n">c_do_not_emit_bytecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_PyAST_Optimize</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">arena</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">c_optimize</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">finally</span><span class="p">;</span>
<span class="hll">    <span class="p">}</span>
</span>
    <span class="n">c</span><span class="p">.</span><span class="n">c_st</span> <span class="o">=</span> <span class="n">PySymtable_BuildObject</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">c_future</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">c_st</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyErr_Occurred</span><span class="p">())</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_SystemError</span><span class="p">,</span> <span class="s">&quot;no symtable&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">finally</span><span class="p">;</span>
<span class="hll">    <span class="p">}</span>
</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">compiler_mod</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>

 <span class="nl">finally</span><span class="p">:</span>
    <span class="n">compiler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">co</span> <span class="o">||</span> <span class="n">PyErr_Occurred</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">co</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<section class="section4" id="future-flags-and-compiler-flags"><h4>Future Flags and Compiler Flags<a class="headerlink" href="#future-flags-and-compiler-flags" title="Permanent link"></a></h4>
<p>Before the compiler runs, there are two types of flags to toggle the features inside the compiler. These come from two places:</p>
<ol>
<li>The interpreter state, which may have been command-line options, set in <code>pyconfig.h</code> or via environment variables</li>
<li>The use of <code>__future__</code> statements inside the actual source code of the module</li>
</ol>
<p>To distinguish the two types of flags, think that the <code>__future__</code> flags are required because of the syntax or features in that specific module. For example, Python 3.7 introduced delayed evaluation of type hints through the <code>annotations</code> future flag:</p>
<div class="highlight python"><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</code></pre></div>
<p>The code after this statement might use unresolved type hints, so the <code>__future__</code> statement is required. Otherwise, the module wouldn&rsquo;t import. It would be unmaintainable to manually request that the person importing the module enable this specific compiler flag.</p>
<p>The other compiler flags are specific to the environment, so they might change the way the code executes or the way the compiler runs, but they shouldn&rsquo;t link to the source in the same way that <code>__future__</code> statements do.</p>
<p>One example of a compiler flag would be the <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-o"><code>-O</code> flag for optimizing the use of <code>assert</code> statements</a>. This flag disables any <code>assert</code> statements, which may have been put in the code for <a href="https://realpython.com/python-debugging-pdb/">debugging purposes</a>.
It can also be enabled with the <code>PYTHONOPTIMIZE=1</code> environment variable setting.</p>
</section><section class="section4" id="symbol-tables"><h4>Symbol Tables<a class="headerlink" href="#symbol-tables" title="Permanent link"></a></h4>
<p>In <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> there was a reference to a <code>symtable</code> and a call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L262"><code>PySymtable_BuildObject()</code></a> with the module to be executed.</p>
<p>The purpose of the symbol table is to provide a list of namespaces, globals, and locals for the compiler to use for referencing and resolving scopes.</p>
<p>The <code>symtable</code> structure in <code>Include/symtable.h</code> is well documented, so it&rsquo;s clear what each of the fields is for. There should be one symtable instance for the compiler, so namespacing becomes essential. </p>
<p>If you create a function called <code>resolve_names()</code> in one module and declare another function with the same name in another module, you want to be sure which one is called. The symtable serves this purpose, as well as ensuring that variables declared within a narrow scope don&rsquo;t automatically become globals (after all, this isn&rsquo;t JavaScript):</p>
<div class="highlight c"><pre><span></span><code><span class="k">struct</span> <span class="nc">symtable</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">st_filename</span><span class="p">;</span>          <span class="cm">/* name of file being compiled,</span>
<span class="cm">                                       decoded from the filesystem encoding */</span>
    <span class="k">struct</span> <span class="nc">_symtable_entry</span> <span class="o">*</span><span class="n">st_cur</span><span class="p">;</span> <span class="cm">/* current symbol table entry */</span>
    <span class="k">struct</span> <span class="nc">_symtable_entry</span> <span class="o">*</span><span class="n">st_top</span><span class="p">;</span> <span class="cm">/* symbol table entry for module */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">st_blocks</span><span class="p">;</span>            <span class="cm">/* dict: map AST node addresses</span>
<span class="cm">                                     *       to symbol table entries */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">st_stack</span><span class="p">;</span>             <span class="cm">/* list: stack of namespace info */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">st_global</span><span class="p">;</span>            <span class="cm">/* borrowed ref to st_top-&gt;ste_symbols */</span>
    <span class="kt">int</span> <span class="n">st_nblocks</span><span class="p">;</span>                 <span class="cm">/* number of blocks used. kept for</span>
<span class="cm">                                       consistency with the corresponding</span>
<span class="cm">                                       compiler structure */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">st_private</span><span class="p">;</span>           <span class="cm">/* name of current class or NULL */</span>
    <span class="n">PyFutureFeatures</span> <span class="o">*</span><span class="n">st_future</span><span class="p">;</span>    <span class="cm">/* module&#39;s future features that affect</span>
<span class="cm">                                       the symbol table */</span>
    <span class="kt">int</span> <span class="n">recursion_depth</span><span class="p">;</span>            <span class="cm">/* current recursion depth */</span>
    <span class="kt">int</span> <span class="n">recursion_limit</span><span class="p">;</span>            <span class="cm">/* recursion limit */</span>
<span class="p">};</span>
</code></pre></div>
<p>Some of the symbol table API is exposed via <a href="https://docs.python.org/3/library/symtable.html">the <code>symtable</code> module</a> in the standard library. You can provide an expression or a module an receive a <code>symtable.SymbolTable</code> instance.</p>
<p>You can provide a string with a Python expression and the <code>compile_type</code> of <code>"eval"</code>, or a module, function or class, and the <code>compile_mode</code> of <code>"exec"</code> to get a symbol table.</p>
<p>Looping over the elements in the table we can see some of the public and private fields and their types:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">symtable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">symtable</span><span class="o">.</span><span class="n">symtable</span><span class="p">(</span><span class="s1">&#39;b + 1&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test.py&#39;</span><span class="p">,</span> <span class="n">compile_type</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">symbol</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">get_symbols</span><span class="p">()]</span>
<span class="go">[{&#39;_Symbol__name&#39;: &#39;b&#39;, &#39;_Symbol__flags&#39;: 6160, &#39;_Symbol__scope&#39;: 3, &#39;_Symbol__namespaces&#39;: ()}]</span>
</code></pre></div>
<p>The C code behind this is all within <code>Python/symtable.c</code> and the primary interface is the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L262"><code>PySymtable_BuildObject()</code></a> function.</p>
<p>Similar to the top-level AST function we covered earlier, the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L262"><code>PySymtable_BuildObject()</code></a> function switches between the <code>mod_ty</code> possible types (Module, Expression, Interactive, Suite, FunctionType), and visits each of the statements inside them.</p>
<p>Remember, <code>mod_ty</code> is an AST instance, so the will now <a href="https://realpython.com/python-recursion/">recursively</a> explore the nodes and branches of the tree and add entries to the symtable:</p>
<div class="highlight c"><pre><span></span><code><span class="k">struct</span> <span class="nc">symtable</span> <span class="o">*</span>
<span class="n">PySymtable_BuildObject</span><span class="p">(</span><span class="n">mod_ty</span> <span class="n">mod</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyFutureFeatures</span> <span class="o">*</span><span class="n">future</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="k">struct</span> <span class="nc">symtable</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">symtable_new</span><span class="p">();</span>
</span>    <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">seq</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">recursion_limit</span> <span class="o">=</span> <span class="n">Py_GetRecursionLimit</span><span class="p">();</span>
<span class="p">...</span>
    <span class="n">st</span><span class="o">-&gt;</span><span class="n">st_top</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">st_cur</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">Module_kind</span><span class="p">:</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">Module</span><span class="p">.</span><span class="n">body</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">asdl_seq_LEN</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="hll">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symtable_visit_stmt</span><span class="p">(</span><span class="n">st</span><span class="p">,</span>
</span>                        <span class="p">(</span><span class="n">stmt_ty</span><span class="p">)</span><span class="n">asdl_seq_GET</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">Expression_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">Interactive_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">Suite_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">FunctionType_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>So for a module, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L262"><code>PySymtable_BuildObject()</code></a> will loop through each statement in the module and call <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L1176"><code>symtable_visit_stmt()</code></a>. The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L1176"><code>symtable_visit_stmt()</code></a> is a huge <code>switch</code> statement with a case for each statement type (defined in <code>Parser/Python.asdl</code>).</p>
<p>For each statement type, there is specific logic to that statement type. For example, a function definition has particular logic for:</p>
<ol>
<li>If the recursion depth is beyond the limit, raise a recursion depth error</li>
<li>The name of the function to be added as a local variable</li>
<li>The default values for sequential arguments to be resolved</li>
<li>The default values for keyword arguments to be resolved </li>
<li>Any annotations for the arguments or the return type are resolved</li>
<li>Any function decorators are resolved</li>
<li>The code block with the contents of the function is visited in <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L973"><code>symtable_enter_block()</code></a></li>
<li>The arguments are visited</li>
<li>The body of the function is visited</li>
</ol>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> If you&rsquo;ve ever wondered why Python&rsquo;s default arguments are mutable, the reason is in this function. You can see they are a pointer to the variable in the symtable. No extra work is done to copy any values to an <a href="https://realpython.com/courses/immutability-python/">immutable</a> type.</p>
</div>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">symtable_visit_stmt</span><span class="p">(</span><span class="k">struct</span> <span class="nc">symtable</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">stmt_ty</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">recursion_depth</span> <span class="o">&gt;</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">recursion_limit</span><span class="p">)</span> <span class="p">{</span>                          <span class="c1">// 1.</span>
</span>        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_RecursionError</span><span class="p">,</span>
                        <span class="s">&quot;maximum recursion depth exceeded during compilation&quot;</span><span class="p">);</span>
        <span class="n">VISIT_QUIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">FunctionDef_kind</span><span class="p">:</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symtable_add_def</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">DEF_LOCAL</span><span class="p">))</span>            <span class="c1">// 2.</span>
</span>            <span class="n">VISIT_QUIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">)</span>                                    <span class="c1">// 3.</span>
</span>            <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">);</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">kw_defaults</span><span class="p">)</span>                                 <span class="c1">// 4.</span>
</span>            <span class="n">VISIT_SEQ_WITH_NULL</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">kw_defaults</span><span class="p">);</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symtable_visit_annotations</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">args</span><span class="p">,</span>           <span class="c1">// 5.</span>
</span>                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">returns</span><span class="p">))</span>
            <span class="n">VISIT_QUIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">decorator_list</span><span class="p">)</span>                                    <span class="c1">// 6.</span>
</span>            <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">decorator_list</span><span class="p">);</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symtable_enter_block</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>                    <span class="c1">// 7.</span>
</span>                                  <span class="n">FunctionBlock</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lineno</span><span class="p">,</span>
                                  <span class="n">s</span><span class="o">-&gt;</span><span class="n">col_offset</span><span class="p">))</span>
            <span class="n">VISIT_QUIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="hll">        <span class="n">VISIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">args</span><span class="p">);</span>                            <span class="c1">// 8.</span>
</span><span class="hll">        <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">FunctionDef</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>                             <span class="c1">// 9.</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symtable_exit_block</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
            <span class="n">VISIT_QUIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ClassDef_kind</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="nl">Return_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">Delete_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">Assign_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">AnnAssign_kind</span><span class="p">:</span>
        <span class="p">...</span>
</code></pre></div>
<p>Once the resulting symtable has been created, it is sent back to be used for the compiler.</p>
</section><section class="section4" id="core-compilation-process"><h4>Core Compilation Process<a class="headerlink" href="#core-compilation-process" title="Permanent link"></a></h4>
<p>Now that the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> has a compiler state, a symtable, and a module in the form of the AST, the actual compilation can begin.</p>
<p>The purpose of the core compiler is to:</p>
<ul>
<li>Convert the state, symtable, and AST into a <a href="https://en.wikipedia.org/wiki/Control-flow_graph">Control-Flow-Graph (CFG)</a></li>
<li>Protect the execution stage from runtime exceptions by catching any logic and code errors and raising them here</li>
</ul>
<p>You can call the CPython compiler in Python code by calling the built-in function <code>compile()</code>. It returns a <code>code object</code> instance:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;b+1&#39;</span><span class="p">,</span> <span class="s1">&#39;test.py&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
<span class="go">&lt;code object &lt;module&gt; at 0x10f222780, file &quot;test.py&quot;, line 1&gt;</span>
</code></pre></div>
<p>The same as with the <code>symtable()</code> function, a simple expression should have a mode of <code>'eval'</code> and a module, function, or class should have a mode of <code>'exec'</code>.</p>
<p>The compiled code can be found in the <code>co_code</code> property of the code object:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">co</span><span class="o">.</span><span class="n">co_code</span>
<span class="go">b&#39;e\x00d\x00\x17\x00S\x00&#39;</span>
</code></pre></div>
<p>There is also a <code>dis</code> module in the standard library, which disassembles the bytecode instructions and can print them on the screen or give you a list of <code>Instruction</code> instances.</p>
<p>If you import <code>dis</code> and give the <code>dis()</code> function the code object&rsquo;s <code>co_code</code> property it disassembles it and prints the instructions on the REPL:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_code</span><span class="p">)</span>
<span class="go">          0 LOAD_NAME                0 (0)</span>
<span class="go">          2 LOAD_CONST               0 (0)</span>
<span class="go">          4 BINARY_ADD</span>
<span class="go">          6 RETURN_VALUE</span>
</code></pre></div>
<p><code>LOAD_NAME</code>, <code>LOAD_CONST</code>, <code>BINARY_ADD</code>, and <code>RETURN_VALUE</code> are all bytecode instructions. They&rsquo;re called bytecode because, in binary form, they were a byte long. However, since Python 3.6 the storage format was changed to a <code>word</code>, so now they&rsquo;re technically wordcode, not bytecode.</p>
<p>The <a href="https://docs.python.org/3/library/dis.html#python-bytecode-instructions">full list of bytecode instructions</a> is available for each version of Python, and it does change between versions. For example, in Python 3.7, some new bytecode instructions were introduced to speed up execution of specific method calls.</p>
<p>In an earlier section, we explored the <code>instaviz</code> package. This included a visualization of the code object type by running the compiler. It also displays the Bytecode operations inside the code objects.</p>
<p>Execute instaviz again to see the code object and bytecode for a function defined on the REPL:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">instaviz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
<span class="go">       a = 1</span>
<span class="go">       b = a + 1</span>
<span class="go">       return b</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">instaviz</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</code></pre></div>
<p>If we now jump into <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L1782"><code>compiler_mod()</code></a>, a function used to switch to different compiler functions depending on the module type. We&rsquo;ll assume that <code>mod</code> is a <code>Module</code>. The module is compiled into the compiler state and then <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L5971"><code>assemble()</code></a> is run to create a <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/code.h#L69"><code>PyCodeObject</code></a>.</p>
<p>The new code object is returned back to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> and sent on for execution:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyCodeObject</span> <span class="o">*</span>
<span class="n">compiler_mod</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">mod_ty</span> <span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span><span class="p">;</span>
</span>    <span class="kt">int</span> <span class="n">addNone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">module</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">Module_kind</span><span class="p">:</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compiler_body</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">Module</span><span class="p">.</span><span class="n">body</span><span class="p">))</span> <span class="p">{</span>
</span>            <span class="n">compiler_exit_scope</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">Interactive_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">Expression_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="k">case</span> <span class="nl">Suite_kind</span><span class="p">:</span>
        <span class="p">...</span>
    <span class="p">...</span>
<span class="hll">    <span class="n">co</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addNone</span><span class="p">);</span>
</span>    <span class="n">compiler_exit_scope</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="hll">    <span class="k">return</span> <span class="n">co</span><span class="p">;</span>
</span><span class="p">}</span>
</code></pre></div>
<p>The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L1743"><code>compiler_body()</code></a> function has some optimization flags and then loops over each statement in the module and visits it, similar to how the <code>symtable</code> functions worked:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">compiler_body</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">stmts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stmt_ty</span> <span class="n">st</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">docstring</span><span class="p">;</span>
    <span class="p">...</span>
<span class="hll">    <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">asdl_seq_LEN</span><span class="p">(</span><span class="n">stmts</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class="hll">        <span class="n">VISIT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="n">stmt_ty</span><span class="p">)</span><span class="n">asdl_seq_GET</span><span class="p">(</span><span class="n">stmts</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The statement type is determined through a call to the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/asdl.h#L32"><code>asdl_seq_GET()</code></a> function, which looks at the AST node&rsquo;s type.</p>
<p>Through some smart macros, <code>VISIT</code> calls a function in <code>Python/compile.c</code> for each statement type:</p>
<div class="highlight c"><pre><span></span><code><span class="cp">#define VISIT(C, TYPE, V) {\</span>
<span class="cp">    if (!compiler_visit_ ## TYPE((C), (V))) \</span>
<span class="cp">        return 0; \</span>
<span class="cp">}</span>
</code></pre></div>
<p>For a <code>stmt</code> (the category for a statement) the compiler will then drop into <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L3310"><code>compiler_visit_stmt()</code></a> and switch through all of the potential statement types found in <code>Parser/Python.asdl</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">compiler_visit_stmt</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt_ty</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_ssize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

    <span class="cm">/* Always assign a lineno to the next instruction for a stmt. */</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_lineno</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lineno</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_col_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">col_offset</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_lineno_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">FunctionDef_kind</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compiler_function</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">case</span> <span class="nl">ClassDef_kind</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compiler_class</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="nl">For_kind</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compiler_for</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>As an example, let&rsquo;s focus on the <code>For</code> statement, in Python is the:</p>
<div class="highlight python"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
    <span class="c1"># block</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># optional if iterable is False</span>
    <span class="c1"># block</span>
</code></pre></div>
<p>If the statement is a <code>For</code> type, it calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L2651"><code>compiler_for()</code></a>. There is an equivalent <code>compiler_*()</code> function for all of the statement and expression types. The more straightforward types create the bytecode instructions inline, some of the more complex statement types call other functions.</p>
<p>Many of the statements can have sub-statements. A <a href="https://realpython.com/python-for-loop/"><code>for</code> loop</a> has a body, but you can also have complex expressions in the assignment and the iterator.</p>
<p>The compiler&rsquo;s <code>compiler_</code> statements sends blocks to the compiler state. These blocks contain instructions, the instruction data structure in <code>Python/compile.c</code> has the opcode, any arguments, and the target block (if this is a jump instruction), it also contains the line number.</p>
<p>For jump statements, they can either be absolute or relative jump statements. Jump statements are used to &ldquo;jump&rdquo; from one operation to another. Absolute jump statements specify the exact operation number in the compiled code object, whereas relative jump statements specify the jump target relative to another operation:</p>
<div class="highlight c"><pre><span></span><code><span class="k">struct</span> <span class="nc">instr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="nl">i_jabs</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="nl">i_jrel</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i_opcode</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i_oparg</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">basicblock_</span> <span class="o">*</span><span class="n">i_target</span><span class="p">;</span> <span class="cm">/* target block (if jump instruction) */</span>
    <span class="kt">int</span> <span class="n">i_lineno</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>So a frame block (of type <code>basicblock</code>), contains the following fields:</p>
<ul>
<li>A <code>b_list</code> pointer, the link to a list of blocks for the compiler state</li>
<li>A list of instructions <code>b_instr</code>, with both the allocated list size <code>b_ialloc</code>, and the number used <code>b_iused</code></li>
<li>The next block after this one <code>b_next</code></li>
<li>Whether the block has been &ldquo;seen&rdquo; by the assembler when traversing depth-first</li>
<li>If this block has a <code>RETURN_VALUE</code> opcode (<code>b_return</code>)</li>
<li>The depth of the stack when this block was entered (<code>b_startdepth</code>)</li>
<li>The instruction offset for the assembler</li>
</ul>
<div class="highlight c"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">basicblock_</span> <span class="p">{</span>
    <span class="cm">/* Each basicblock in a compilation unit is linked via b_list in the</span>
<span class="cm">       reverse order that the block are allocated.  b_list points to the next</span>
<span class="cm">       block, not to be confused with b_next, which is next by control flow. */</span>
    <span class="k">struct</span> <span class="nc">basicblock_</span> <span class="o">*</span><span class="n">b_list</span><span class="p">;</span>
    <span class="cm">/* number of instructions used */</span>
    <span class="kt">int</span> <span class="n">b_iused</span><span class="p">;</span>
    <span class="cm">/* length of instruction array (b_instr) */</span>
    <span class="kt">int</span> <span class="n">b_ialloc</span><span class="p">;</span>
    <span class="cm">/* pointer to an array of instructions, initially NULL */</span>
    <span class="k">struct</span> <span class="nc">instr</span> <span class="o">*</span><span class="n">b_instr</span><span class="p">;</span>
    <span class="cm">/* If b_next is non-NULL, it is a pointer to the next</span>
<span class="cm">       block reached by normal control flow. */</span>
    <span class="k">struct</span> <span class="nc">basicblock_</span> <span class="o">*</span><span class="n">b_next</span><span class="p">;</span>
    <span class="cm">/* b_seen is used to perform a DFS of basicblocks. */</span>
    <span class="kt">unsigned</span> <span class="nl">b_seen</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cm">/* b_return is true if a RETURN_VALUE opcode is inserted. */</span>
    <span class="kt">unsigned</span> <span class="nl">b_return</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cm">/* depth of stack upon entry of block, computed by stackdepth() */</span>
    <span class="kt">int</span> <span class="n">b_startdepth</span><span class="p">;</span>
    <span class="cm">/* instruction offset for block, computed by assemble_jump_offsets() */</span>
    <span class="kt">int</span> <span class="n">b_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">basicblock</span><span class="p">;</span>
</code></pre></div>
<p>The <code>For</code> statement is somewhere in the middle in terms of complexity. There are 15 steps in the compilation of a <code>For</code> statement with the <code>for &lt;target&gt; in &lt;iterator&gt;:</code> syntax:</p>
<ol>
<li>Create a new code block called <code>start</code>, this allocates memory and creates a <code>basicblock</code> pointer</li>
<li>Create a new code block called <code>cleanup</code></li>
<li>Create a new code block called <code>end</code></li>
<li>Push a frame block of type <code>FOR_LOOP</code> to the stack with <code>start</code> as the entry block and <code>end</code> as the exit block</li>
<li>Visit the iterator expression, which adds any operations for the iterator</li>
<li>Add the <code>GET_ITER</code> operation to the compiler state</li>
<li>Switch to the <code>start</code> block</li>
<li>Call <code>ADDOP_JREL</code> which calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L1413"><code>compiler_addop_j()</code></a> to add the <code>FOR_ITER</code> operation with an argument of the <code>cleanup</code> block</li>
<li>Visit the <code>target</code> and add any special code, like tuple unpacking, to the <code>start</code> block</li>
<li>Visit each statement in the body of the for loop</li>
<li>Call <code>ADDOP_JABS</code> which calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L1413"><code>compiler_addop_j()</code></a> to add the <code>JUMP_ABSOLUTE</code> operation which indicates after the body is executed, jumps back to the start of the loop</li>
<li>Move to the <code>cleanup</code> block</li>
<li>Pop the <code>FOR_LOOP</code> frame block off the stack</li>
<li>Visit the statements inside the <code>else</code> section of the for loop</li>
<li>Use the <code>end</code> block</li>
</ol>
<p>Referring back to the <code>basicblock</code> structure. You can see how in the compilation of the for statement, the various blocks are created and pushed into the compiler&rsquo;s frame block and stack:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span>
<span class="n">compiler_for</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt_ty</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">basicblock</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">cleanup</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

<span class="hll">    <span class="n">start</span> <span class="o">=</span> <span class="n">compiler_new_block</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>                       <span class="c1">// 1.</span>
</span><span class="hll">    <span class="n">cleanup</span> <span class="o">=</span> <span class="n">compiler_new_block</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>                     <span class="c1">// 2.</span>
</span><span class="hll">    <span class="n">end</span> <span class="o">=</span> <span class="n">compiler_new_block</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>                         <span class="c1">// 3.</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cleanup</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compiler_push_fblock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">FOR_LOOP</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>  <span class="c1">// 4.</span>
</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="hll">    <span class="n">VISIT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">For</span><span class="p">.</span><span class="n">iter</span><span class="p">);</span>                       <span class="c1">// 5.</span>
</span><span class="hll">    <span class="n">ADDOP</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">GET_ITER</span><span class="p">);</span>                                  <span class="c1">// 6.</span>
</span><span class="hll">    <span class="n">compiler_use_next_block</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>                   <span class="c1">// 7.</span>
</span><span class="hll">    <span class="n">ADDOP_JREL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">FOR_ITER</span><span class="p">,</span> <span class="n">cleanup</span><span class="p">);</span>                    <span class="c1">// 8.</span>
</span><span class="hll">    <span class="n">VISIT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">For</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>                     <span class="c1">// 9.</span>
</span><span class="hll">    <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">For</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>                   <span class="c1">// 10.</span>
</span><span class="hll">    <span class="n">ADDOP_JABS</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">JUMP_ABSOLUTE</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>                 <span class="c1">// 11.</span>
</span><span class="hll">    <span class="n">compiler_use_next_block</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cleanup</span><span class="p">);</span>                 <span class="c1">// 12.</span>
</span>
<span class="hll">    <span class="n">compiler_pop_fblock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">FOR_LOOP</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>             <span class="c1">// 13.</span>
</span>
<span class="hll">    <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">For</span><span class="p">.</span><span class="n">orelse</span><span class="p">);</span>                 <span class="c1">// 14.</span>
</span><span class="hll">    <span class="n">compiler_use_next_block</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>                     <span class="c1">// 15.</span>
</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Depending on the type of operation, there are different arguments required. For example, we used <code>ADDOP_JABS</code> and <code>ADDOP_JREL</code> here, which refer to &ldquo;<strong>ADD</strong> <strong>O</strong>peration with <strong>J</strong>ump to a <strong>REL</strong>ative position&rdquo; and &ldquo;<strong>ADD</strong> <strong>O</strong>peration with <strong>J</strong>ump to an <strong>ABS</strong>olute position&rdquo;. This is referring to the <code>APPOP_JREL</code> and <code>ADDOP_JABS</code> macros which call <code>compiler_addop_j(struct compiler *c, int opcode, basicblock *b, int absolute)</code> and set the <code>absolute</code> argument to 0 and 1 respectively.</p>
<p>There are some other macros, like <code>ADDOP_I</code> calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L1383"><code>compiler_addop_i()</code></a> which add an operation with an integer argument, or <code>ADDOP_O</code> calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L1345"><code>compiler_addop_o()</code></a> which adds an operation with a <code>PyObject</code> argument. </p>
<p>Once these stages have completed, the compiler has a list of frame blocks, each containing a list of instructions and a pointer to the next block.</p>
</section><section class="section4" id="assembly"><h4>Assembly<a class="headerlink" href="#assembly" title="Permanent link"></a></h4>
<p>With the compiler state, the assembler performs a &ldquo;depth-first-search&rdquo; of the blocks and merge the instructions into a single bytecode sequence. The assembler state is declared in <code>Python/compile.c</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="k">struct</span> <span class="nc">assembler</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">a_bytecode</span><span class="p">;</span>  <span class="cm">/* string containing bytecode */</span>
    <span class="kt">int</span> <span class="n">a_offset</span><span class="p">;</span>              <span class="cm">/* offset into bytecode */</span>
    <span class="kt">int</span> <span class="n">a_nblocks</span><span class="p">;</span>             <span class="cm">/* number of reachable blocks */</span>
    <span class="n">basicblock</span> <span class="o">**</span><span class="n">a_postorder</span><span class="p">;</span> <span class="cm">/* list of blocks in dfs postorder */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">a_lnotab</span><span class="p">;</span>    <span class="cm">/* string containing lnotab */</span>
    <span class="kt">int</span> <span class="n">a_lnotab_off</span><span class="p">;</span>      <span class="cm">/* offset into lnotab */</span>
    <span class="kt">int</span> <span class="n">a_lineno</span><span class="p">;</span>              <span class="cm">/* last lineno of emitted instruction */</span>
    <span class="kt">int</span> <span class="n">a_lineno_off</span><span class="p">;</span>      <span class="cm">/* bytecode offset of last lineno */</span>
<span class="p">};</span>
</code></pre></div>
<p>The <code>assemble()</code> function has a few tasks:</p>
<ul>
<li>Calculate the number of blocks for memory allocation</li>
<li>Ensure that every block that falls off the end returns <code>None</code>, this is why every function returns <code>None</code>, whether or not a <a href="https://realpython.com/python-return-statement/"><code>return</code> statement</a> exists</li>
<li>Resolve any jump statements offsets that were marked as relative</li>
<li>Call <code>dfs()</code> to perform a depth-first-search of the blocks</li>
<li>Emit all the instructions to the compiler</li>
<li>Call <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L5854"><code>makecode()</code></a> with the compiler state to generate the <code>PyCodeObject</code></li>
</ul>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyCodeObject</span> <span class="o">*</span>
<span class="n">assemble</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addNone</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">basicblock</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">entryblock</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">assembler</span> <span class="n">a</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">;</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Make sure every block that falls off the end returns None.</span>
<span class="cm">       XXX NEXT_BLOCK() isn&#39;t quite right, because if the last</span>
<span class="cm">       block ends with a jump or return b_next shouldn&#39;t set.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_curblock</span><span class="o">-&gt;</span><span class="n">b_return</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NEXT_BLOCK</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">addNone</span><span class="p">)</span>
</span><span class="hll">            <span class="n">ADDOP_LOAD_CONST</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Py_None</span><span class="p">);</span>
</span><span class="hll">        <span class="n">ADDOP</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">RETURN_VALUE</span><span class="p">);</span>
</span>    <span class="p">}</span>
    <span class="p">...</span>
<span class="hll">    <span class="n">dfs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">entryblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>
</span>
    <span class="cm">/* Can&#39;t modify the bytecode after computing jump offsets. */</span>
<span class="hll">    <span class="n">assemble_jump_offsets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span>
    <span class="cm">/* Emit code in reverse postorder from dfs. */</span>
<span class="hll">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">a_nblocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">a_postorder</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class="hll">        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">b_iused</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class="hll">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">assemble_emit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b_instr</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span class="hll">                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span>    <span class="p">...</span>

    <span class="n">co</span> <span class="o">=</span> <span class="n">makecode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
<span class="hll"> <span class="nl">error</span><span class="p">:</span>
</span>    <span class="n">assemble_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">co</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The depth-first-search is performed by the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L5397"><code>dfs()</code></a> function in <code>Python/compile.c</code>, which follows the the <code>b_next</code> pointers in each of the blocks, marks them as seen by toggling <code>b_seen</code> and then adds them to the assemblers <code>**a_postorder</code> list in reverse order.</p>
<p>The function loops back over the assembler&rsquo;s post-order list and for each block, if it has a jump operation, recursively call <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L5397"><code>dfs()</code></a> for that jump:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span>
<span class="n">dfs</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">basicblock</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">assembler</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="cm">/* Get rid of recursion for normal control flow.</span>
<span class="cm">       Since the number of blocks is limited, unused space in a_postorder</span>
<span class="cm">       (from a_nblocks to end) can be used as a stack for still not ordered</span>
<span class="cm">       blocks. */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b_seen</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">b_next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">b</span><span class="o">-&gt;</span><span class="n">b_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">a_nblocks</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">);</span>
        <span class="n">a</span><span class="o">-&gt;</span><span class="n">a_postorder</span><span class="p">[</span><span class="o">--</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">a_postorder</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">b_iused</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">struct</span> <span class="nc">instr</span> <span class="o">*</span><span class="n">instr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">b_instr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">i_jrel</span> <span class="o">||</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">i_jabs</span><span class="p">)</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">i_target</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">a_nblocks</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">);</span>
        <span class="n">a</span><span class="o">-&gt;</span><span class="n">a_postorder</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">a_nblocks</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="creating-a-code-object"><h4>Creating a Code Object<a class="headerlink" href="#creating-a-code-object" title="Permanent link"></a></h4>
<p>The task of <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L5854"><code>makecode()</code></a> is to go through the compiler state, some of the assembler&rsquo;s properties and to put these into a <code>PyCodeObject</code> by calling <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/codeobject.c#L246"><code>PyCode_New()</code></a>:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/codeobject.9c054576627c.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/codeobject.9c054576627c.png" width="201" height="550" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/codeobject.9c054576627c.png&amp;w=50&amp;sig=9d1c4ff65adb0d6d578b775ca93a88843a3742c1 50w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/codeobject.9c054576627c.png&amp;w=100&amp;sig=076765eedb49d9e4e944629435b5a0fc10942c4c 100w, https://files.realpython.com/media/codeobject.9c054576627c.png 201w" sizes="75vw" alt="PyCodeObject structure" data-asset="1314" /></a></figure>
<p>The variable names, constants are put as properties to the code object:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyCodeObject</span> <span class="o">*</span>
<span class="n">makecode</span><span class="p">(</span><span class="k">struct</span> <span class="nc">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">assembler</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>

    <span class="n">consts</span> <span class="o">=</span> <span class="n">consts_dict_keys_inorder</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_consts</span><span class="p">);</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">dict_keys_inorder</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_names</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="n">dict_keys_inorder</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_varnames</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">...</span>
    <span class="n">cellvars</span> <span class="o">=</span> <span class="n">dict_keys_inorder</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_cellvars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">...</span>
    <span class="n">freevars</span> <span class="o">=</span> <span class="n">dict_keys_inorder</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_freevars</span><span class="p">,</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">cellvars</span><span class="p">));</span>
<span class="p">...</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">compute_code_flags</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">bytecode</span> <span class="o">=</span> <span class="n">PyCode_Optimize</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">a_bytecode</span><span class="p">,</span> <span class="n">consts</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">a_lnotab</span><span class="p">);</span>
<span class="p">...</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">PyCode_NewWithPosOnlyArgs</span><span class="p">(</span><span class="n">posonlyargcount</span><span class="o">+</span><span class="n">posorkeywordargcount</span><span class="p">,</span>
                                   <span class="n">posonlyargcount</span><span class="p">,</span> <span class="n">kwonlyargcount</span><span class="p">,</span> <span class="n">nlocals_int</span><span class="p">,</span> 
                                   <span class="n">maxdepth</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">bytecode</span><span class="p">,</span> <span class="n">consts</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span>
                                   <span class="n">varnames</span><span class="p">,</span> <span class="n">freevars</span><span class="p">,</span> <span class="n">cellvars</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">c_filename</span><span class="p">,</span>
                                   <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_name</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">u_firstlineno</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">a_lnotab</span><span class="p">);</span>
<span class="p">...</span>
    <span class="k">return</span> <span class="n">co</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>You may also notice that the bytecode is sent to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/peephole.c#L230"><code>PyCode_Optimize()</code></a> before it is sent to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/codeobject.c#L106"><code>PyCode_NewWithPosOnlyArgs()</code></a>. This function is part of the bytecode optimization process in <code>Python/peephole.c</code>.</p>
<p>The peephole optimizer goes through the bytecode instructions and in certain scenarios, replace them with other instructions. For example, there is an optimizer called &ldquo;constant unfolding&rdquo;, so if you put the following statement into your script:</p>
<div class="highlight python"><pre><span></span><code><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span>
</code></pre></div>
<p>It optimizes that to:</p>
<div class="highlight python"><pre><span></span><code><span class="n">a</span> <span class="o">=</span> <span class="mi">6</span>
</code></pre></div>
<p>Because 1 and 5 are constant values, so the result should always be the same.</p>
</section><section class="section4" id="conclusion_2"><h4>Conclusion<a class="headerlink" href="#conclusion_2" title="Permanent link"></a></h4>
<p>We can pull together all of these stages with the instaviz module:</p>
<div class="highlight python"><pre><span></span><code><span class="kn">import</span> <span class="nn">instaviz</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">4</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>


<span class="n">instaviz</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</code></pre></div>
<p>Will produce an AST graph:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.18.32_pm.4d9a0ea827ff.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.18.32_pm.4d9a0ea827ff.png" width="2788" height="1554" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-20_at_3.18.32_pm.4d9a0ea827ff.png&amp;w=697&amp;sig=9106a1bc23c5cc07f2ef159968c1ba2155a6562d 697w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-20_at_3.18.32_pm.4d9a0ea827ff.png&amp;w=1394&amp;sig=244bebb56c46d0b1eef97b8332afb6bfaa5e3648 1394w, https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.18.32_pm.4d9a0ea827ff.png 2788w" sizes="75vw" alt="Instaviz screenshot 6" data-asset="1243" /></a></figure>
<p>With bytecode instructions in sequence:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.54_pm.6ea8ea532015.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.54_pm.6ea8ea532015.png" width="2536" height="1592" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.54_pm.6ea8ea532015.png&amp;w=634&amp;sig=f499889305c84679bdf07256f978975bbbc98c03 634w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.54_pm.6ea8ea532015.png&amp;w=1268&amp;sig=8d86595bce0f05c8dc45c3db3c0bff9b2d9cb0a9 1268w, https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.54_pm.6ea8ea532015.png 2536w" sizes="75vw" alt="Instaviz screenshot 7" data-asset="1244" /></a></figure>
<p>Also, the code object with the variable names, constants, and binary <code>co_code</code>:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.41_pm.231a0678f142.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.41_pm.231a0678f142.png" width="2098" height="940" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.41_pm.231a0678f142.png&amp;w=524&amp;sig=6daa3f3b9841eabbbf87d73886b81d346cdb33b3 524w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.41_pm.231a0678f142.png&amp;w=1049&amp;sig=7b074cc948021547f3da60e6bf0be3747585c6c8 1049w, https://files.realpython.com/media/Screen_Shot_2019-03-20_at_3.17.41_pm.231a0678f142.png 2098w" sizes="75vw" alt="Instaviz screenshot 8" data-asset="1245" /></a></figure>
<div><div class="rounded border border-light" style="display:block;position:relative;"><div style="display:block;width:100%;padding-top:12.5%;"></div><div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div></div><a class="small text-muted" href="/account/join/" rel="nofollow"><i aria-hidden="true" class="fa fa-info-circle"> </i> Remove ads</a></div></section></section><section class="section3" id="execution"><h3>Execution<a class="headerlink" href="#execution" title="Permanent link"></a></h3>
<p>In <code>Python/pythonrun.c</code> we broke out just before the call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1094"><code>run_eval_code_obj()</code></a>.</p>
<p>This call takes a code object, either fetched from the marshaled <code>.pyc</code> file, or compiled through the AST and compiler stages.</p>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/pythonrun.c#L1094"><code>run_eval_code_obj()</code></a> will pass the globals, locals, <code>PyArena</code>, and compiled <code>PyCodeObject</code> to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L716"><code>PyEval_EvalCode()</code></a> in <code>Python/ceval.c</code>.</p>
<p>This stage forms the execution component of CPython. Each of the bytecode operations is taken and executed using a <a href="http://www.cs.uwm.edu/classes/cs315/Bacon/Lecture/HTML/ch10s07.html">&ldquo;Stack Frame&rdquo; based system</a>.</p>
<div class="alert alert-primary" role="alert">
<p><strong>What is a Stack Frame?</strong></p>
<p>Stack Frames are a data type used by many runtimes, not just Python, that allows functions to be called and variables to be returned between functions. Stack Frames also contain arguments, local variables, and other state information.</p>
<p>Typically, a Stack Frame exists for every function call, and they are stacked in sequence. You can see CPython&rsquo;s frame stack anytime an exception is unhandled and the stack is printed on the screen.</p>
</div>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L716"><code>PyEval_EvalCode()</code></a> is the public API for evaluating a code object. The logic for evaluation is split between <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L4045"><code>_PyEval_EvalCodeWithName()</code></a> and <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L745"><code>_PyEval_EvalFrameDefault()</code></a>, which are both in <code>ceval.c</code>.</p>
<p>The public API <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L716"><code>PyEval_EvalCode()</code></a> will construct an execution frame from the top of the stack by calling <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L4045"><code>_PyEval_EvalCodeWithName()</code></a>.</p>
<p>The construction of the first execution frame has many steps:</p>
<ol>
<li>Keyword and positional arguments are resolved.</li>
<li>The use of <a href="https://realpython.com/python-kwargs-and-args/"><code>*args</code> and <code>**kwargs</code></a> in function definitions are resolved.</li>
<li>Arguments are added as local variables to the scope.</li>
<li>Co-routines and <a href="https://realpython.com/introduction-to-python-generators/">Generators</a> are created, including the Asynchronous Generators.</li>
</ol>
<p>The frame object looks like this:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/PyFrameObject.8616eee0503e.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/PyFrameObject.8616eee0503e.png" width="161" height="408" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PyFrameObject.8616eee0503e.png&amp;w=40&amp;sig=5c85bcc7939e61d207a19cf82d23cab3f73ec760 40w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PyFrameObject.8616eee0503e.png&amp;w=80&amp;sig=25333bbe22791650facbac4288bb9f49065fb014 80w, https://files.realpython.com/media/PyFrameObject.8616eee0503e.png 161w" sizes="75vw" alt="PyFrameObject structure" data-asset="1313" /></a></figure>
<p>Let&rsquo;s step through those sequences.</p>
<section class="section4" id="1-constructing-thread-state"><h4>1. Constructing Thread State<a class="headerlink" href="#1-constructing-thread-state" title="Permanent link"></a></h4>
<p>Before a frame can be executed, it needs to be referenced from a thread. CPython can have many threads running at any one time within a single interpreter. An Interpreter state includes a list of those threads as a linked list. The thread structure is called <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/pystate.h#L23"><code>PyThreadState</code></a>, and there are many references throughout <code>ceval.c</code>.</p>
<p>Here is the structure of the thread state object:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/PyThreadState.20467f3689b7.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/PyThreadState.20467f3689b7.png" width="201" height="208" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PyThreadState.20467f3689b7.png&amp;w=50&amp;sig=90efd8d98ffa8ad9ed8b233c1e73fa469e4db4ac 50w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PyThreadState.20467f3689b7.png&amp;w=100&amp;sig=e5d4a21dbc5cce9c1017a6d1805cf9eedf03ac9c 100w, https://files.realpython.com/media/PyThreadState.20467f3689b7.png 201w" sizes="75vw" alt="PyThreadState structure" data-asset="1312" /></a></figure>
</section><section class="section4" id="2-constructing-frames"><h4>2. Constructing Frames<a class="headerlink" href="#2-constructing-frames" title="Permanent link"></a></h4>
<p>The input to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L716"><code>PyEval_EvalCode()</code></a> and therefore <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L4045"><code>_PyEval_EvalCodeWithName()</code></a> has arguments for:</p>
<ul>
<li><strong><code>_co</code>:</strong> a <code>PyCodeObject</code></li>
<li><strong><code>globals</code>:</strong> a <code>PyDict</code> with variable names as keys and their values</li>
<li><strong><code>locals</code>:</strong> a <code>PyDict</code> with variable names as keys and their values</li>
</ul>
<p>The other arguments are optional, and not used for the basic API:</p>
<ul>
<li><strong><code>args</code>:</strong> a <code>PyTuple</code> with positional argument values in order, and <code>argcount</code> for the number of values</li>
<li><strong><code>kwnames</code>:</strong> a list of keyword argument names</li>
<li><strong><code>kwargs</code>:</strong> a list of keyword argument values, and <code>kwcount</code> for the number of them</li>
<li><strong><code>defs</code>:</strong> a list of default values for positional arguments, and <code>defcount</code> for the length</li>
<li><strong><code>kwdefs</code>:</strong> a dictionary with the default values for keyword arguments</li>
<li><strong><code>closure</code>:</strong> a tuple with strings to merge into the code objects <code>co_freevars</code> field</li>
<li><strong><code>name</code>:</strong> the name for this evaluation statement as a string</li>
<li><strong><code>qualname</code>:</strong> the qualified name for this evaluation statement as a string</li>
</ul>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">_PyEval_EvalCodeWithName</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">_co</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span>
           <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">argcount</span><span class="p">,</span>
           <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">,</span>
           <span class="n">Py_ssize_t</span> <span class="n">kwcount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kwstep</span><span class="p">,</span>
           <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">defs</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">defcount</span><span class="p">,</span>
           <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwdefs</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">closure</span><span class="p">,</span>
           <span class="n">PyObject</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">qualname</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="n">_PyThreadState_GET</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">globals</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_PyErr_SetString</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">PyExc_SystemError</span><span class="p">,</span>
                         <span class="s">&quot;PyEval_EvalCodeEx: NULL globals&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Create the frame */</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">_PyFrame_New_NoTrack</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fastlocals</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_localsplus</span><span class="p">;</span>
    <span class="n">freevars</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_localsplus</span> <span class="o">+</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_nlocals</span><span class="p">;</span>
</code></pre></div>
</section><section class="section4" id="3-converting-keyword-parameters-to-a-dictionary"><h4>3. Converting Keyword Parameters to a Dictionary<a class="headerlink" href="#3-converting-keyword-parameters-to-a-dictionary" title="Permanent link"></a></h4>
<p>If the function definition contained a <code>**kwargs</code> style catch-all for keyword arguments, then a new dictionary is created, and the values are copied across. The <code>kwargs</code> name is then set as a variable, like in this example:</p>
<div class="highlight python"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">])</span>  <span class="c1"># this would resolve to a dictionary key</span>
</code></pre></div>
<p>The logic for creating a keyword argument dictionary is in the next part of <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L4045">_PyEval_EvalCodeWithName()</a>:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Create a dictionary for keyword parameters (**kwargs) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARKEYWORDS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kwdict</span> <span class="o">=</span> <span class="n">PyDict_New</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwdict</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">total_args</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARARGS</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">kwdict</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">kwdict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>The <code>kwdict</code> variable will reference a <code>PyDictObject</code> if any keyword arguments were found.</p>
</section><section class="section4" id="4-converting-positional-arguments-into-variables"><h4>4. Converting Positional Arguments Into Variables<a class="headerlink" href="#4-converting-positional-arguments-into-variables" title="Permanent link"></a></h4>
<p>Next, each of the positional arguments (if provided) are set as local variables:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Copy all positional arguments into local variables */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argcount</span> <span class="o">&gt;</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_argcount</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_argcount</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">argcount</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
        <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>At the end of the loop, you&rsquo;ll see a call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L1005"><code>SETLOCAL()</code></a> with the value, so if a positional argument is defined with a value, that is available within this scope: </p>
<div class="highlight python"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>  <span class="c1"># both args are already local variables.</span>
</code></pre></div>
<p>Also, the reference counter for those variables is incremented, so the garbage collector won&rsquo;t remove them until the frame has evaluated.</p>
</section><section class="section4" id="5-packing-positional-arguments-into-args"><h4>5. Packing Positional Arguments Into <code>*args</code><a class="headerlink" href="#5-packing-positional-arguments-into-args" title="Permanent link"></a></h4>
<p>Similar to <code>**kwargs</code>, a function argument prepended with a <code>*</code> can be set to catch all remaining positional arguments. This argument is a tuple and the <code>*args</code> name is set as a local variable: </p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Pack other positional arguments into the *args argument */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARARGS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">_PyTuple_FromArray</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">argcount</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">total_args</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="6-loading-keyword-arguments"><h4>6. Loading Keyword Arguments<a class="headerlink" href="#6-loading-keyword-arguments" title="Permanent link"></a></h4>
<p>If the function was called with keyword arguments and values, the <code>kwdict</code> dictionary created in step 4 is now filled with any remaining keyword arguments passed by the caller that doesn&rsquo;t resolve to named arguments or positional arguments.</p>
<p>For example, the <code>e</code> argument was neither positional or named, so it is added to <code>**remaining</code>:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">remaining</span><span class="p">):</span>
<span class="go">       print(a, b, c, d, remaining)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">my_function</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="go">(1, 2, 3, 4, {&#39;e&#39;: 5})</span>
</code></pre></div>
<div class="alert alert-primary" role="alert">
<p><strong>Positional-only arguments</strong> is a new feature in Python 3.8. Introduced in <a href="https://www.python.org/dev/peps/pep-0570/">PEP570</a>, positional-only arguments are a way of stopping users of your API from using positional arguments with a keyword syntax.</p>
<p>For example, this simple function converts Farenheit to Celcius. Note, the use of <code>/</code> as a special argument seperates positional-only arguments from the other arguments.</p>
<div class="highlight python"><pre><span></span><code><span class="k">def</span> <span class="nf">to_celcius</span><span class="p">(</span><span class="n">farenheit</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">farenheit</span><span class="o">-</span><span class="mi">31</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span>
</code></pre></div>
<p>All arguments to the left of <code>/</code> must be called only as a positional argument, and arguments to the right can be called as either positional or keyword arguments:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">to_celcius</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span>
</code></pre></div>
<p>Calling the function using a keyword argument to a positional-only argument will raise a <code>TypeError</code>:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">to_celcius</span><span class="p">(</span><span class="n">farenheit</span><span class="o">=</span><span class="mi">110</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">to_celcius() got some positional-only arguments passed as keyword arguments: &#39;farenheit&#39;</span>
</code></pre></div>
</div>
<p>The resolution of the keyword argument dictionary values comes after the unpacking of all other arguments. The PEP570 positional-only arguments are shown by starting the keyword-argument loop at <code>co_posonlyargcount</code>. If the <code>/</code> symbol was used on the 3rd argument, the value of <code>co_posonlyargcount</code> would be <code>2</code>.
<code>PyDict_SetItem()</code> is called for each remaining argument to add it to the <code>locals</code> dictionary, so when executing, each of the keyword arguments are scoped local variables:</p>
<div class="highlight c"><pre><span></span><code>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kwcount</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">kwstep</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">**</span><span class="n">co_varnames</span><span class="p">;</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">kwnames</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">...</span>

        <span class="cm">/* Speed hack: do raw pointer compares. As names are</span>
<span class="cm">           normally interned this should almost always hit. */</span>
        <span class="n">co_varnames</span> <span class="o">=</span> <span class="p">((</span><span class="n">PyTupleObject</span> <span class="o">*</span><span class="p">)(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_varnames</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">ob_item</span><span class="p">;</span>
<span class="hll">        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_posonlyargcount</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">total_args</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span>            <span class="n">PyObject</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">co_varnames</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="n">keyword</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">goto</span> <span class="n">kw_found</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">kwdict</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_posonlyargcount</span>
                <span class="o">&amp;&amp;</span> <span class="n">positional_only_passed_as_keyword</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span>
                                                     <span class="n">kwcount</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">_PyErr_Format</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">PyExc_TypeError</span><span class="p">,</span>
                          <span class="s">&quot;%U() got an unexpected keyword argument &#39;%S&#39;&quot;</span><span class="p">,</span>
                          <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_name</span><span class="p">,</span> <span class="n">keyword</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_SetItem</span><span class="p">(</span><span class="n">kwdict</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>

      <span class="nl">kw_found</span><span class="p">:</span>
        <span class="p">...</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
        <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
</code></pre></div>
<p>At the end of the loop, you&rsquo;ll see a call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L1005"><code>SETLOCAL()</code></a> with the value. If a keyword argument is defined with a value, that is available within this scope:</p>
<div class="highlight python"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">example_kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">example_kwarg</span><span class="p">)</span>  <span class="c1"># example_kwarg is already a local variable.</span>
</code></pre></div>
</section><section class="section4" id="7-adding-missing-positional-arguments"><h4>7. Adding Missing Positional Arguments<a class="headerlink" href="#7-adding-missing-positional-arguments" title="Permanent link"></a></h4>
<p>Any positional arguments provided to a function call that are not in the list of positional arguments are added to a <code>*args</code> tuple if this tuple does not exist, a failure is raised:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Add missing positional arguments (copy default values from defs) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argcount</span> <span class="o">&lt;</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_argcount</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_ssize_t</span> <span class="n">m</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_argcount</span> <span class="o">-</span> <span class="n">defcount</span><span class="p">;</span>
        <span class="n">Py_ssize_t</span> <span class="n">missing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">argcount</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GETLOCAL</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">missing</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">missing_arguments</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">missing</span><span class="p">,</span> <span class="n">defcount</span><span class="p">,</span> <span class="n">fastlocals</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">defcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GETLOCAL</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PyObject</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="n">defs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
                <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">def</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="8-adding-missing-keyword-arguments"><h4>8. Adding Missing Keyword Arguments<a class="headerlink" href="#8-adding-missing-keyword-arguments" title="Permanent link"></a></h4>
<p>Any keyword arguments provided to a function call that are not in the list of named keyword arguments are added to a <code>**kwargs</code> dictionary if this dictionary does not exist, a failure is raised:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Add missing keyword arguments (copy default values from kwdefs) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_kwonlyargcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_ssize_t</span> <span class="n">missing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_argcount</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">total_args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyObject</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GETLOCAL</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kwdefs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">PyObject</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="n">PyDict_GetItemWithError</span><span class="p">(</span><span class="n">kwdefs</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
                <span class="p">...</span>
            <span class="p">}</span>
            <span class="n">missing</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="9-collapsing-closures"><h4>9. Collapsing Closures<a class="headerlink" href="#9-collapsing-closures" title="Permanent link"></a></h4>
<p>Any closure names are added to the code object&rsquo;s list of free variable names:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Copy closure variables to free variables */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_freevars</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">closure</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
        <span class="n">freevars</span><span class="p">[</span><span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_cellvars</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="10-creating-generators-coroutines-and-asynchronous-generators"><h4>10. Creating Generators, Coroutines, and Asynchronous Generators<a class="headerlink" href="#10-creating-generators-coroutines-and-asynchronous-generators" title="Permanent link"></a></h4>
<p>If the evaluated code object has a flag that it is a <a href="https://realpython.com/courses/python-generators/">generator</a>, coroutine or async generator, then a new frame is created using one of the unique methods in the Generator, Coroutine or Async libraries and the current frame is added as a property.</p>
<p>The new frame is then returned, and the original frame is not evaluated. The frame is only evaluated when the generator/coroutine/async method is called on to execute its target:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Handle generator/coroutine/asynchronous generator */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CO_GENERATOR</span> <span class="o">|</span> <span class="n">CO_COROUTINE</span> <span class="o">|</span> <span class="n">CO_ASYNC_GENERATOR</span><span class="p">))</span> <span class="p">{</span>
        <span class="p">...</span>

        <span class="cm">/* Create a new generator that owns the ready to run frame</span>
<span class="cm">         * and return that as the value. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_coro</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">PyCoro_New</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_ASYNC_GENERATOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">PyAsyncGen_New</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">PyGen_NewWithQualName</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="p">...</span>

        <span class="k">return</span> <span class="n">gen</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>Lastly, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L738"><code>PyEval_EvalFrameEx()</code></a> is called with the new frame:</p>
<div class="highlight c"><pre><span></span><code>    <span class="n">retval</span> <span class="o">=</span> <span class="n">PyEval_EvalFrameEx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
</section><section class="section4" id="frame-execution"><h4>Frame Execution<a class="headerlink" href="#frame-execution" title="Permanent link"></a></h4>
<p>As covered earlier in the compiler and AST chapters, the code object contains a binary encoding of the bytecode to be executed. It also contains a list of variables and a symbol table.</p>
<p>The local and global variables are determined at runtime based on how that function, module, or block was called. This information is added to the frame by the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L4045"><code>_PyEval_EvalCodeWithName()</code></a> function. There are other usages of frames, like the coroutine decorator, which dynamically generates a frame with the target as a variable.</p>
<p>The public API, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L738"><code>PyEval_EvalFrameEx()</code></a> calls the interpreter&rsquo;s configured frame evaluation function in the <code>eval_frame</code> property. Frame evaluation was <a href="https://www.python.org/dev/peps/pep-0523/">made pluggable in Python 3.7 with PEP 523</a>.</p>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L745"><code>_PyEval_EvalFrameDefault()</code></a> is the default function, and it is unusual to use anything other than this. </p>
<p>Frames are executed in the main execution loop inside <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L745"><code>_PyEval_EvalFrameDefault()</code></a>. This function is central function that brings everything together and brings your code to life. It contains decades of optimization since even a single line of code can have a significant impact on performance for the whole of CPython.</p>
<p>Everything that gets executed in CPython goes through this function.</p>
<div class="alert alert-primary" role="alert">
<p><strong>Note:</strong> Something you might notice when reading <code>ceval.c</code>, is how many times C macros have been used. C Macros are a way of having DRY-compliant code without the overhead of making function calls. The compiler converts the macros into C code and then compile the generated code. </p>
<p>If you want to see the expanded code, you can run <code>gcc -E</code> on Linux and macOS:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>gcc -E Python/ceval.c
</code></pre></div>
<p>Alternatively, <a href="https://realpython.com/python-development-visual-studio-code/">Visual Studio Code</a> can do inline macro expansion once you have installed the official C/C++ extension:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-25_at_3.33.40_pm.c240b1a46e99.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-03-25_at_3.33.40_pm.c240b1a46e99.png" width="1866" height="622" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-25_at_3.33.40_pm.c240b1a46e99.png&amp;w=466&amp;sig=28bc3a2f62e499a92fdac8fbd951c6ab5a18d361 466w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-25_at_3.33.40_pm.c240b1a46e99.png&amp;w=933&amp;sig=ec297187398d1a9b390bdadedd2c96855b2dfacc 933w, https://files.realpython.com/media/Screen_Shot_2019-03-25_at_3.33.40_pm.c240b1a46e99.png 1866w" sizes="75vw" alt="C Macro expansion with VScode" data-asset="1304" /></a></figure>
</div>
<p>We can step through frame execution in Python 3.7 and beyond by enabling the tracing attribute on the current thread.</p>
<p>This code example sets the global tracing function to a function called <code>trace()</code> that gets the stack from the current frame, prints the disassembled opcodes to the screen, and some extra information for debugging:</p>
<div class="highlight python"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">dis</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
   <span class="n">frame</span><span class="o">.</span><span class="n">f_trace_opcodes</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
   <span class="n">pad</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span>
   <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;opcode&#39;</span><span class="p">:</span>
      <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
         <span class="n">dis</span><span class="o">.</span><span class="n">disco</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lasti</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
         <span class="n">lines</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
         <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad</span><span class="si">}{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
   <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s2">Calling </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s2">Returning </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s2">Changing line to </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad</span><span class="si">}{</span><span class="n">frame</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s2">----------------------------------&quot;</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">trace</span>
<span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

<span class="c1"># Run some code for a demo</span>
<span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;&quot;-&quot;.join([letter for letter in &quot;hello&quot;])&#39;</span><span class="p">)</span>
</code></pre></div>
<p>This prints the code within each stack and point to the next operation before it is executed. When a frame returns a value, the return statement is printed:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Screen_Shot_2019-03-25_at_1.21.07_pm.7b03e9032f62.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Screen_Shot_2019-03-25_at_1.21.07_pm.7b03e9032f62.png" width="2572" height="1686" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-25_at_1.21.07_pm.7b03e9032f62.png&amp;w=643&amp;sig=6d6106abaf9fb5f3d7e45e09320c7575b3a0e77c 643w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Screen_Shot_2019-03-25_at_1.21.07_pm.7b03e9032f62.png&amp;w=1286&amp;sig=c41bf26bd15641fded6a31125b0cb5b630496647 1286w, https://files.realpython.com/media/Screen_Shot_2019-03-25_at_1.21.07_pm.7b03e9032f62.png 2572w" sizes="75vw" alt="Evaluating frame with tracing" data-asset="1303" /></a></figure>
<p>The full list of instructions is available on the <a href="https://docs.python.org/3/library/dis.html#python-bytecode-instructions"><code>dis</code> module</a> documentation. </p>
</section><section class="section4" id="the-value-stack"><h4>The Value Stack<a class="headerlink" href="#the-value-stack" title="Permanent link"></a></h4>
<p>Inside the core evaluation loop, a value stack is created. This stack is a list of pointers to sequential <code>PyObject</code> instances.</p>
<p>One way to think of the value stack is like a wooden peg on which you can stack cylinders. You would only add or remove one item at a time. This is done using the <code>PUSH(a)</code> macro, where <code>a</code> is a pointer to a <code>PyObject</code>.</p>
<p>For example, if you created a <code>PyLong</code> with the value 10 and pushed it onto the value stack:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">PUSH</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</code></pre></div>
<p>This action would have the following effect:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_push.0c755d83b347.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_push.0c755d83b347.png" width="822" height="279" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_push.0c755d83b347.png&amp;w=205&amp;sig=d3ce00e768e8c7f89ef321ea039b159131b39d8a 205w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_push.0c755d83b347.png&amp;w=411&amp;sig=65cf700de41fd59781082f03c5d347fd891ac5a9 411w, https://files.realpython.com/media/stacks_push.0c755d83b347.png 822w" sizes="75vw" alt="PUSH()" data-asset="1389" /></a></figure>
<p>In the next operation, to fetch that value, you would use the <code>POP()</code> macro to take the top value from the stack:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>  <span class="c1">// a is PyLongObject with a value of 10</span>
</code></pre></div>
<p>This action would return the top value and end up with an empty value stack:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_pop.85872baaa8c3.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_pop.85872baaa8c3.png" width="778" height="226" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_pop.85872baaa8c3.png&amp;w=194&amp;sig=887719d9b65d3ef671e2310aae15904e04acba28 194w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_pop.85872baaa8c3.png&amp;w=389&amp;sig=6950fcd6370022df61559d12b74c6b685a61e238 389w, https://files.realpython.com/media/stacks_pop.85872baaa8c3.png 778w" sizes="75vw" alt="POP()" data-asset="1390" /></a></figure>
<p>If you were to add 2 values to the stack:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">PyObject</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="n">PUSH</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="n">PUSH</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</code></pre></div>
<p>They would end up in the order in which they were added, so <code>a</code> would be pushed to the second position in the stack:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_pushpush.e052996db029.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_pushpush.e052996db029.png" width="783" height="226" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_pushpush.e052996db029.png&amp;w=195&amp;sig=47cc1b6b30f314f1589eb9c8188efcd3eb0ef79e 195w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_pushpush.e052996db029.png&amp;w=391&amp;sig=a0813bcc81d314c3f2f0eb146634ba187d447634 391w, https://files.realpython.com/media/stacks_pushpush.e052996db029.png 783w" sizes="75vw" alt="PUSH();PUSH()" data-asset="1391" /></a></figure>
<p>If you were to fetch the top value in the stack, you would get a pointer to <code>b</code> because it is at the top:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_pop2.af5068718f92.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_pop2.af5068718f92.png" width="789" height="226" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_pop2.af5068718f92.png&amp;w=197&amp;sig=1856b32d5f95f58eb2ad60a549165f85bf2b4d7a 197w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_pop2.af5068718f92.png&amp;w=394&amp;sig=ce3ba993ee2fa8cb037bb84144c73f95450954ac 394w, https://files.realpython.com/media/stacks_pop2.af5068718f92.png 789w" sizes="75vw" alt="POP();" data-asset="1392" /></a></figure>
<p>If you need to fetch the pointer to the top value in the stack without popping it, you can use the <code>PEEK(v)</code> operation, where <code>v</code> is the stack position:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">PEEK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
<p>0 represents the top of the stack, 1 would be the second position:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_peek.b00bde86bc7b.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_peek.b00bde86bc7b.png" width="802" height="174" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_peek.b00bde86bc7b.png&amp;w=200&amp;sig=fac4fef886154a979f9abe7316e9468179c14c71 200w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_peek.b00bde86bc7b.png&amp;w=401&amp;sig=463aeb044f65a4c446a37c71cd86ae71564a2ec6 401w, https://files.realpython.com/media/stacks_peek.b00bde86bc7b.png 802w" sizes="75vw" alt="PEEK()" data-asset="1393" /></a></figure>
<p>To clone the value at the top of the stack, the <code>DUP_TWO()</code> macro can be used, or by using the <code>DUP_TWO</code> opcode:</p>
<div class="highlight c"><pre><span></span><code><span class="n">DUP_TOP</span><span class="p">();</span>
</code></pre></div>
<p>This action would copy the value at the top to form 2 pointers to the same object:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_duptop.9b2eafe67375.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_duptop.9b2eafe67375.png" width="799" height="177" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_duptop.9b2eafe67375.png&amp;w=199&amp;sig=3d40e1422f0aa5f3b50b8b174d02f0fe5df54364 199w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_duptop.9b2eafe67375.png&amp;w=399&amp;sig=11e2d5a69b3dd385c9201d7ab4eeb902f8fa20c9 399w, https://files.realpython.com/media/stacks_duptop.9b2eafe67375.png 799w" sizes="75vw" alt="DUP_TOP()" data-asset="1394" /></a></figure>
<p>There is a rotation macro <code>ROT_TWO</code> that swaps the first and second values:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/stacks_rottwo.2990d9b3ecc7.png" target="_blank"><img loading="lazy" class="img-fluid " src="https://files.realpython.com/media/stacks_rottwo.2990d9b3ecc7.png" width="803" height="175" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_rottwo.2990d9b3ecc7.png&amp;w=200&amp;sig=e3e88549e9801f463358ad1e8b5635ba56b77049 200w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/stacks_rottwo.2990d9b3ecc7.png&amp;w=401&amp;sig=d2c11f545336f13fa57bc1588f57b7e7f8dc049f 401w, https://files.realpython.com/media/stacks_rottwo.2990d9b3ecc7.png 803w" sizes="75vw" alt="ROT_TWO()" data-asset="1395" /></a></figure>
<p>Each of the opcodes have a predefined &ldquo;stack effect,&rdquo; calculated by the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L878"><code>stack_effect()</code></a> function inside <code>Python/compile.c</code>. This function returns the delta in the number of values inside the stack for each opcode.</p>
</section><section class="section4" id="example-adding-an-item-to-a-list"><h4>Example: Adding an Item to a List<a class="headerlink" href="#example-adding-an-item-to-a-list" title="Permanent link"></a></h4>
<p>In Python, when you create a list, the <code>.append()</code> method is available on the list object:</p>
<div class="highlight python"><pre><span></span><code><span class="n">my_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">my_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</code></pre></div>
<p>Where <code>obj</code> is an object, you want to append to the end of the list.</p>
<p>There are 2 operations involved in this operation. <code>LOAD_FAST</code>, to load the object <code>obj</code> to the top of the value stack from the list of <code>locals</code> in the frame, and <code>LIST_APPEND</code> to add the object.</p>
<p>First exploring <code>LOAD_FAST</code>, there are 5 steps:</p>
<ol>
<li>
<p>The pointer to <code>obj</code> is loaded from <code>GETLOCAL()</code>, where the variable to load is the operation argument. The list of variable pointers is stored in <code>fastlocals</code>, which is a copy of the PyFrame attribute <code>f_localsplus</code>. The operation argument is a number, pointing to the index in the <code>fastlocals</code> array pointer. This means that the loading of a local is simply a copy of the pointer instead of having to look up the variable name.</p>
</li>
<li>
<p>If variable no longer exists, an unbound local variable error is raised.</p>
</li>
<li>
<p>The reference counter for <code>value</code> (in our case, <code>obj</code>) is increased by 1.</p>
</li>
<li>
<p>The pointer to <code>obj</code> is pushed to the top of the value stack.</p>
</li>
<li>
<p>The <code>FAST_DISPATCH</code> macro is called, if tracing is enabled, the loop goes over again (with all the tracing), if tracing is not enabled, a <code>goto</code> is called to <code>fast_next_opcode</code>, which jumps back to the top of the loop for the next instruction.</p>
</li>
</ol>
<div class="highlight c"><pre><span></span><code> <span class="p">...</span> 
    <span class="k">case</span> <span class="n">TARGET</span><span class="p">(</span><span class="n">LOAD_FAST</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">GETLOCAL</span><span class="p">(</span><span class="n">oparg</span><span class="p">);</span>                 <span class="c1">// 1.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">format_exc_check_arg</span><span class="p">(</span>
                <span class="n">PyExc_UnboundLocalError</span><span class="p">,</span>
                <span class="n">UNBOUNDLOCAL_ERROR_MSG</span><span class="p">,</span>
                <span class="n">PyTuple_GetItem</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">oparg</span><span class="p">));</span>
            <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>                                    <span class="c1">// 2.</span>
        <span class="p">}</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>                                  <span class="c1">// 3.</span>
        <span class="n">PUSH</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>                                       <span class="c1">// 4.</span>
        <span class="n">FAST_DISPATCH</span><span class="p">();</span>                                   <span class="c1">// 5.</span>
    <span class="p">}</span>
 <span class="p">...</span>
</code></pre></div>
<p>Now the pointer to <code>obj</code> is at the top of the value stack. The next instruction <code>LIST_APPEND</code> is run.</p>
<p>Many of the bytecode operations are referencing the base types, like PyUnicode, PyNumber. For example, <code>LIST_APPEND</code> appends an object to the end of a list. To achieve this, it pops the pointer from the value stack and returns the pointer to the last object in the stack. The macro is a shortcut for: </p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="o">*--</span><span class="n">stack_pointer</span><span class="p">);</span>
</code></pre></div>
<p>Now the pointer to <code>obj</code> is stored as <code>v</code>. The list pointer is loaded from <code>PEEK(oparg)</code>.</p>
<p>Then the C API for Python lists is called for <code>list</code> and <code>v</code>. The code for this is inside <code>Objects/listobject.c</code>, which we go into in the next chapter.</p>
<p>A call to <code>PREDICT</code> is made, which guesses that the next operation will be <code>JUMP_ABSOLUTE</code>. The <code>PREDICT</code> macro has compiler-generated <code>goto</code> statements for each of the potential operations&rsquo; <code>case</code> statements. This means the CPU can jump to that instruction and not have to go through the loop again:</p>
<div class="highlight c"><pre><span></span><code> <span class="p">...</span>
        <span class="k">case</span> <span class="n">TARGET</span><span class="p">(</span><span class="n">LIST_APPEND</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
            <span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
            <span class="n">PyObject</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">PEEK</span><span class="p">(</span><span class="n">oparg</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="hll">            <span class="n">err</span> <span class="o">=</span> <span class="n">PyList_Append</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span>            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
            <span class="n">PREDICT</span><span class="p">(</span><span class="n">JUMP_ABSOLUTE</span><span class="p">);</span>
            <span class="n">DISPATCH</span><span class="p">();</span>
        <span class="p">}</span>
 <span class="p">...</span>
</code></pre></div>
<div class="alert alert-primary" role="alert">
<p><strong>Opcode predictions:</strong>
Some opcodes tend to come in pairs thus making it possible to predict the second code when the first is run. For example, <code>COMPARE_OP</code> is often followed by <code>POP_JUMP_IF_FALSE</code> or <code>POP_JUMP_IF_TRUE</code>.</p>
<p>&ldquo;Verifying the prediction costs a single high-speed test of a register variable against a constant. If the pairing was good, then the processor&rsquo;s own internal branch predication has a high likelihood of success, resulting in a nearly zero-overhead transition to the next opcode. A successful prediction saves a trip through the eval-loop including its unpredictable switch-case branch. Combined with the processor&rsquo;s internal branch prediction, a successful PREDICT has the effect of making the two opcodes run as if they were a single new opcode with the bodies combined.&rdquo;</p>
<p>If collecting opcode statistics, you have two choices:</p>
<ol>
<li>Keep the predictions turned-on and interpret the results as if some opcodes had been combined</li>
<li>Turn off predictions so that the opcode frequency counter updates for both opcodes</li>
</ol>
<p>Opcode prediction is disabled with threaded code since the latter allows the CPU to record separate branch prediction information for each opcode.</p>
</div>
<p>Some of the operations, such as <code>CALL_FUNCTION</code>, <code>CALL_METHOD</code>, have an operation argument referencing another compiled function. In these cases, another frame is pushed to the frame stack in the thread, and the evaluation loop is run for that function until the function completes. Each time a new frame is created and pushed onto the stack, the value of the frame&rsquo;s <code>f_back</code> is set to the current frame before the new one is created.</p>
<p>This nesting of frames is clear when you see a stack trace, take this example script:</p>
<div class="highlight python"><pre><span></span><code><span class="k">def</span> <span class="nf">function2</span><span class="p">():</span>
  <span class="k">raise</span> <span class="ne">RuntimeError</span>

<span class="k">def</span> <span class="nf">function1</span><span class="p">():</span>
  <span class="n">function2</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">function1</span><span class="p">()</span>
</code></pre></div>
<p>Calling this on the command line will give you:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>./python.exe example_stack.py

<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;example_stack.py&quot;, line 8, in &lt;module&gt;</span>
<span class="go">    function1()</span>
<span class="go">  File &quot;example_stack.py&quot;, line 5, in function1</span>
<span class="go">    function2()</span>
<span class="go">  File &quot;example_stack.py&quot;, line 2, in function2</span>
<span class="go">    raise RuntimeError</span>
<span class="go">RuntimeError</span>
</code></pre></div>
<p>In <code>traceback.py</code>, the <code>walk_stack()</code> function used to print trace backs:</p>
<div class="highlight python"><pre><span></span><code><span class="k">def</span> <span class="nf">walk_stack</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walk a stack yielding the frame and line number for each frame.</span>

<span class="sd">    This will follow f.f_back from the given frame. If no frame is given, the</span>
<span class="sd">    current stack is used. Usually used with StackSummary.extract.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_back</span>
    <span class="k">while</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">f_lineno</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span>
</code></pre></div>
<p>Here you can see that the current frame, fetched by calling <code>sys._getframe()</code> and the parent&rsquo;s parent is set as the frame, because you don&rsquo;t want to see the call to <code>walk_stack()</code> or <code>print_trace()</code> in the trace back, so those function frames are skipped.</p>
<p>Then the <code>f_back</code> pointer is followed to the top.</p>
<p><code>sys._getframe()</code> is the Python API to get the <code>frame</code> attribute of the current thread.</p>
<p>Here is how that frame stack would look visually, with 3 frames each with its code object and a thread state pointing to the current frame:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/Frame_Stack_Example.20728854763c.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/Frame_Stack_Example.20728854763c.png" width="841" height="1556" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Frame_Stack_Example.20728854763c.png&amp;w=210&amp;sig=bb2e7a72a4363554566003b8412f81c843a8edc2 210w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/Frame_Stack_Example.20728854763c.png&amp;w=420&amp;sig=17eddfb3f22ccab1056545af3055470669c4ce3f 420w, https://files.realpython.com/media/Frame_Stack_Example.20728854763c.png 841w" sizes="75vw" alt="Example frame stack" data-asset="1315" /></a></figure>
</section></section><section class="section3" id="conclusion_3"><h3>Conclusion<a class="headerlink" href="#conclusion_3" title="Permanent link"></a></h3>
<p>In this Part, you explored the most complex element of CPython: the compiler. The original author of Python, Guido van Rossum, made the statement that CPython&rsquo;s compiler should be &ldquo;dumb&rdquo; so that people can understand it.</p>
<p>By breaking down the compilation process into small, logical steps, it is far easier to understand.</p>
<p>In the next chapter, we connect the compilation process with the basis of all Python code, the <code>object</code>.</p>
</section></section><section class="section2" h1="h1" id="part-4-objects-in-cpython"><h2>Part 4: Objects in CPython<a class="headerlink" href="#part-4-objects-in-cpython" title="Permanent link"></a></h2>
<p>CPython comes with a collection of basic types like strings, lists, tuples, dictionaries, and objects.</p>
<p>All of these types are built-in. You don&rsquo;t need to import any libraries, even from the standard library. Also, the instantiation of these built-in types has some handy shortcuts.</p>
<p>For example, to create a new list, you can call:</p>
<div class="highlight python"><pre><span></span><code><span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</code></pre></div>
<p>Or, you can use square brackets:</p>
<div class="highlight python"><pre><span></span><code><span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
<p>Strings can be instantiated from a string-literal by using either double or single quotes. We explored the grammar definitions earlier that cause the compiler to interpret double quotes as a string literal. </p>
<p>All types in Python inherit from <code>object</code>, a built-in base type. Even strings, tuples, and list inherit from <code>object</code>. During the walk-through of the C code, you have read lots of references to <code>PyObject*</code>, the C-API structure for an <code>object</code>.</p>
<p>Because C is not object-oriented <a href="https://realpython.com/python3-object-oriented-programming/">like Python</a>, objects in C don&rsquo;t inherit from one another. <code>PyObject</code> is the data structure for the beginning of the Python object&rsquo;s memory.</p>
<p>Much of the base object API is declared in <code>Objects/object.c</code>, like the function <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L505"><code>PyObject_Repr</code></a>, which the built-in <code>repr()</code> function. You will also find <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L810"><code>PyObject_Hash()</code></a> and other APIs.</p>
<p>All of these functions can be overridden in a custom object by implementing &ldquo;dunder&rdquo; methods on a Python object:</p>
<div class="highlight python"><pre><span></span><code><span class="k">class</span> <span class="nc">MyObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> 
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{0}</span><span class="s2"> id=</span><span class="si">{1}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
<p>This code is implemented in <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/object.c#L505"><code>PyObject_Repr()</code></a>, inside <code>Objects/object.c</code>. The type of the target object, <code>v</code> will be inferred through a call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/object.h#L122"><code>Py_TYPE()</code></a> and if the <code>tp_repr</code> field is set, then the function pointer is called.
If the <code>tp_repr</code> field is not set, i.e. the object doesn&rsquo;t declare a custom <code>__repr__</code> method, then the default behavior is run, which is to return <code>"&lt;%s object at %p&gt;"</code> with the type name and the ID:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyObject_Repr</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyErr_CheckSignals</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="s">&quot;&lt;NULL&gt;&quot;</span><span class="p">);</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_repr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span>        <span class="k">return</span> <span class="n">PyUnicode_FromFormat</span><span class="p">(</span><span class="s">&quot;&lt;%s object at %p&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_name</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

<span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>The ob_type field for a given <code>PyObject*</code> will point to the data structure <code>PyTypeObject</code>, defined in <code>Include/cpython/object.h</code>.
This data-structure lists all the built-in functions, as fields and the arguments they should receive.</p>
<p>Take <code>tp_repr</code> as an example:</p>
<div class="highlight c"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_typeobject</span> <span class="p">{</span>
    <span class="n">PyObject_VAR_HEAD</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tp_name</span><span class="p">;</span> <span class="cm">/* For printing, in format &quot;&lt;module&gt;.&lt;name&gt;&quot; */</span>
    <span class="n">Py_ssize_t</span> <span class="n">tp_basicsize</span><span class="p">,</span> <span class="n">tp_itemsize</span><span class="p">;</span> <span class="cm">/* For allocation */</span>

    <span class="cm">/* Methods to implement standard operations */</span>
<span class="p">...</span>
<span class="hll">    <span class="n">reprfunc</span> <span class="n">tp_repr</span><span class="p">;</span>
</span></code></pre></div>
<p>Where <code>reprfunc</code> is a <code>typedef</code> for <code>PyObject *(*reprfunc)(PyObject *);</code>, a function that takes 1 pointer to <code>PyObject</code> (<code>self</code>).</p>
<p>Some of the dunder APIs are optional, because they only apply to certain types, like numbers:</p>
<div class="highlight c"><pre><span></span><code>    <span class="cm">/* Method suites for standard classes */</span>

    <span class="n">PyNumberMethods</span> <span class="o">*</span><span class="n">tp_as_number</span><span class="p">;</span>
    <span class="n">PySequenceMethods</span> <span class="o">*</span><span class="n">tp_as_sequence</span><span class="p">;</span>
    <span class="n">PyMappingMethods</span> <span class="o">*</span><span class="n">tp_as_mapping</span><span class="p">;</span>
</code></pre></div>
<p>A sequence, like a list would implement the following methods:</p>
<div class="highlight c"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">lenfunc</span> <span class="n">sq_length</span><span class="p">;</span> <span class="c1">// len(v)</span>
    <span class="n">binaryfunc</span> <span class="n">sq_concat</span><span class="p">;</span> <span class="c1">// v + x</span>
    <span class="n">ssizeargfunc</span> <span class="n">sq_repeat</span><span class="p">;</span> <span class="c1">// for x in v</span>
    <span class="n">ssizeargfunc</span> <span class="n">sq_item</span><span class="p">;</span> <span class="c1">// v[x]</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">was_sq_slice</span><span class="p">;</span> <span class="c1">// v[x:y:z]</span>
    <span class="n">ssizeobjargproc</span> <span class="n">sq_ass_item</span><span class="p">;</span> <span class="c1">// v[x] = z</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">was_sq_ass_slice</span><span class="p">;</span> <span class="c1">// v[x:y] = z</span>
    <span class="n">objobjproc</span> <span class="n">sq_contains</span><span class="p">;</span> <span class="c1">// x in v</span>

    <span class="n">binaryfunc</span> <span class="n">sq_inplace_concat</span><span class="p">;</span>
    <span class="n">ssizeargfunc</span> <span class="n">sq_inplace_repeat</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PySequenceMethods</span><span class="p">;</span>
</code></pre></div>
<p>All of these built-in functions are called the <a href="https://docs.python.org/3/reference/datamodel.html">Python Data Model</a>. One of the great resources for the Python Data Model is <a href="https://www.oreilly.com/library/view/fluent-python/9781491946237/">&ldquo;Fluent Python&rdquo; by Luciano Ramalho</a>.</p>
<section class="section3" id="base-object-type"><h3>Base Object Type<a class="headerlink" href="#base-object-type" title="Permanent link"></a></h3>
<p>In <code>Objects/object.c</code>, the base implementation of <code>object</code> type is written as pure C code. There are some concrete implementations of basic logic, like shallow comparisons.</p>
<p>Not all methods in a Python object are part of the Data Model, so that a Python object can contain attributes (either class or instance attributes) and methods.</p>
<p>A simple way to think of a Python object is consisting of 2 things:</p>
<ol>
<li>The core data model, with pointers to compiled functions</li>
<li>A dictionary with any custom attributes and methods</li>
</ol>
<p>The core data model is defined in the <code>PyTypeObject</code>, and the functions are defined in:</p>
<ul>
<li><code>Objects/object.c</code> for the built-in methods</li>
<li><code>Objects/boolobject.c</code> for the <code>bool</code> type</li>
<li><code>Objects/bytearrayobject.c</code> for the <code>byte[]</code> type</li>
<li><code>Objects/bytesobjects.c</code> for the <code>bytes</code> type</li>
<li><code>Objects/cellobject.c</code> for the <code>cell</code> type</li>
<li><code>Objects/classobject.c</code> for the abstract <code>class</code> type, used in meta-programming</li>
<li><code>Objects/codeobject.c</code> used for the built-in <code>code</code> object type</li>
<li><code>Objects/complexobject.c</code> for a complex numeric type</li>
<li><code>Objects/iterobject.c</code> for an iterator</li>
<li><code>Objects/listobject.c</code> for the <code>list</code> type</li>
<li><code>Objects/longobject.c</code> for the <code>long</code> numeric type</li>
<li><code>Objects/memoryobject.c</code> for the base memory type</li>
<li><code>Objects/methodobject.c</code> for the class method type</li>
<li><code>Objects/moduleobject.c</code> for a module type</li>
<li><code>Objects/namespaceobject.c</code> for a namespace type</li>
<li><code>Objects/odictobject.c</code> for an ordered dictionary type</li>
<li><code>Objects/rangeobject.c</code> for a range generator</li>
<li><code>Objects/setobject.c</code> for a <code>set</code> type</li>
<li><code>Objects/sliceobject.c</code> for a slice reference type</li>
<li><code>Objects/structseq.c</code> for a <a href="https://docs.python.org/3/library/struct.html#struct.Struct"><code>struct.Struct</code></a> type</li>
<li><code>Objects/tupleobject.c</code> for a <code>tuple</code> type</li>
<li><code>Objects/typeobject.c</code> for a <code>type</code> type</li>
<li><code>Objects/unicodeobject.c</code> for a <code>str</code> type</li>
<li><code>Objects/weakrefobject.c</code> for a <a href="https://docs.python.org/3/library/weakref.html"><code>weakref</code> object</a></li>
</ul>
<p>We&rsquo;re going to dive into 3 of these types: </p>
<ol>
<li>Booleans </li>
<li>Integers</li>
<li>Generators</li>
</ol>
<p>Booleans and Integers have a lot in common, so we&rsquo;ll cover those first.</p>
</section><section class="section3" id="the-bool-and-long-integer-type"><h3>The Bool and Long Integer Type<a class="headerlink" href="#the-bool-and-long-integer-type" title="Permanent link"></a></h3>
<p>The <code>bool</code> type is the most straightforward implementation of the built-in types. It inherits from <code>long</code> and has the predefined constants, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/boolobject.h#L22"><code>Py_True</code></a> and <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/boolobject.h#L21"><code>Py_False</code></a>. These constants are immutable instances, created on the instantiation of the Python interpreter.</p>
<p>Inside <code>Objects/boolobject.c</code>, you can see the helper function to create a <code>bool</code> instance from a number:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span><span class="nf">PyBool_FromLong</span><span class="p">(</span><span class="kt">long</span> <span class="n">ok</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Py_True</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Py_False</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>This function uses the C evaluation of a numeric type to assign <code>Py_True</code> or <code>Py_False</code> to a result and increment the reference counters.</p>
<p>The numeric functions for <code>and</code>, <code>xor</code>, and <code>or</code> are implemented, but addition, subtraction, and division are dereferenced from the base long type since it would make no sense to divide two boolean values.</p>
<p>The implementation of <code>and</code> for a <code>bool</code> value checks if <code>a</code> and <code>b</code> are booleans, then check their references to <code>Py_True</code>, otherwise, are cast as numbers, and the <code>and</code> operation is run on the two numbers:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">bool_and</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyBool_Check</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">PyBool_Check</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">PyLong_Type</span><span class="p">.</span><span class="n">tp_as_number</span><span class="o">-&gt;</span><span class="n">nb_and</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">PyBool_FromLong</span><span class="p">((</span><span class="n">a</span> <span class="o">==</span> <span class="n">Py_True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">Py_True</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>long</code> type is a bit more complex, as the memory requirements are expansive. In the transition from Python 2 to 3, CPython dropped support for the <code>int</code> type and instead used the <code>long</code> type as the primary integer type. Python&rsquo;s <code>long</code> type is quite special in that it can store a variable-length number. The maximum length is set in the compiled binary.</p>
<p>The data structure of a Python <code>long</code> consists of the <code>PyObject</code> header and a list of digits. The list of digits, <code>ob_digit</code> is initially set to have one digit, but it later expanded to a longer length when initialized:</p>
<div class="highlight c"><pre><span></span><code><span class="k">struct</span> <span class="nc">_longobject</span> <span class="p">{</span>
    <span class="n">PyObject_VAR_HEAD</span>
    <span class="n">digit</span> <span class="n">ob_digit</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>
<p>Memory is allocated to a new <code>long</code> through <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/longobject.c#L262"><code>_PyLong_New()</code></a>. This function takes a fixed length and makes sure it is smaller than <code>MAX_LONG_DIGITS</code>. Then it reallocates the memory for <code>ob_digit</code> to match the length.</p>
<p>To convert a C <code>long</code> type to a Python <code>long</code> type, the <code>long</code> is converted to a list of digits, the memory for the Python <code>long</code> is assigned, and then each of the digits is set.
Because <code>long</code> is initialized with <code>ob_digit</code> already being at a length of 1, if the number is less than 10, then the value is set without the memory being allocated:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyLong_FromLong</span><span class="p">(</span><span class="kt">long</span> <span class="n">ival</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyLongObject</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">abs_ival</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>  <span class="cm">/* unsigned so &gt;&gt; doesn&#39;t propagate sign bit */</span>
    <span class="kt">int</span> <span class="n">ndigits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sign</span><span class="p">;</span>

    <span class="n">CHECK_SMALL_INT</span><span class="p">(</span><span class="n">ival</span><span class="p">);</span>
<span class="p">...</span>
    <span class="cm">/* Fast path for single-digit ints */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">abs_ival</span> <span class="o">&gt;&gt;</span> <span class="n">PyLong_SHIFT</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">_PyLong_New</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Py_SIZE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">sign</span><span class="p">;</span>
            <span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_digit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Py_SAFE_DOWNCAST</span><span class="p">(</span>
                <span class="n">abs_ival</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">digit</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">...</span>
    <span class="cm">/* Larger numbers: loop to determine number of digits */</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">abs_ival</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">ndigits</span><span class="p">;</span>
        <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="n">PyLong_SHIFT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">_PyLong_New</span><span class="p">(</span><span class="n">ndigits</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">digit</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_digit</span><span class="p">;</span>
        <span class="n">Py_SIZE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">ndigits</span><span class="o">*</span><span class="n">sign</span><span class="p">;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">abs_ival</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">Py_SAFE_DOWNCAST</span><span class="p">(</span>
                <span class="n">t</span> <span class="o">&amp;</span> <span class="n">PyLong_MASK</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">digit</span><span class="p">);</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="n">PyLong_SHIFT</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>To convert a <a href="https://en.wikipedia.org/wiki/Double-precision_floating-point_format">double-point floating point</a> to a Python <code>long</code>, <code>PyLong_FromDouble()</code> does the math for you:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyLong_FromDouble</span><span class="p">(</span><span class="kt">double</span> <span class="n">dval</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyLongObject</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">frac</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ndig</span><span class="p">,</span> <span class="n">expo</span><span class="p">,</span> <span class="n">neg</span><span class="p">;</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Py_IS_INFINITY</span><span class="p">(</span><span class="n">dval</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_OverflowError</span><span class="p">,</span>
                        <span class="s">&quot;cannot convert float infinity to integer&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Py_IS_NAN</span><span class="p">(</span><span class="n">dval</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_ValueError</span><span class="p">,</span>
                        <span class="s">&quot;cannot convert float NaN to integer&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dval</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">dval</span> <span class="o">=</span> <span class="o">-</span><span class="n">dval</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">frexp</span><span class="p">(</span><span class="n">dval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expo</span><span class="p">);</span> <span class="cm">/* dval = frac*2**expo; 0.0 &lt;= frac &lt; 1.0 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expo</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mf">0L</span><span class="p">);</span>
    <span class="n">ndig</span> <span class="o">=</span> <span class="p">(</span><span class="n">expo</span><span class="mi">-1</span><span class="p">)</span> <span class="o">/</span> <span class="n">PyLong_SHIFT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Number of &#39;digits&#39; in result */</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">_PyLong_New</span><span class="p">(</span><span class="n">ndig</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">ldexp</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="p">(</span><span class="n">expo</span><span class="mi">-1</span><span class="p">)</span> <span class="o">%</span> <span class="n">PyLong_SHIFT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ndig</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">digit</span> <span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">digit</span><span class="p">)</span><span class="n">frac</span><span class="p">;</span>
        <span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_digit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">-</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">bits</span><span class="p">;</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">ldexp</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="n">PyLong_SHIFT</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span>
        <span class="n">Py_SIZE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">Py_SIZE</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The remainder of the implementation functions in <code>longobject.c</code> have utilities, such as converting a Unicode string into a number with <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/longobject.c#L2672"><code>PyLong_FromUnicodeObject()</code></a>.</p>
</section><section class="section3" id="a-review-of-the-generator-type"><h3>A Review of the Generator Type<a class="headerlink" href="#a-review-of-the-generator-type" title="Permanent link"></a></h3>
<p><a href="https://realpython.com/introduction-to-python-generators/">Python Generators</a> are functions which return a <code>yield</code> statement and can be called continually to generate further values.</p>
<p>Commonly they are used as a more memory efficient way of looping through values in a large block of data, like a file, a database or over a network. </p>
<p>Generator objects are returned in place of a value when <code>yield</code> is used instead of <code>return</code>. The generator object is created from the <code>yield</code> statement and returned to the caller.</p>
<p>Let&rsquo;s create a simple generator with a list of 4 constant values:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
<span class="gp">... </span>  <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="gp">... </span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">yield</span> <span class="n">i</span>
<span class="gp">... </span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span> <span class="o">=</span> <span class="n">example</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span>
<span class="go">&lt;generator object example at 0x100bcc480&gt;</span>
</code></pre></div>
<p>If you explore the contents of the generator object, you can see some of the fields starting with <code>gi_</code>:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">dir</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
<span class="go">[ ...</span>
<span class="go"> &#39;close&#39;, </span>
<span class="go"> &#39;gi_code&#39;, </span>
<span class="go"> &#39;gi_frame&#39;, </span>
<span class="go"> &#39;gi_running&#39;, </span>
<span class="go"> &#39;gi_yieldfrom&#39;, </span>
<span class="go"> &#39;send&#39;, </span>
<span class="go"> &#39;throw&#39;]</span>
</code></pre></div>
<p>The <code>PyGenObject</code> type is defined in <code>Include/genobject.h</code> and there are 3 flavors:</p>
<ol>
<li>Generator objects</li>
<li>Coroutine objects</li>
<li>Async generator objects</li>
</ol>
<p>All 3 share the same subset of fields used in generators, and have similar behaviors:</p>
<figure class="js-lightbox"><a href="https://files.realpython.com/media/generators.536b1404195a.png" target="_blank"><img loading="lazy" class="img-fluid mx-auto d-block " src="https://files.realpython.com/media/generators.536b1404195a.png" width="612" height="264" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/generators.536b1404195a.png&amp;w=153&amp;sig=665718d32fbb9081b7983085eaeb6de7437ed6b6 153w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/generators.536b1404195a.png&amp;w=306&amp;sig=05fff378d8474cff821fbd585c9a57c5c5c51283 306w, https://files.realpython.com/media/generators.536b1404195a.png 612w" sizes="75vw" alt="Structure of generator types" data-asset="1331" /></a></figure>
<p>Focusing first on generators, you can see the fields:</p>
<ul>
<li><code>gi_frame</code> linking to a <code>PyFrameObject</code> for the generator, earlier in the execution chapter, we explored the use of locals and globals inside a frame&rsquo;s value stack. This is how generators remember the last value of local variables since the frame is persistent between calls</li>
<li><code>gi_running</code> set to 0 or 1 if the generator is currently running</li>
<li><code>gi_code</code> linking to a <code>PyCodeObject</code> with the compiled function that yielded the generator so that it can be called again</li>
<li><code>gi_weakreflist</code> linking to a list of weak references to objects inside the generator function</li>
<li><code>gi_name</code> as the name of the generator</li>
<li><code>gi_qualname</code> as the qualified name of the generator</li>
<li><code>gi_exc_state</code> as a tuple of exception data if the generator call raises an exception</li>
</ul>
<p>The coroutine and <a href="https://realpython.com/async-io-python/#other-features-async-for-and-async-generators-comprehensions">async generators</a> have the same fields but prepended with <code>cr</code> and <code>ag</code> respectively.</p>
<p>If you call <code>__next__()</code> on the generator object, the next value is yielded until eventually a <code>StopIteration</code> is raised:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">StopIteration</span>
</code></pre></div>
<p>Each time <code>__next__()</code> is called, the code object inside the generators <code>gi_code</code> field is executed as a new frame and the return value is pushed to the value stack.</p>
<p>You can also see that <code>gi_code</code> is the compiled code object for the generator function by importing the <code>dis</code> module and disassembling the bytecode inside:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span> <span class="o">=</span> <span class="n">example</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dis</span><span class="o">.</span><span class="n">disco</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">gi_code</span><span class="p">)</span>
<span class="go">  2           0 LOAD_CONST               1 (1)</span>
<span class="go">              2 LOAD_CONST               2 (2)</span>
<span class="go">              4 LOAD_CONST               3 (3)</span>
<span class="go">              6 LOAD_CONST               4 (4)</span>
<span class="go">              8 BUILD_LIST               4</span>
<span class="go">             10 STORE_FAST               0 (l)</span>

<span class="go">  3          12 SETUP_LOOP              18 (to 32)</span>
<span class="go">             14 LOAD_FAST                0 (l)</span>
<span class="go">             16 GET_ITER</span>
<span class="go">        &gt;&gt;   18 FOR_ITER                10 (to 30)</span>
<span class="go">             20 STORE_FAST               1 (i)</span>

<span class="go">  4          22 LOAD_FAST                1 (i)</span>
<span class="go">             24 YIELD_VALUE</span>
<span class="go">             26 POP_TOP</span>
<span class="go">             28 JUMP_ABSOLUTE           18</span>
<span class="go">        &gt;&gt;   30 POP_BLOCK</span>
<span class="go">        &gt;&gt;   32 LOAD_CONST               0 (None)</span>
<span class="go">             34 RETURN_VALUE</span>
</code></pre></div>
<p>Whenever <code>__next__()</code> is called on a generator object, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/genobject.c#L541"><code>gen_iternext()</code></a> is called with the generator instance, which immediately calls <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/genobject.c#L153"><code>gen_send_ex()</code></a> inside <code>Objects/genobject.c</code>.</p>
<p><code>gen_send_ex()</code> is the function that converts a generator object into the next yielded result. You&rsquo;ll see many similarities with the way frames are constructed in <code>Python/ceval.c</code> from a code object as these functions have similar tasks.</p>
<p>The <code>gen_send_ex()</code> function is shared with generators, coroutines, and async generators and has the following steps:</p>
<ol>
<li>
<p>The current thread state is fetched</p>
</li>
<li>
<p>The frame object from the generator object is fetched</p>
</li>
<li>
<p>If the generator is running when <code>__next__()</code> was called, raise a <code>ValueError</code></p>
</li>
<li>
<p>If the frame inside the generator is at the top of the stack:</p>
<ul>
<li>In the case of a coroutine, if the coroutine is not already marked as closing, a <code>RuntimeError</code> is raised</li>
<li>If this is an async generator, raise a <code>StopAsyncIteration</code></li>
<li>For a standard generator, a <code>StopIteration</code> is raised.</li>
</ul>
</li>
<li>
<p>If the last instruction in the frame (<code>f-&gt;f_lasti</code>) is still -1 because it has just been started, and this is a coroutine or async generator, then a non-None value can&rsquo;t be passed as an argument, so an exception is raised</p>
</li>
<li>
<p>Else, this is the first time it&rsquo;s being called, and arguments are allowed. The value of the argument is pushed to the frame&rsquo;s value stack</p>
</li>
<li>
<p>The <code>f_back</code> field of the frame is the caller to which return values are sent, so this is set to the current frame in the thread. This means that the return value is sent to the caller, not the creator of the generator</p>
</li>
<li>
<p>The generator is marked as running</p>
</li>
<li>
<p>The last exception in the generator&rsquo;s exception info is copied from the last exception in the thread state</p>
</li>
<li>
<p>The thread state exception info is set to the address of the generator&rsquo;s exception info. This means that if the caller enters a breakpoint around the execution of a generator, the stack trace goes through the generator and the offending code is clear</p>
</li>
<li>
<p>The frame inside the generator is executed within the <code>Python/ceval.c</code> main execution loop, and the value returned</p>
</li>
<li>
<p>The thread state last exception is reset to the value before the frame was called</p>
</li>
<li>
<p>The generator is marked as not running</p>
</li>
<li>
<p>The following cases then match the return value and any exceptions thrown by the call to the generator. Remember that generators should raise a <code>StopIteration</code> when they are exhausted, either manually, or by not yielding a value. Coroutines and async generators should not:</p>
<ul>
<li>If no result was returned from the frame, raise a <code>StopIteration</code> for generators and <code>StopAsyncIteration</code> for async generators</li>
<li>If a <code>StopIteration</code> was explicitly raised, but this is a coroutine or an async generator, raise a <code>RuntimeError</code> as this is not allowed</li>
<li>If a <code>StopAsyncIteration</code> was explicitly raised and this is an async generator, raise a <code>RuntimeError</code>, as this is not allowed</li>
</ul>
</li>
<li>
<p>Lastly, the result is returned back to the caller of <code>__next__()</code></p>
</li>
</ol>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">gen_send_ex</span><span class="p">(</span><span class="n">PyGenObject</span> <span class="o">*</span><span class="n">gen</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">closing</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="n">_PyThreadState_GET</span><span class="p">();</span>       <span class="c1">// 1.</span>
</span><span class="hll">    <span class="n">PyFrameObject</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_frame</span><span class="p">;</span>                   <span class="c1">// 2.</span>
</span>    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>

<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_running</span><span class="p">)</span> <span class="p">{</span>     <span class="c1">// 3.</span>
</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;generator already executing&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyCoro_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;coroutine already executing&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;async generator already executing&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_ValueError</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_stacktop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 4.</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">PyCoro_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">closing</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* `gen` is an exhausted coroutine: raise an error,</span>
<span class="cm">               except when called from gen_close(), which should</span>
<span class="cm">               always be a silent method. */</span>
<span class="hll">            <span class="n">PyErr_SetString</span><span class="p">(</span>
</span><span class="hll">                <span class="n">PyExc_RuntimeError</span><span class="p">,</span>
</span><span class="hll">                <span class="s">&quot;cannot reuse already awaited coroutine&quot;</span><span class="p">);</span> <span class="c1">// 4a.</span>
</span>        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">exc</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* `gen` is an exhausted generator:</span>
<span class="cm">               only set exception if called from send(). */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
<span class="hll">                <span class="n">PyErr_SetNone</span><span class="p">(</span><span class="n">PyExc_StopAsyncIteration</span><span class="p">);</span> <span class="c1">// 4b.</span>
</span>            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
<span class="hll">                <span class="n">PyErr_SetNone</span><span class="p">(</span><span class="n">PyExc_StopIteration</span><span class="p">);</span>      <span class="c1">// 4c.</span>
</span>            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_lasti</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span> <span class="o">!=</span> <span class="n">Py_None</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 5.</span>
</span>            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;can&#39;t send non-None value to a &quot;</span>
                              <span class="s">&quot;just-started generator&quot;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">PyCoro_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">NON_INIT_CORO_MSG</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;can&#39;t send non-None value to a &quot;</span>
                      <span class="s">&quot;just-started async generator&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
<span class="hll">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// 6.</span>
</span>        <span class="cm">/* Push arg onto the frame&#39;s value stack */</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">?</span> <span class="nl">arg</span> <span class="p">:</span> <span class="n">Py_None</span><span class="p">;</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_stacktop</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Generators always return to their most recent caller, not</span>
<span class="cm">     * necessarily their creator. */</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_back</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="hll">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_back</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">;</span>                          <span class="c1">// 7.</span>
</span>
<span class="hll">    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                                <span class="c1">// 8.</span>
</span><span class="hll">    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">previous_item</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">exc_info</span><span class="p">;</span> <span class="c1">// 9.</span>
</span><span class="hll">    <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">exc_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">;</span>              <span class="c1">// 10.</span>
</span><span class="hll">    <span class="n">result</span> <span class="o">=</span> <span class="n">PyEval_EvalFrameEx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">exc</span><span class="p">);</span>                <span class="c1">// 11.</span>
</span><span class="hll">    <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">exc_info</span> <span class="o">=</span> <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">previous_item</span><span class="p">;</span> <span class="c1">// 12.</span>
</span>    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">previous_item</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>             
<span class="hll">    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                <span class="c1">// 13.</span>
</span>
    <span class="cm">/* Don&#39;t keep the reference to f_back any longer than necessary.  It</span>
<span class="cm">     * may keep a chain of frames alive or it could create a reference</span>
<span class="cm">     * cycle. */</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_back</span> <span class="o">==</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">);</span>
    <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_back</span><span class="p">);</span>

    <span class="cm">/* If the generator just returned (as opposed to yielding), signal</span>
<span class="cm">     * that the generator is exhausted. */</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_stacktop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 14a.</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">Py_None</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* Delay exception instantiation if we can */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">PyErr_SetNone</span><span class="p">(</span><span class="n">PyExc_StopAsyncIteration</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">PyErr_SetNone</span><span class="p">(</span><span class="n">PyExc_StopIteration</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* Async generators cannot return anything but None */</span>
            <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">));</span>
            <span class="n">_PyGen_SetStopIterationValue</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="hll">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_ExceptionMatches</span><span class="p">(</span><span class="n">PyExc_StopIteration</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 14b.</span>
</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;generator raised StopIteration&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyCoro_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;coroutine raised StopIteration&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;async generator raised StopIteration&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">_PyErr_FormatFromCause</span><span class="p">(</span><span class="n">PyExc_RuntimeError</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">PyAsyncGen_CheckExact</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<span class="hll">             <span class="n">PyErr_ExceptionMatches</span><span class="p">(</span><span class="n">PyExc_StopAsyncIteration</span><span class="p">))</span>  <span class="c1">// 14c.</span>
</span>    <span class="p">{</span>
        <span class="cm">/* code in `gen` raised a StopAsyncIteration error:</span>
<span class="cm">           raise a RuntimeError.</span>
<span class="cm">        */</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;async generator raised StopAsyncIteration&quot;</span><span class="p">;</span>
        <span class="n">_PyErr_FormatFromCause</span><span class="p">(</span><span class="n">PyExc_RuntimeError</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">...</span>

<span class="hll">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// 15.</span>
</span><span class="p">}</span>
</code></pre></div>
<p>Going back to the evaluation of code objects whenever a function or module is called, there was a special case for generators, coroutines, and async generators in <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L4045"><code>_PyEval_EvalCodeWithName()</code></a>. This function checks for the <code>CO_GENERATOR</code>, <code>CO_COROUTINE</code>, and <code>CO_ASYNC_GENERATOR</code> flags on the code object.</p>
<p>When a new coroutine is created using <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/genobject.c#L1152"><code>PyCoro_New()</code></a>, a new async generator is created with <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/genobject.c#L1428"><code>PyAsyncGen_New()</code></a> or a generator with <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/genobject.c#L811"><code>PyGen_NewWithQualName()</code></a>. These objects are returned early instead of returning an evaluated frame, which is why you get a generator object after calling a function with a yield statement:</p>
<div class="highlight c"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">_PyEval_EvalCodeWithName</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">_co</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span> <span class="p">...</span>
<span class="p">...</span>
    <span class="cm">/* Handle generator/coroutine/asynchronous generator */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CO_GENERATOR</span> <span class="o">|</span> <span class="n">CO_COROUTINE</span> <span class="o">|</span> <span class="n">CO_ASYNC_GENERATOR</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">gen</span><span class="p">;</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">coro_wrapper</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">coroutine_wrapper</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">is_coro</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_COROUTINE</span><span class="p">;</span>
        <span class="p">...</span>
        <span class="cm">/* Create a new generator that owns the ready to run frame</span>
<span class="cm">         * and return that as the value. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_coro</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">PyCoro_New</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_ASYNC_GENERATOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">PyAsyncGen_New</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">PyGen_NewWithQualName</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="p">...</span>
        <span class="k">return</span> <span class="n">gen</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">...</span>
</code></pre></div>
<p>The flags in the code object were injected by the compiler after traversing the AST and seeing the <code>yield</code> or <code>yield from</code> statements or seeing the <code>coroutine</code> decorator.</p>
<p><code>PyGen_NewWithQualName()</code> will call <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Objects/genobject.c#L778"><code>gen_new_with_qualname()</code></a> with the generated frame and then create the <code>PyGenObject</code> with <code>NULL</code> values and the compiled code object:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">gen_new_with_qualname</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyFrameObject</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
                      <span class="n">PyObject</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">qualname</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyGenObject</span> <span class="o">*</span><span class="n">gen</span> <span class="o">=</span> <span class="n">PyObject_GC_New</span><span class="p">(</span><span class="n">PyGenObject</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gen</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_frame</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
    <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">gen</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_code</span><span class="p">);</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_code</span><span class="p">);</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_weakreflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">exc_type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">exc_value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">exc_traceback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_exc_state</span><span class="p">.</span><span class="n">previous_item</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_name</span> <span class="o">=</span> <span class="p">((</span><span class="n">PyCodeObject</span> <span class="o">*</span><span class="p">)</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_code</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">co_name</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">qualname</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_qualname</span> <span class="o">=</span> <span class="n">qualname</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_qualname</span> <span class="o">=</span> <span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_name</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">gi_qualname</span><span class="p">);</span>
    <span class="n">_PyObject_GC_TRACK</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">gen</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Bringing this all together you can see how the generator expression is a powerful syntax where a single keyword, <code>yield</code> triggers a whole flow to create a unique object, copy a compiled code object as a property, set a frame, and store a list of variables in the local scope.</p>
<p>To the user of the generator expression, this all seems like magic, but under the covers it&rsquo;s not <em>that</em> complex.</p>
</section><section class="section3" id="conclusion_4"><h3>Conclusion<a class="headerlink" href="#conclusion_4" title="Permanent link"></a></h3>
<p>Now that you understand how some built-in types, you can explore other types. </p>
<p>When exploring Python classes, it is important to remember there are built-in types, written in C and classes inheriting from those types, written in Python or C.</p>
<p>Some libraries have types written in C instead of inheriting from the built-in types. One example is <code>numpy</code>, a library for numeric arrays. The <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.array.html"><code>nparray</code></a> type is written in C, is highly efficient and performant.</p>
<p>In the next Part, we will explore the classes and functions defined in the standard library.</p>
</section></section><section class="section2" h1="h1" id="part-5-the-cpython-standard-library"><h2>Part 5: The CPython Standard Library<a class="headerlink" href="#part-5-the-cpython-standard-library" title="Permanent link"></a></h2>
<p>Python has always come &ldquo;batteries included.&rdquo; This statement means that with a standard CPython distribution, there are libraries for working with files, threads, networks, web sites, music, keyboards, screens, text, and a whole manner of utilities.</p>
<p>Some of the batteries that come with CPython are more like AA batteries. They&rsquo;re useful for everything, like the <code>collections</code> module and the <code>sys</code> module. Some of them are a bit more obscure, like a small watch battery that you never know when it might come in useful.</p>
<p>There are 2 types of modules in the CPython standard library:</p>
<ol>
<li>Those written in pure Python that provides a utility</li>
<li>Those written in C with Python wrappers</li>
</ol>
<p>We will explore both types.</p>
<section class="section3" id="python-modules"><h3>Python Modules<a class="headerlink" href="#python-modules" title="Permanent link"></a></h3>
<p>The modules written in pure Python are all located in the <code>Lib/</code> directory in the source code. Some of the larger modules have submodules in subfolders, like the <code>email</code> module.</p>
<p>An easy module to look at would be the <code>colorsys</code> module. It&rsquo;s only a few hundred lines of Python code. You may not have come across it before. The <code>colorsys</code> module has some utility functions for converting color scales.</p>
<p>When you install a Python distribution from source, standard library modules are copied from the <code>Lib</code> folder into the distribution folder. This folder is always part of your path when you start Python, so you can <code>import</code> the modules without having to worry about where they&rsquo;re located. </p>
<p>For example:</p>
<div class="highlight python repl"><span class="repl-toggle" title="Toggle REPL prompts and output">&gt;&gt;&gt;</span><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">colorsys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">colorsys</span>
<span class="go">&lt;module &#39;colorsys&#39; from &#39;/usr/shared/lib/python3.7/colorsys.py&#39;&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">colorsys</span><span class="o">.</span><span class="n">rgb_to_hls</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="go">(0.0, 127.5, -1.007905138339921) </span>
</code></pre></div>
<p>We can see the source code of <code>rgb_to_hls()</code> inside <code>Lib/colorsys.py</code>:</p>
<div class="highlight python"><pre><span></span><code><span class="c1"># HLS: Hue, Luminance, Saturation</span>
<span class="c1"># H: position in the spectrum</span>
<span class="c1"># L: color lightness</span>
<span class="c1"># S: color saturation</span>

<span class="k">def</span> <span class="nf">rgb_to_hls</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">maxc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">minc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1"># XXX Can optimize (maxc+minc) and (maxc-minc)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">minc</span><span class="o">+</span><span class="n">maxc</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="k">if</span> <span class="n">minc</span> <span class="o">==</span> <span class="n">maxc</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">minc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxc</span><span class="o">+</span><span class="n">minc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">minc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">-</span><span class="n">maxc</span><span class="o">-</span><span class="n">minc</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">minc</span><span class="p">)</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">g</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">minc</span><span class="p">)</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxc</span><span class="o">-</span><span class="n">minc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">maxc</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-</span><span class="n">gc</span>
    <span class="k">elif</span> <span class="n">g</span> <span class="o">==</span> <span class="n">maxc</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">+</span><span class="n">rc</span><span class="o">-</span><span class="n">bc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">+</span><span class="n">gc</span><span class="o">-</span><span class="n">rc</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span> <span class="o">%</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span>
</code></pre></div>
<p>There&rsquo;s nothing special about this function, it&rsquo;s just standard Python. You&rsquo;ll find similar things with all of the pure Python standard library modules. They&rsquo;re just written in plain Python, well laid out and easy to understand. You may even spot improvements or bugs, so you can make changes to them and <a href="https://realpython.com/start-contributing-python/">contribute it to the Python distribution</a>. We&rsquo;ll cover that toward the end of this article.</p>
</section><section class="section3" id="python-and-c-modules"><h3>Python and C Modules<a class="headerlink" href="#python-and-c-modules" title="Permanent link"></a></h3>
<p>The remainder of modules are written in C, or a combination or Python and C. The source code for these is in <code>Lib/</code> for the Python component, and <code>Modules/</code> for the C component. There are two exceptions to this rule, the <code>sys</code> module, found in <code>Python/sysmodule.c</code> and the <code>__builtins__</code> module, found in <code>Python/bltinmodule.c</code>.</p>
<p>Python will <code>import * from __builtins__</code> when an interpreter is instantiated, so all of the functions like <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/bltinmodule.c#L1821"><code>print()</code></a>, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/bltinmodule.c#L688"><code>chr()</code></a>, <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/bltinmodule.c#L672"><code>format()</code></a>, etc. are found within <code>Python/bltinmodule.c</code>.</p>
<p>Because the <code>sys</code> module is so specific to the interpreter and the internals of CPython, that is found inside the <code>Python</code> directly. It is also marked as an &ldquo;implementation detail&rdquo; of CPython and not found in other distributions.</p>
<p>The built-in <code>print()</code> function was probably the first thing you learned to do in Python. So what happens when you type <code>print("hello world!")</code>?</p>
<ol>
<li>The argument <code>"hello world"</code> was converted from a string constant to a <code>PyUnicodeObject</code> by the compiler</li>
<li><code>builtin_print()</code> was executed with 1 argument, and NULL <code>kwnames</code></li>
<li>The <code>file</code> variable is set to <code>PyId_stdout</code>, the system&rsquo;s <code>stdout</code> handle</li>
<li>Each argument is sent to <code>file</code></li>
<li>A line break, <code>\n</code> is sent to <code>file</code></li>
</ol>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">builtin_print</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">nargs</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">file</span> <span class="o">==</span> <span class="n">Py_None</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="n">file</span> <span class="o">=</span> <span class="n">_PySys_GetObjectId</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyId_stdout</span><span class="p">);</span>
</span>        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="hll">                <span class="n">err</span> <span class="o">=</span> <span class="n">PyFile_WriteString</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span>            <span class="k">else</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">PyFile_WriteObject</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
                                         <span class="n">Py_PRINT_RAW</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">PyFile_WriteObject</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">file</span><span class="p">,</span> <span class="n">Py_PRINT_RAW</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="hll">        <span class="n">err</span> <span class="o">=</span> <span class="n">PyFile_WriteString</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span>    <span class="k">else</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">PyFile_WriteObject</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">Py_PRINT_RAW</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The contents of some modules written in C expose operating system functions. Because the CPython source code needs to compile to macOS, Windows, Linux, and other *nix-based operating systems, there are some special cases.</p>
<p>The <a href="https://realpython.com/python-time-module/"><code>time</code> module</a> is a good example. The way that Windows keeps and stores time in the Operating System is fundamentally different than Linux and macOS. This is one of the reasons why the accuracy of the clock functions differs <a href="https://docs.python.org/3/library/time.html#time.clock_gettime_ns">between operating systems</a>.</p>
<p>In <code>Modules/timemodule.c</code>, the operating system time functions for Unix-based systems are imported from <code>&lt;sys/times.h&gt;</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="cp">#ifdef HAVE_SYS_TIMES_H</span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/times.h&gt;</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="p">...</span>
<span class="cp">#ifdef MS_WINDOWS</span>
<span class="cp">#define WIN32_LEAN_AND_MEAN</span>
<span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;pythread.h&quot;</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* MS_WINDOWS */</span><span class="cp"></span>
<span class="p">...</span>
</code></pre></div>
<p>Later in the file, <code>time_process_time_ns()</code> is defined as a wrapper for <code>_PyTime_GetProcessTimeWithInfo()</code>:</p>
<div class="highlight c"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">time_process_time_ns</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_PyTime_t</span> <span class="n">t</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PyTime_GetProcessTimeWithInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_PyTime_AsNanosecondsObject</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Modules/timemodule.c#L1120"><code>_PyTime_GetProcessTimeWithInfo()</code></a> is implemented multiple different ways in the source code, but only certain parts are compiled into the binary for the module, depending on the operating system. Windows systems will call <code>GetProcessTimes()</code> and Unix systems will call <code>clock_gettime()</code>.</p>
<p>Other modules that have multiple implementations for the same API are <a href="https://realpython.com/intro-to-python-threading/">the threading module</a>, the file system module, and the networking modules. Because the Operating Systems behave differently, the CPython source code implements the same behavior as best as it can and exposes it using a consistent, abstracted API.</p>
</section><section class="section3" id="the-cpython-regression-test-suite"><h3>The CPython Regression Test Suite<a class="headerlink" href="#the-cpython-regression-test-suite" title="Permanent link"></a></h3>
<p>CPython has a robust and extensive test suite covering the core interpreter, the standard library, the tooling and distribution for both Windows and Linux/macOS.</p>
<p>The test suite is located in <code>Lib/test</code> and written almost entirely in Python.</p>
<p>The full test suite is a Python package, so can be run using the Python interpreter that you&rsquo;ve compiled. Change directory to the <code>Lib</code> directory and run <code>python -m test -j2</code>, where <code>j2</code> means to use 2 CPUs.</p>
<p>On Windows use the <code>rt.bat</code> script inside the PCBuild folder, ensuring that you have built the <strong>Release</strong> configuration from Visual Studio in advance:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span><span class="nb">cd</span> PCbuild
<span class="gp">$ </span>rt.bat -q

<span class="go">C:\repos\cpython\PCbuild&gt;&quot;C:\repos\cpython\PCbuild\win32\python.exe&quot;  -u -Wd -E -bb -m test</span>
<span class="go">== CPython 3.8.0b4</span>
<span class="go">== Windows-10-10.0.17134-SP0 little-endian</span>
<span class="go">== cwd: C:\repos\cpython\build\test_python_2784</span>
<span class="go">== CPU count: 2</span>
<span class="go">== encodings: locale=cp1252, FS=utf-8</span>
<span class="go">Run tests sequentially</span>
<span class="go">0:00:00 [  1/420] test_grammar</span>
<span class="go">0:00:00 [  2/420] test_opcodes</span>
<span class="go">0:00:00 [  3/420] test_dict</span>
<span class="go">0:00:00 [  4/420] test_builtin</span>
<span class="go">...</span>
</code></pre></div>
<p>On Linux:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span><span class="nb">cd</span> Lib
<span class="gp">$ </span>../python -m <span class="nb">test</span> -j2   
<span class="go">== CPython 3.8.0b4</span>
<span class="go">== macOS-10.14.3-x86_64-i386-64bit little-endian</span>
<span class="go">== cwd: /Users/anthonyshaw/cpython/build/test_python_23399</span>
<span class="go">== CPU count: 4</span>
<span class="go">== encodings: locale=UTF-8, FS=utf-8</span>
<span class="go">Run tests in parallel using 2 child processes</span>
<span class="go">0:00:00 load avg: 2.14 [  1/420] test_opcodes passed</span>
<span class="go">0:00:00 load avg: 2.14 [  2/420] test_grammar passed</span>
<span class="go">...</span>
</code></pre></div>
<p>On macOS:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span><span class="nb">cd</span> Lib
<span class="gp">$ </span>../python.exe -m <span class="nb">test</span> -j2   
<span class="go">== CPython 3.8.0b4</span>
<span class="go">== macOS-10.14.3-x86_64-i386-64bit little-endian</span>
<span class="go">== cwd: /Users/anthonyshaw/cpython/build/test_python_23399</span>
<span class="go">== CPU count: 4</span>
<span class="go">== encodings: locale=UTF-8, FS=utf-8</span>
<span class="go">Run tests in parallel using 2 child processes</span>
<span class="go">0:00:00 load avg: 2.14 [  1/420] test_opcodes passed</span>
<span class="go">0:00:00 load avg: 2.14 [  2/420] test_grammar passed</span>
<span class="go">...</span>
</code></pre></div>
<p>Some tests require certain flags; otherwise they are skipped. For example, many of the <a href="https://realpython.com/python-idle/">IDLE</a> tests require a GUI.</p>
<p>To see a list of test suites in the configuration, use the <code>--list-tests</code> flag:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>../python.exe -m <span class="nb">test</span> --list-tests

<span class="go">test_grammar</span>
<span class="go">test_opcodes</span>
<span class="go">test_dict</span>
<span class="go">test_builtin</span>
<span class="go">test_exceptions</span>
<span class="go">...</span>
</code></pre></div>
<p>You can run specific tests by providing the test suite as the first argument:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>../python.exe -m <span class="nb">test</span> test_webbrowser

<span class="go">Run tests sequentially</span>
<span class="go">0:00:00 load avg: 2.74 [1/1] test_webbrowser</span>

<span class="go">== Tests result: SUCCESS ==</span>

<span class="go">1 test OK.</span>

<span class="go">Total duration: 117 ms</span>
<span class="go">Tests result: SUCCESS</span>
</code></pre></div>
<p>You can also see a detailed list of tests that were executed with the result using the <code>-v</code> argument:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>../python.exe -m <span class="nb">test</span> test_webbrowser -v

<span class="go">== CPython 3.8.0b4 </span>
<span class="go">== macOS-10.14.3-x86_64-i386-64bit little-endian</span>
<span class="go">== cwd: /Users/anthonyshaw/cpython/build/test_python_24562</span>
<span class="go">== CPU count: 4</span>
<span class="go">== encodings: locale=UTF-8, FS=utf-8</span>
<span class="go">Run tests sequentially</span>
<span class="go">0:00:00 load avg: 2.36 [1/1] test_webbrowser</span>
<span class="go">test_open (test.test_webbrowser.BackgroundBrowserCommandTest) ... ok</span>
<span class="go">test_register (test.test_webbrowser.BrowserRegistrationTest) ... ok</span>
<span class="go">test_register_default (test.test_webbrowser.BrowserRegistrationTest) ... ok</span>
<span class="go">test_register_preferred (test.test_webbrowser.BrowserRegistrationTest) ... ok</span>
<span class="go">test_open (test.test_webbrowser.ChromeCommandTest) ... ok</span>
<span class="go">test_open_new (test.test_webbrowser.ChromeCommandTest) ... ok</span>
<span class="go">...</span>
<span class="go">test_open_with_autoraise_false (test.test_webbrowser.OperaCommandTest) ... ok</span>

<span class="go">----------------------------------------------------------------------</span>

<span class="go">Ran 34 tests in 0.056s</span>

<span class="go">OK (skipped=2)</span>

<span class="go">== Tests result: SUCCESS ==</span>

<span class="go">1 test OK.</span>

<span class="go">Total duration: 134 ms</span>
<span class="go">Tests result: SUCCESS</span>
</code></pre></div>
<p>Understanding how to use the test suite and checking the state of the version you have compiled is very important if you wish to make changes to CPython. Before you start making changes, you should run the whole test suite and make sure everything is passing.</p>
</section><section class="section3" id="installing-a-custom-version"><h3>Installing a Custom Version<a class="headerlink" href="#installing-a-custom-version" title="Permanent link"></a></h3>
<p>From your source repository, if you&rsquo;re happy with your changes and want to use them inside your system, you can install it as a custom version.</p>
<p>For macOS and Linux, you can use the <code>altinstall</code> command, which won&rsquo;t create symlinks for <code>python3</code> and install a standalone version:</p>
<div class="highlight sh"><pre><span></span><code><span class="gp">$ </span>make altinstall
</code></pre></div>
<p>For Windows, you have to change the build configuration from <code>Debug</code> to <code>Release</code>, then copy the packaged binaries to a directory on your computer which is part of the system path.</p>
</section></section><section class="section2" id="the-cpython-source-code-conclusion"><h2>The CPython Source Code: Conclusion<a class="headerlink" href="#the-cpython-source-code-conclusion" title="Permanent link"></a></h2>
<p>Congratulations, you made it! Did your tea get cold? Make yourself another cup. You&rsquo;ve earned it.</p>
<p>Now that you&rsquo;ve seen the CPython source code, the modules, the compiler, and the tooling, you may wish to make some changes and contribute them back to the Python ecosystem.</p>
<p>The <a href="https://devguide.python.org/">official dev guide</a> contains plenty of resources for beginners. You&rsquo;ve already taken the first step, to understand the source, knowing how to change, compile, and test the CPython applications.</p>
<p>Think back to all the things you&rsquo;ve learned about CPython over this article. All the pieces of magic to which you&rsquo;ve learned the secrets. The journey doesn&rsquo;t stop here. </p>
<p>This might be a good time to learn more about Python and C. Who knows: you could be contributing more and more to the CPython project! Also be sure to check out the new <a href="https://realpython.com/products/cpython-internals-book/">CPython Internals book</a> available here on Real Python:</p>
<div class="alert alert-warning" role="alert">
<p><strong markdown="1">Free Download:</strong> <a href="https://realpython.com/bonus/cpython-internals-sample/" class="alert-link" data-toggle="modal" data-target="#modal-cpython-internals-sample" data-focus="false" markdown="1">Get a sample chapter from CPython Internals: Your Guide to the Python 3 Interpreter</a> showing you how to unlock the inner workings of the Python language, compile the Python interpreter from source code, and participate in the development of CPython.</p>
</div>
</section>
<div class="text-center my-3">
<div class="jsCompletionStatusWidget btn-group mb-0">
<button title="Click to mark as completed" class="jsBtnCompletion btn btn-secondary border-right " style="border-top-right-radius: 0; border-bottom-right-radius: 0;" disabled>Mark as Completed</button>
<button title="Add bookmark" class="jsBtnBookmark btn btn-secondary border-left" disabled><i class="fa fa-fw fa-bookmark-o"></i></button>
</div>
</div>
</div>
<div class="card mt-4 mb-4 bg-secondary">
<p class="card-header h3 text-center bg-light">🐍 Python Tricks 💌</p>
<div class="card-body">
<div class="container">
<div class="row">
<div class="col-xs-12 col-sm-7">
<p>Get a short &amp; sweet <strong>Python Trick</strong> delivered to your inbox every couple of days. No spam ever. Unsubscribe any time. Curated by the Real Python team.</p>
</div>
<div class="col-xs-12 col-sm-5">
<img class="img-fluid rounded mb-3" src="https://cdn.realpython.com/static/pytrick-dict-merge.4201a0125a5e.png" width="738" height="490" alt="Python Tricks Dictionary Merge">
</div>
</div>
<div class="row mb-3">
<form class="col-12" action="/optins/process/" method="post">
<input type="hidden" name="csrfmiddlewaretoken" value="3spmRBOLGCWzjGk3L3TBor0gDWhtZkeggt63rtRNOIJfzb4QaRkLdw14O9LG7MZm">
<input type="hidden" name="slug" value="static-python-tricks-footer">
<div class="form-group">
<input name="email" type="email" class="form-control form-control-lg" placeholder="Email Address" required>
</div>
<button name="submit" type="submit" class="btn btn-primary btn-lg btn-block">Send Me Python Tricks »</button>
</form>
</div>
</div>
</div>
</div>
<div class="card mt-3" id="author">
<p class="card-header h3">About <strong>Anthony Shaw</strong></p>
<div class="card-body">
<div class="container p-0">
<div class="row">
<div class="col-12 col-md-3 align-self-center">
<a href="/team/ashaw/"><img loading="lazy" src="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=551&amp;h=551&amp;mode=crop&amp;sig=c05bc24bc6e85059dc301292b3cbd11a77da9a99" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=137&amp;h=137&amp;mode=crop&amp;sig=c4a3dc8d9701357dd90d57ff3edeb72d4fe08fda 137w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=275&amp;h=275&amp;mode=crop&amp;sig=9a0e6868a262e25e0989a983ea9e74ad8a724fbb 275w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=551&amp;h=551&amp;mode=crop&amp;sig=c05bc24bc6e85059dc301292b3cbd11a77da9a99 551w" sizes="25vw" width="551" height="551" class="d-block d-md-none rounded-circle img-fluid w-33 mb-0 mx-auto" alt="Anthony Shaw"></a>
<a href="/team/ashaw/"><img loading="lazy" src="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=551&amp;h=551&amp;mode=crop&amp;sig=c05bc24bc6e85059dc301292b3cbd11a77da9a99" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=137&amp;h=137&amp;mode=crop&amp;sig=c4a3dc8d9701357dd90d57ff3edeb72d4fe08fda 137w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=275&amp;h=275&amp;mode=crop&amp;sig=9a0e6868a262e25e0989a983ea9e74ad8a724fbb 275w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/10995490_10152772557676353_1442757472697890998_n.e88e3d7b17c7.jpg&amp;w=551&amp;h=551&amp;mode=crop&amp;sig=c05bc24bc6e85059dc301292b3cbd11a77da9a99 551w" sizes="25vw" width="551" height="551" class="d-none d-md-block rounded-circle img-fluid w-100 mb-0" alt="Anthony Shaw"></a>
</div>
<div class="col mt-3">
<p>Anthony is an avid Pythonista and writes for Real Python. Anthony is a Fellow of the Python Software Foundation and member of the Open-Source Apache Foundation.</p>
<a href="/team/ashaw/" class="card-link">» More about Anthony</a>
</div>
</div>
</div>
</div>
<hr class="my-0">
<div class="card-body pb-0">
<div class="container">
<div class="row">
<p><em>Each tutorial at Real Python is created by a team of developers so that it meets our high quality standards. The team members who worked on this tutorial are:</em></p>
</div>
<div class="row align-items-center w-100 mx-auto">
<div class="col-4 col-sm-2 align-self-center">
<a href="/team/asantos/"><img loading="lazy" src="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PP.9b8b026f75b8.jpg&amp;w=959&amp;h=959&amp;mode=crop&amp;sig=70bedc2eab90a227eb9a657c415689c3eb1eca4f" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PP.9b8b026f75b8.jpg&amp;w=239&amp;h=239&amp;mode=crop&amp;sig=11667a6dd5c29e4c9363f18be59360551af5eddc 239w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PP.9b8b026f75b8.jpg&amp;w=479&amp;h=479&amp;mode=crop&amp;sig=1541e1ec541357813def826d8507c0565164b701 479w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/PP.9b8b026f75b8.jpg&amp;w=959&amp;h=959&amp;mode=crop&amp;sig=70bedc2eab90a227eb9a657c415689c3eb1eca4f 959w" sizes="10vw" width="551" height="551" class="rounded-circle img-fluid w-100" alt="Aldren Santos"></a>
</div>
<div class="col pl-0 d-none d-sm-block">
<a href="/team/asantos/" class="card-link small"><p>Aldren</p></a>
</div>
<div class="col-4 col-sm-2 align-self-center">
<a href="/team/janderson/"><img loading="lazy" src="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jima.0b8f990b951a.jpg&amp;w=700&amp;h=700&amp;mode=crop&amp;sig=56f5f2e95c106f905736b62a165ec40540bbd5f3" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jima.0b8f990b951a.jpg&amp;w=175&amp;h=175&amp;mode=crop&amp;sig=7a31f392cdb36bdba441a07f51cb4ee9e05b6278 175w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jima.0b8f990b951a.jpg&amp;w=350&amp;h=350&amp;mode=crop&amp;sig=930eb646d5099a859b2324ee0a092fda6cb9c4c5 350w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jima.0b8f990b951a.jpg&amp;w=700&amp;h=700&amp;mode=crop&amp;sig=56f5f2e95c106f905736b62a165ec40540bbd5f3 700w" sizes="10vw" width="551" height="551" class="rounded-circle img-fluid w-100" alt="Jim Anderson"></a>
</div>
<div class="col pl-0 d-none d-sm-block">
<a href="/team/janderson/" class="card-link small"><p>Jim</p></a>
</div>
<div class="col-4 col-sm-2 align-self-center">
<a href="/team/jjablonski/"><img loading="lazy" src="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jjablonksi-avatar.e37c4f83308e.jpg&amp;w=800&amp;h=800&amp;mode=crop&amp;sig=c363b704eeccb35f2247db13baff3d4383459858" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jjablonksi-avatar.e37c4f83308e.jpg&amp;w=200&amp;h=200&amp;mode=crop&amp;sig=706b16de3cb88a8f353f4a98d7c7bc7234229bd0 200w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jjablonksi-avatar.e37c4f83308e.jpg&amp;w=400&amp;h=400&amp;mode=crop&amp;sig=6d7aa672ca3f1ac5f7cd62ed1641b60f98d04d8b 400w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/jjablonksi-avatar.e37c4f83308e.jpg&amp;w=800&amp;h=800&amp;mode=crop&amp;sig=c363b704eeccb35f2247db13baff3d4383459858 800w" sizes="10vw" width="551" height="551" class="rounded-circle img-fluid w-100" alt="Joanna Jablonski"></a>
</div>
<div class="col pl-0 d-none d-sm-block">
<a href="/team/jjablonski/" class="card-link small"><p>Joanna</p></a>
</div>
</div>
</div>
</div>
</div>
<div class="bg-light rounded py-4 my-4 shadow shadow-sm mx-n2">
<div class="col-12 text-center d-block d-md-none">
<p class="h2 mb-3">Master <u><span class="marker-highlight">Real-World Python Skills</mark></u> With Unlimited Access to Real&nbsp;Python</p>
<p class="mb-1"><img class="w-75" src="https://cdn.realpython.com/static/videos/lesson-locked.f5105cfd26db.svg" width="510" height="260"></p>
<p class="mx-auto w-75 mb-3 small"><strong>Join us and get access to hundreds of tutorials, hands-on video courses, and a community of expert&nbsp;Pythonistas:</strong></p>
<p class="mb-0"><a href="/account/join/?utm_source=rp_article_footer&utm_content=cpython-source-code-guide" class="btn btn-primary btn-sm px-4 mb-0">Level Up Your Python Skills »</a>
</div>
<div class="col-12 text-center d-none d-md-block">
<p class="h2 mb-2">Master <u><span class="marker-highlight">Real-World Python Skills</span></u><br>With Unlimited Access to Real&nbsp;Python</p>
<p class="mb-2"><img class="w-50 mb-2" src="https://cdn.realpython.com/static/videos/lesson-locked.f5105cfd26db.svg" width="510" height="260"></p>
<p class="mx-auto w-50 mb-3"><strong>Join us and get access to hundreds of tutorials, hands-on video courses, and a community of expert Pythonistas:</strong></p>
<p><a href="/account/join/?utm_source=rp_article_footer&utm_content=cpython-source-code-guide" class="btn btn-primary btn-lg px-4">Level Up Your Python Skills »</a>
</div>
</div>
<div class="card mt-4" id="reader-comments">
<p class="card-header h3">What Do You Think?</p>
<div class="text-center mt-3 mb-0 p-0">
<span>
<a target="_blank" rel="nofollow" href="https://twitter.com/intent/tweet/?text=Check out this %23Python tutorial: Your%20Guide%20to%20the%20CPython%20Source%20Code by @realpython&url=https%3A//realpython.com/cpython-source-code-guide/" class="mr-1 badge badge-twitter text-light mb-1"><i class="mr-1 fa fa-twitter text-light"></i>Tweet</a>
<a target="_blank" rel="nofollow" href="https://facebook.com/sharer/sharer.php?u=https%3A//realpython.com/cpython-source-code-guide/" class="mr-1 badge badge-facebook text-light mb-1"><i class="mr-1 fa fa-facebook text-light"></i>Share</a>
<a target="_blank" rel="nofollow" href="mailto:?subject=Python article for you&body=Check out this Python tutorial:%0A%0AYour%20Guide%20to%20the%20CPython%20Source%20Code%0A%0Ahttps%3A//realpython.com/cpython-source-code-guide/" class="badge badge-red text-light mb-1"><i class="mr-1 fa fa-envelope text-light"></i>Email</a>
</span>
</div>
<div class="card-body">
<div class="alert alert-dark">
<p class="mb-0"><strong>Real Python Comment Policy:</strong> The most useful comments are those written with the goal of learning from or helping out other readers—after reading the whole article and all the earlier comments. Complaints and insults generally won’t make the cut here.</p>
</div>
<p>What’s your #1 takeaway or favorite thing you learned? How are you going to put your newfound skills to use? Leave a comment below and let us know.</p>
<div class="mb-4" id="disqus_thread">
</div>
</div>
</div>
<div class="card mt-4 mb-4">
<p class="card-header h3">Keep Learning</p>
<div class="card-body">
<p class="mb-0">Related Tutorial Categories:
<a href="/tutorials/advanced/" class="badge badge-light text-muted">advanced</a>
<a href="/tutorials/python/" class="badge badge-light text-muted">python</a>
</p>
</div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="rprw">
<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
<div class="modal-content">
<div class="modal-header border-0 mt-3">
<div class="col-12 modal-title text-center">
<h2 class="my-0 mx-5">Keep reading Real&nbsp;Python by creating a free account or signing&nbsp;in:</h2>
</div>
</div>
<div class="modal-body bg-light">
<div class="col-12 text-center">
<p class="mb-2 mt-3"><a href="/account/signup/?intent=continue_reading&utm_source=rp&utm_medium=web&utm_campaign=rwn&utm_content=v1&next=%2Fcpython-source-code-guide%2F"><img class="w-50 mb-2" src="https://cdn.realpython.com/static/videos/lesson-locked.f5105cfd26db.svg" width="510" height="260" alt="Keep reading"></a></p>
<p><a href="/account/signup/?intent=continue_reading&utm_source=rp&utm_medium=web&utm_campaign=rwn&utm_content=v1&next=%2Fcpython-source-code-guide%2F" class="btn btn-primary btn-lg px-5"></i>Continue »</a></a>
</div>
</div>
<div class="modal-footer border-0">
<p class="text-center text-muted mt-2 mb-1">Already have an account? <a href="/account/login/?next=/cpython-source-code-guide/">Sign-In</a></p>
</div>
</div>
</div>
</div>
<script src="https://cdn.realpython.com/static/frontend/reader/rw.38bf29157dfe.js" async></script>
</div>
<aside class="col-md-7 col-lg-4">
<div class="card mb-3 bg-secondary">
<form class="card-body" action="/optins/process/" method="post">
<div class="form-group">
<p class="h5 text-muted text-center">— FREE Email Series —</p>
<p class="h3 text-center">🐍 Python Tricks 💌</p>
<p><img class="img-fluid rounded" src="https://cdn.realpython.com/static/pytrick-dict-merge.4201a0125a5e.png" width="738" height="490" alt="Python Tricks Dictionary Merge"></p>
</div>
<div class="form-group">
<input type="hidden" name="csrfmiddlewaretoken" value="3spmRBOLGCWzjGk3L3TBor0gDWhtZkeggt63rtRNOIJfzb4QaRkLdw14O9LG7MZm">
<input type="hidden" name="slug" value="static-python-tricks-sidebar">
<input type="email" class="form-control form-control-md" name="email" placeholder="Email&hellip;" required>
</div>
<button type="submit" name="submit" class="btn btn-primary btn-md btn-block">Get Python Tricks »</button>
<p class="mb-0 mt-2 text-muted text-center">🔒 No spam. Unsubscribe any time.</p>
</form>
</div>
<div class="sidebar-module sidebar-module-inset border">
<p class="h4"><a class="link-unstyled" href="/tutorials/all/">All Tutorial Topics</a></p>
<a href="/tutorials/advanced/" class="badge badge-light text-muted">advanced</a>
<a href="/tutorials/api/" class="badge badge-light text-muted">api</a>
<a href="/tutorials/basics/" class="badge badge-light text-muted">basics</a>
<a href="/tutorials/best-practices/" class="badge badge-light text-muted">best-practices</a>
<a href="/tutorials/community/" class="badge badge-light text-muted">community</a>
<a href="/tutorials/databases/" class="badge badge-light text-muted">databases</a>
<a href="/tutorials/data-science/" class="badge badge-light text-muted">data-science</a>
<a href="/tutorials/devops/" class="badge badge-light text-muted">devops</a>
<a href="/tutorials/django/" class="badge badge-light text-muted">django</a>
<a href="/tutorials/docker/" class="badge badge-light text-muted">docker</a>
<a href="/tutorials/flask/" class="badge badge-light text-muted">flask</a>
<a href="/tutorials/front-end/" class="badge badge-light text-muted">front-end</a>
<a href="/tutorials/gamedev/" class="badge badge-light text-muted">gamedev</a>
<a href="/tutorials/gui/" class="badge badge-light text-muted">gui</a>
<a href="/tutorials/intermediate/" class="badge badge-light text-muted">intermediate</a>
<a href="/tutorials/machine-learning/" class="badge badge-light text-muted">machine-learning</a>
<a href="/tutorials/projects/" class="badge badge-light text-muted">projects</a>
<a href="/tutorials/python/" class="badge badge-light text-muted">python</a>
<a href="/tutorials/testing/" class="badge badge-light text-muted">testing</a>
<a href="/tutorials/tools/" class="badge badge-light text-muted">tools</a>
<a href="/tutorials/web-dev/" class="badge badge-light text-muted">web-dev</a>
<a href="/tutorials/web-scraping/" class="badge badge-light text-muted">web-scraping</a>
</div>
<div class="sidebar-module sidebar-module-inset p-0" style="overflow:hidden;">
<div style="display:block;position:relative;">
<div style="display:block;width:100%;padding-top:100%;"></div>
<div class="rpad" data-unit="1x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
</div>
</div>
<div class="sidebar-sticky ">
<div class="bg-light sidebar-module sidebar-module-inset" id="sidebar-toc">
<p class="h4 text-muted"><a class="link-unstyled" href="#toc">Table of Contents</a></p>
<div class="toc">
<ul>
<li><a href="#part-1-introduction-to-cpython">Part 1: Introduction to CPython</a><ul>
<li><a href="#whats-in-the-source-code">What&rsquo;s in the Source Code?</a></li>
<li><a href="#compiling-cpython-macos">Compiling CPython (macOS)</a></li>
<li><a href="#compiling-cpython-linux">Compiling CPython (Linux)</a></li>
<li><a href="#compiling-cpython-windows">Compiling CPython (Windows)</a></li>
<li><a href="#what-does-a-compiler-do">What Does a Compiler Do?</a></li>
<li><a href="#why-is-cpython-written-in-c-and-not-python">Why Is CPython Written in C and Not Python?</a></li>
<li><a href="#the-python-language-specification">The Python Language Specification</a></li>
<li><a href="#memory-management-in-cpython">Memory Management in CPython</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-2-the-python-interpreter-process">Part 2: The Python Interpreter Process</a><ul>
<li><a href="#establishing-runtime-configuration">Establishing Runtime Configuration</a></li>
<li><a href="#reading-filesinput">Reading Files/Input</a></li>
<li><a href="#lexing-and-parsing">Lexing and Parsing</a></li>
<li><a href="#abstract-syntax-trees">Abstract Syntax Trees</a></li>
<li><a href="#conclusion_1">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-3-the-cpython-compiler-and-execution-loop">Part 3: The CPython Compiler and Execution Loop</a><ul>
<li><a href="#compiling">Compiling</a></li>
<li><a href="#execution">Execution</a></li>
<li><a href="#conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-4-objects-in-cpython">Part 4: Objects in CPython</a><ul>
<li><a href="#base-object-type">Base Object Type</a></li>
<li><a href="#the-bool-and-long-integer-type">The Bool and Long Integer Type</a></li>
<li><a href="#a-review-of-the-generator-type">A Review of the Generator Type</a></li>
<li><a href="#conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#part-5-the-cpython-standard-library">Part 5: The CPython Standard Library</a><ul>
<li><a href="#python-modules">Python Modules</a></li>
<li><a href="#python-and-c-modules">Python and C Modules</a></li>
<li><a href="#the-cpython-regression-test-suite">The CPython Regression Test Suite</a></li>
<li><a href="#installing-a-custom-version">Installing a Custom Version</a></li>
</ul>
</li>
<li><a href="#the-cpython-source-code-conclusion">The CPython Source Code: Conclusion</a></li>
</ul>
</div>
</div>
<div class="sidebar-module sidebar-module-inset text-center my-3 py-0">
<div class="jsCompletionStatusWidget btn-group mb-0">
<button title="Click to mark as completed" class="jsBtnCompletion btn btn-secondary border-right " style="border-top-right-radius: 0; border-bottom-right-radius: 0;" disabled>Mark as Completed</button>
<button title="Add bookmark" class="jsBtnBookmark btn btn-secondary border-left" disabled><i class="fa fa-fw fa-bookmark-o"></i></button>
</div>
</div>
<div class="sidebar-module sidebar-module-inset text-center my-3 py-0">
<span>
<a target="_blank" rel="nofollow" href="https://twitter.com/intent/tweet/?text=Check out this %23Python tutorial: Your%20Guide%20to%20the%20CPython%20Source%20Code by @realpython&url=https%3A//realpython.com/cpython-source-code-guide/" class="mr-1 badge badge-twitter text-light mb-1"><i class="mr-1 fa fa-twitter text-light"></i>Tweet</a>
<a target="_blank" rel="nofollow" href="https://facebook.com/sharer/sharer.php?u=https%3A//realpython.com/cpython-source-code-guide/" class="mr-1 badge badge-facebook text-light mb-1"><i class="mr-1 fa fa-facebook text-light"></i>Share</a>
<a target="_blank" rel="nofollow" href="mailto:?subject=Python article for you&body=Check out this Python tutorial:%0A%0AYour%20Guide%20to%20the%20CPython%20Source%20Code%0A%0Ahttps%3A//realpython.com/cpython-source-code-guide/" class="badge badge-red text-light mb-1"><i class="mr-1 fa fa-envelope text-light"></i>Email</a>
</span>
</div>
<div class="sidebar-module sidebar-module-inset p-0" style="overflow:hidden;">
<div style="display:block;position:relative;">
<div style="display:block;width:100%;padding-top:25%;"></div>
<div class="rpad" data-unit="4x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
</div>
</div>
</div>
</aside>
</div>
</div>
<div class="modal fade" id="modal-cpython-internals-sample" tabindex="-1" role="dialog" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
<div class="modal-content">
<div class="modal-header bg-light pt-3 pb-2">
<div class="container-fluid">
<div class="row">
<div class="col-12">
<div class="progress" style="height: .5rem;">
<div class="progress-bar progress-bar-striped progress-bar-animated w-50" role="progressbar"></div>
</div>
</div>
<div class="col-12">
<p class="text-muted text-center mb-0 mt-2">Almost there! Complete this form and click the button below to gain instant access:</p>
</div>
</div>
</div>
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">&times;</span>
</button>
</div>
<div class="modal-body m-4">
<div class="container-fluid">
<div class="row align-items-center">
<div class="col-12 col-lg-4 mb-4">
<img class="img-fluid rounded" src="https://files.realpython.com/media/cpython-book-3d-shadow-trimmed.574c614751c3.png" width="1750" height="1439" srcset="https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/cpython-book-3d-shadow-trimmed.574c614751c3.png&amp;w=437&amp;sig=8bf96e9fbe3b2b64f988f9afa094f18f62915eb8 437w, https://robocrop.realpython.net/?url=https%3A//files.realpython.com/media/cpython-book-3d-shadow-trimmed.574c614751c3.png&amp;w=875&amp;sig=2c1862b8c9c4ae91798e40715910dd09775ad430 875w, https://files.realpython.com/media/cpython-book-3d-shadow-trimmed.574c614751c3.png 1750w" sizes="50vw" alt="CPython Internals: Your Guide to the Python 3 Interpreter">
</div>
<div class="col">
<p class="text-center h3 mb-4">&quot;CPython Internals: Your Guide to the Python 3 Interpreter&quot; – Free Sample Chapter (PDF)</p>
<form class="col-12" action="/optins/process/" method="post">
<input type="hidden" name="csrfmiddlewaretoken" value="3spmRBOLGCWzjGk3L3TBor0gDWhtZkeggt63rtRNOIJfzb4QaRkLdw14O9LG7MZm">
<input type="hidden" name="slug" value="cpython-internals-sample">
<div class="form-group">
<input type="email" name="email" class="form-control" placeholder="Email Address" required autofocus>
</div>
<button name="submit" type="submit" class="btn btn-primary btn-block text-wrap">Send My Sample Chapter »</button>
</form>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer class="footer">
<div class="container">
<div class="w-75 mx-auto mt-4 mb-0">
<div style="display:block;position:relative;">
<div style="display:block;width:100%;padding-top:12.5%;"></div>
<div class="rpad rounded border" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
</div>
<a class="small text-muted" href="/account/join/" rel="nofollow"> <i class="fa fa-info-circle" aria-hidden="true"> </i> Remove ads</a>
</div>
<p class="text-center text-muted w-75 mx-auto">© 2012–2022 Real Python&nbsp;⋅ <a href="/newsletter/">Newsletter</a>&nbsp;⋅ <a href="/podcasts/rpp/">Podcast</a>&nbsp;⋅ <a href="https://www.youtube.com/realpython">YouTube</a>&nbsp;⋅ <a href="https://twitter.com/realpython">Twitter</a>&nbsp;⋅ <a href="https://facebook.com/LearnRealPython">Facebook</a>&nbsp;⋅ <a href="https://www.instagram.com/realpython/">Instagram</a>&nbsp;⋅ <a href="/">Python&nbsp;Tutorials</a>&nbsp;⋅ <a href="/search">Search</a>&nbsp;⋅ <a href="/privacy-policy/">Privacy Policy</a>&nbsp;⋅ <a href="/energy-policy/" class="text-success active">Energy Policy</a>&nbsp;⋅ <a href="/sponsorships/">Advertise</a>&nbsp;⋅ <a href="/contact/">Contact</a><br>❤️ Happy Pythoning!</p>
</div>
</footer>
<script>
      (function(document, history, location) {
        var HISTORY_SUPPORT = !!(history && history.pushState);

        var anchorScrolls = {
          ANCHOR_REGEX: /^#[^ ]+$/,
          OFFSET_HEIGHT_PX: 120,

          /**
           * Establish events, and fix initial scroll position if a hash is provided.
           */
          init: function() {
            this.scrollToCurrent();
            window.addEventListener('hashchange', this.scrollToCurrent.bind(this));
            document.body.addEventListener('click', this.delegateAnchors.bind(this));
          },

          /**
           * Return the offset amount to deduct from the normal scroll position.
           * Modify as appropriate to allow for dynamic calculations
           */
          getFixedOffset: function() {
            return this.OFFSET_HEIGHT_PX;
          },

          /**
           * If the provided href is an anchor which resolves to an element on the
           * page, scroll to it.
           * @param  {String} href
           * @return {Boolean} - Was the href an anchor.
           */
          scrollIfAnchor: function(href, pushToHistory) {
            var match, rect, anchorOffset;

            if(!this.ANCHOR_REGEX.test(href)) {
              return false;
            }

            match = document.getElementById(href.slice(1));

            if(match) {
              rect = match.getBoundingClientRect();
              anchorOffset = window.pageYOffset + rect.top - this.getFixedOffset();
              window.scrollTo(window.pageXOffset, anchorOffset);

              // Add the state to history as-per normal anchor links
              if(HISTORY_SUPPORT && pushToHistory) {
                history.pushState({}, document.title, location.pathname + href);
              }
            }

            return !!match;
          },

          /**
           * Attempt to scroll to the current location's hash.
           */
          scrollToCurrent: function() {
            this.scrollIfAnchor(window.location.hash);
          },

          /**
           * If the click event's target was an anchor, fix the scroll position.
           */
          delegateAnchors: function(e) {
            var elem = e.target;

            // 
            if (elem.dataset.toggle === "tab") {
              return;
            }

            if(
              elem.nodeName === 'A' &&
              this.scrollIfAnchor(elem.getAttribute('href'), true)
            ) {
              e.preventDefault();
            }
          }
        };

        window.addEventListener(
          'DOMContentLoaded', anchorScrolls.init.bind(anchorScrolls)
        );
      })(window.document, window.history, window.location);
    </script>
<script>
      (function() {
        var isAndroid = navigator.userAgent.toLowerCase().indexOf("android") > -1;
        if (!isAndroid) {
          return;
        }

        var styles = `
        @font-face {
          font-family: 'DejaVu Sans Mono';
          font-weight: normal;
          font-style: normal;
          font-display: swap;
          src: url('https://cdn.realpython.com/static/mfonts/dejavu-sans-mono.33f00225f915.woff2') format('woff2'),
               url('https://cdn.realpython.com/static/mfonts/dejavu-sans-mono.0da77d3739f3.woff') format('woff'),
               url('https://cdn.realpython.com/static/mfonts/dejavu-sans-mono.c2356fc49835.ttf') format('truetype');
        }
        code, kbd, pre, samp {
          font-family: 'DejaVu Sans Mono', monospace;
        }
        `

        var styleSheet = document.createElement("style")
        styleSheet.type = "text/css"
        styleSheet.innerText = styles
        document.head.appendChild(styleSheet)
      })();
    </script>
<script src="https://cdn.realpython.com/static/jquery.min.8fb8fee4fcc3.js"></script>
<script src="https://cdn.realpython.com/static/popper.min.1022eaf388cc.js"></script>
<script src="https://cdn.realpython.com/static/bootstrap.min.f0c2bcf5ef0c.js"></script>
<script>
    (function() {
      document.querySelectorAll(".js-search-form-submit").forEach(function(el) {
        el.addEventListener("click", function(e) {
          e.preventDefault();
          e.currentTarget.parentElement.submit();
        })
      });
    })();
    </script>
<script src="https://cdn.realpython.com/static/frontend/reader/repl-toggle.925bef973b9c.js" async></script>
<script src="https://cdn.realpython.com/static/frontend/reader/lightbox.49cdac39212e.js" async></script>
<script src="https://cdn.realpython.com/static/frontend/reader/platforms-ui.b11202dc6079.js" async></script>
<script>window.rp_prop_id = '58946116052';</script>
<script src="https://srv.realpython.net/tag.js" async></script>
<script src="https://cdn.realpython.com/static/frontend/reader/toc-refresh.76a102c7d921.js" async></script>
<script id="js-context" type="application/json">{"is_completed": false, "is_bookmarked": false, "api_article_bookmark_url": "/api/v1/articles/cpython-source-code-guide/bookmark/", "api_article_completion_status_url": "/api/v1/articles/cpython-source-code-guide/completion_status/"}</script>
<script src="https://cdn.realpython.com/static/frontend/reader/completion-status.352d07abd84a.js" async></script>
<script id="dsq-count-scr" src="https://realpython.disqus.com/count.js" async></script>
<script>
      var disqus_config = function () {
        this.page.url = 'https://realpython.com/cpython-source-code-guide/';
        this.page.identifier = 'https://realpython.com/cpython-source-code-guide/';
        this.callbacks.onReady = [function() {
          if (window.onDisqusReady) {
            window.onDisqusReady();
          }
        }];
      };
      var disqus_script_url = 'https://realpython.disqus.com/embed.js';
    </script>
<script src="https://cdn.realpython.com/static/frontend/reader/lazy-disqus.07ee9079f4a3.js" defer></script>
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
<script>
    var OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
      OneSignal.init({
        appId: "c0081e20-a523-42bb-b0ac-04c5a9e8bf40"
      });
    });
  </script>
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Your Guide to the CPython Source Code",
    
    "image": {
      "@type": "ImageObject",
      "url": "https://files.realpython.com/media/A-Tourist-Guide-to-the-CPython-Source-Code_Watermarked.5f05a87331ac.jpg",
      "width": 1920,
      "height": 1080
    },
    
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://realpython.com/cpython-source-code-guide/"
    },
    "datePublished": "2019-08-21T16:10:00+00:00",
    "dateModified": "2021-07-03T01:47:38.589359+00:00",
     "publisher": {
      "@type": "Organization",
      "name": "Real Python",
      "logo": {
        "@type": "ImageObject",
        "url": "https://cdn.realpython.com/static/real-python-logo-square-tiny.b2452b6d3823.png",
        "width": 60,
        "height": 60
      }
    },
    "author": {
      "@type": "Organization",
      "name": "Real Python",
      "url": "https://realpython.com",
      "logo": "https://cdn.realpython.com/static/real-python-logo-square.146e987bf77c.png"
    },
    "description": "In this detailed Python tutorial, you\u0027ll explore the CPython source code. By following this step\u002Dby\u002Dstep walkthrough, you\u0027ll take a deep dive into how the CPython compiler works and how your Python code gets executed."
  }
  </script>
<script>
  var _dcq = _dcq || [];
  var _dcs = _dcs || {};
  _dcs.account = '6214500';

  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true;
    dc.src = '//tag.getdrip.com/6214500.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script>
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2220911568135371');
  fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=2220911568135371&ev=PageView&noscript=1"
/></noscript>
<script type="text/javascript">(function(){window['__CF$cv$params']={r:'7113668fcb64aaac',m:'rweGbLnCN1EOnU_Cl2mq0o6JyfqpfLEumfPXurYuiZo-1653535495-0-ARhggHYBylGjZ/Jn2oU/viKEXeoo2USYHQTBLvF4LXji7JMMj+Zvgsf/YegjH9IPRw4Y6RifZXn34hPYGQ5gI5zZVUPxFTevlnjxCuSx1Nh8UFVilegT54U0FDFP6/LlwG7F+9zQSuAv/Lj/O3HG8so=',s:[0xa0cccf8dc6,0xc2acdf14fb],u:'/cdn-cgi/challenge-platform/h/b'}})();</script></body>
</html>
